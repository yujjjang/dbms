cscope 15 $HOME/Documents/DBMS_2018_2/dbms/proj3 -q 0000000524 0000074538
	@include/bpt.h

1 #iâdeà
__BPT_H__


2 
	#__BPT_H__


	)

5 
š™_db
(
num_buf
);

6 
shutdown_db
();

8 
İ’_bË
(* 
f’ame
, 
num_cŞumn
);

9 
şo£_bË
(
bË_id
);

12 
št64_t
* 
fšd
(
bË_id
, iÁ64_ˆ
key
);

13 
š£¹
(
bË_id
, 
št64_t
 
key
, iÁ64_t* 
v®ue
);

14 
»move
(
bË_id
, 
št64_t
 
key
);

17 
št64_t
* 
fšd
(
bË_id
, iÁ64_ˆ
key
, 
Œx_id
, * 
»suÉ
);

18 
upd©e
(
bË_id
, 
št64_t
 
key
, iÁ64_t* 
v®ue
, 
Œx_id
, * 
»suÉ
);

20 
begš_tx
();

21 
’d_tx
(
Œx_id
);

23 
´št_Œ“
(
bË_id
);

24 
fšd_ªd_´št
(
bË_id
, 
št64_t
 
key
);

25 
liûn£_nÙiû
( );

26 
u§ge_1
( );

27 
u§ge_2
( );

	@include/bpt_internal.h

1 #iâdeà
__BPT_INTERNAL_H__


2 
	#__BPT_INTERNAL_H__


	)

3 
	#V”siÚ
 "1.14"

	)

56 
	~<¡dio.h
>

57 
	~<¡dlib.h
>

58 
	~<¡dboŞ.h
>

59 
	~<¡dšt.h
>

60 
	~<¡ršg.h
>

61 
	~<š‰y³s.h
>

62 
	~<as£¹.h
>

63 
	~<fú.h
>

64 
	~<uni¡d.h
>

66 
	~"ty³s.h
"

67 
	~"·ge.h
"

68 
	~"bË.h
"

69 
	~"fe.h
"

70 
	~"buf.h
"

71 
	~"·nic.h
"

72 
	~"lock.h
"

73 
	~"Œx.h
"

75 #ifdeà
WINDOWS


76 
	#boŞ
 

	)

77 
	#çl£
 0

	)

78 
	#Œue
 1

	)

85 
	#MIN_ORDER
 3

	)

86 
	#MAX_ORDER
 256

	)

88 
	#IS_DELAYED_MERGE


	)

91 
	#LICENSE_FILE
 "LICENSE.txt"

	)

92 
	#LICENSE_WARRANTEE
 0

	)

93 
	#LICENSE_WARRANTEE_START
 592

	)

94 
	#LICENSE_WARRANTEE_END
 624

	)

95 
	#LICENSE_CONDITIONS
 1

	)

96 
	#LICENSE_CONDITIONS_START
 70

	)

97 
	#LICENSE_CONDITIONS_END
 625

	)

100 
Üd”_š‹º®
;

101 
Üd”_Ëaf
;

102 
T¿n§ùiÚMªag”
 
Œx_sys
;

103 
LockMªag”
 
lock_sys
;

104 
BufPoŞ
 
poŞ
;

109 
boŞ
 
fšd_Ëaf
(
TabË
 *
bË
, 
št64_t
 
key
, 
L—fPage
** 
out_Ëaf_node
);

110 
boŞ
 
fšd_Ëaf
(
TabË
 *
bË
, 
št64_t
 
key
, 
L—fPage
** 
out_Ëaf_node
, * 
buf_·ge_i
);

111 
št64_t
 *
fšd_»cÜd
(
TabË
 *
bË
, iÁ64_ˆ
key
);

112 
št64_t
 *
fšd_»cÜd
(
TabË
 *
bË
, iÁ64_ˆ
key
, 
Œx_t
* 
Œx
);

115 
cut
Ğ
Ëngth
 );

118 
upd©e_»cÜd
(
TabË
* 
bË
, 
št64_t
 
key
, iÁ64_t* 
v®ue
, 
Œx_t
* 
Œx
);

121 
¡¬t_Ãw_Œ“
(
TabË
 *
bË
, 
št64_t
 
key
, iÁ64_t* 
v®ue
);

122 
š£¹_što_Ëaf
(
TabË
 *
bË
, 
L—fPage
* 
Ëaf_node
, 
št64_t
 
key
,

123 
št64_t
* 
v®ue
);

124 
š£¹_što_Ëaf_aá”_¥l™tšg
(
TabË
 *
bË
, 
L—fPage
* 
Ëaf_node
,

125 
št64_t
 
key
, iÁ64_t* 
v®ue
);

126 
š£¹_što_·»Á
(
TabË
 *
bË
, 
NodePage
* 
Ëá
, 
št64_t
 
key
,

127 
NodePage
* 
right
);

128 
š£¹_što_Ãw_roÙ
(
TabË
 *
bË
, 
NodePage
* 
Ëá
, 
št64_t
 
key
,

129 
NodePage
* 
right
);

130 
g‘_Ëá_šdex
(
TabË
 *
bË
, 
IÁ”ÇlPage
* 
·»Á
, 
off_t
 
Ëá_off£t
);

131 
š£¹_što_node
(
TabË
 *
bË
, 
IÁ”ÇlPage
 * 
·»Á
, 
Ëá_šdex
,

132 
št64_t
 
key
, 
off_t
 
right_off£t
);

133 
š£¹_što_node_aá”_¥l™tšg
(
TabË
 *
bË
, 
IÁ”ÇlPage
* 
·»Á
,

134 
Ëá_šdex
, 
št64_t
 
key
, 
off_t
 
right_off£t
);

135 
š£¹_»cÜd
(
TabË
 *
bË
, 
št64_t
 
key
, iÁ64_t* 
v®ue
);

138 
g‘_ÃighbÜ_šdex
(
TabË
 *
bË
, 
NodePage
* 
node_·ge
);

139 
adju¡_roÙ
(
TabË
 *
bË
, 
NodePage
* 
roÙ_·ge
);

140 
cßËsû_nodes
(
TabË
 *
bË
, 
NodePage
* 
node_·ge
, NodePage* 
ÃighbÜ_·ge
,

141 
ÃighbÜ_šdex
, 
k_´ime
);

142 
»di¡ribu‹_nodes
(
TabË
 *
bË
, 
NodePage
* 
node_·ge
,

143 
NodePage
* 
ÃighbÜ_·ge
, 
ÃighbÜ_šdex
, 
k_´ime_šdex
,

144 
k_´ime
);

147 
d–‘e_’Œy
(
TabË
 *
bË
, 
NodePage
* 
node_·ge
, 
št64_t
 
key
);

148 
d–‘e_»cÜd
(
TabË
 *
bË
, 
št64_t
 
key
);

	@include/buf.h

1 #iâdeà
__BUF_H__


2 
	#__BUF_H__


	)

3 
	~<mu‹x
>

5 
	~"bË.h
"

6 
	~"·ge.h
"

8 
	s_BufPoŞ
 {

9 
Page
* 
	m·ges
;

11 
	m¡d
::
mu‹x
 
buf_poŞ_mu‹x
;

14 
	m¡d
::
mu‹x
* 
buf_·ge_mu‹x
;

16 
Page
* 
	mÌu_h—d
;

17 
Page
* 
	mÌu_
;

18 
	mnum_buf
;

19 
	mtÙ_pšút
;

20 } 
	tBufPoŞ
;

22 
š™_Ãw_h—d”_·ge
(
H—d”Page
 *
h—d”_·ge
, 
bË_id
, 
num_cŞumn
);

24 
lßd_h—d”_·ge
(
TabË
 *
bË
);

26 
Page
* 
®loc_·ge
(
TabË
 *
bË
);

28 
Page
* 
g‘_·ge
(
TabË
 *
bË
, 
·g’um_t
 
·g’um
);

30 
Page
* 
g‘_·ge
(
TabË
 *
bË
, 
·g’um_t
 
·g’um
, * 
buf_·ge_i
);

32 
»Ëa£_h—d”_·ge
(
TabË
 *
bË
);

34 
»Ëa£_·ge
(
Page
* 
·ge
);

36 
»Ëa£_·ge
(
Page
* 
·ge
, * 
buf_·ge_i
);

38 
£t_dœty_·ge
(
Page
* 
·ge
);

40 
ä“_·ge
(
TabË
 *
bË
, 
Page
* 
·ge
);

42 
æush_bË
(
TabË
 *
bË
);

44 
š™_buf_poŞ
(
num_buf
);

46 
de¡roy_buf_poŞ
();

48 
´št_buf_poŞ
();

50 
	#BUF_PAGE_MUTEX_FAIL
 -930209

	)

52 
	#BUF_POOL_MUTEX_ENTER
 \

53 
poŞ
.
buf_poŞ_mu‹x
.
	`lock
();

	)

55 
	#BUF_POOL_MUTEX_EXIT
 \

56 
poŞ
.
buf_poŞ_mu‹x
.
	`uÆock
();

	)

58 
	#BUF_PAGE_MUTEX_ENTER
(
i
)\

59 
boŞ
 
»t
 = 
poŞ
.
buf_·ge_mu‹x
[
i
].
	`Œy_lock
();

	)

	@include/deadlock.h

1 #iâdeà
__DEADLOCK__H__


2 
	#__DEADLOCK__H__


	)

4 
	~<unÜd”ed_m­
>

5 
	~<veùÜ
>

6 
	~<¡ack
>

7 
	~<®gÜ™hm
>

8 
	~<şim™s
>

9 
	~<·nic.h
>

15 şas 
	cDLCheck”
 {

16 
	srjª_t
 {

17 
rjª_t
(){};

18 
rjª_t
(
¡d
::
veùÜ
<> 
wa™_fÜ
è: 
wa™šg_Œx_id
(wa™_fÜ), 
fšished
(
çl£
), 
dfs_Üd”
(-1) {};

19 
	m¡d
::
veùÜ
<> 
wa™šg_Œx_id
;

20 
boŞ
 
	mfšished
;

21 
	mdfs_Üd”
;

24 
	g´iv©e
:

25 
¡d
::
¡ack
<
rjª_t
*> 
s_rjª
;

26 
	gdfs_Üd”
;

27 
boŞ
 
	gcyşe_æag
;

28 
	gÏ‹¡_Œx_id
;

30 
dfs_rjª
(
rjª_t
* 
¡
);

31 
š™Ÿlize_rjª_acyşic
();

32 
š™Ÿlize_rjª_cyşic
();

34 
	g¡d
::
unÜd”ed_m­
<, 
	grjª_t
> 
	gdl_g¿ph
;

35 
boŞ
 
is_cyşic
();

37 
	gpublic
:

38 
	$DLCheck”
(): 
	`dfs_Üd”
(-1), 
	`cyşe_æag
(
çl£
), 
	$Ï‹¡_Œx_id
(0è{
	}
};

39 ~
	$DLCheck”
(){
	}
};

41 
boŞ
 
d—dlock_checkšg
(
Œx_id
, 
¡d
::
veùÜ
<> 
wa™_fÜ
);

42 
d–‘e_wa™šg_fÜ_Œx
(
Œx_id
);

44 
g‘_wa™_lock_Œx_id
(
Œx_id
);

47 
	#NO_WAIT_LOCK
 -930209

	)

	@include/file.h

1 #iâdeà
__FILE_H__


2 
	#__FILE_H__


	)

3 
	~"bË.h
"

4 
	~"·ge.h
"

7 
ex·nd_fe
(
TabË
 *
bË
, 
size_t
 
út_·ge_to_ex·nd
);

10 
fe_»ad_·ge
(
TabË
 *
bË
, 
·g’um_t
 
·g’um
, * 
·ge
);

13 
fe_wr™e_·ge
(
TabË
 *
bË
, 
·g’um_t
 
·g’um
, * 
·ge
);

	@include/lock.h

1 #iâdeà
__LOCK_HPP__


2 
	#__LOCK_HPP__


	)

4 
	~<unÜd”ed_m­
>

5 
	~<li¡
>

6 
	~<mu‹x
>

7 
	~<cÚd™iÚ_v¬ŸbË
>

8 
	~<veùÜ
>

9 
	~<unÜd”ed_£t
>

11 
	~"·ge.h
"

12 
	~"bË.h
"

13 
	~"Œx.h
"

14 
	~"ty³s.h
"

15 
	~"·nic.h
"

16 
	~"d—dlock.h
"

17 
	~"buf.h
"

19 
T¿n§ùiÚMªag”
 
Œx_sys
;

20 
BufPoŞ
 
poŞ
;

25 
	slock_t
 {

26 
lock_t
(
bË_id
, 
Œx_t
* 
Œx
, 
·g’um_t
 
·ge_id
, 
št64_t
 
key
, 
LockMode
 
lock_mode
) :

27 
bË_id
ÑabË_id), 
Œx
Ñrx), 
·ge_id
Õage_id), 
key
(key), 
lock_mode
Öock_mode), 
´ev
(
nuÎ±r
), 
Ãxt
(nullptr) {};

28 
	mbË_id
;

29 
Œx_t
* 
	mŒx
;

30 
·g’um_t
 
	m·ge_id
;

31 
št64_t
 
	mkey
;

32 
boŞ
 
	macquœed
;

33 
LockMode
 
	mlock_mode
;

35 
lock_t
* 
	m´ev
;

36 
lock_t
* 
	mÃxt
;

39 şas 
	cLockMªag”
 {

41 
	slock_·ge_t
 {

42 
	m¡d
::
li¡
<
lock_t
> 
lock_li¡
;

45 
	g´iv©e
:

47 cÚ¡ 
boŞ
 
lock_com·tib™y_m©rix
[2][2] = {{
Œue
, 
çl£
}, {false, false}};

48 cÚ¡ 
boŞ
 
	glock_¡»ngth_m©rix
[2][2] = {{
Œue
, 
çl£
}, {true,rue}};

50 
DLCheck”
 
	gdl_check”
;

51 
	g¡d
::
mu‹x
 
lock_sys_mu‹x
;

54 
	g¡d
::
unÜd”ed_m­
<
·g’um_t
, 
	glock_·ge_t
> 
	glock_bË
;

56 
boŞ
 
lock_»c_has_lock
(
Œx_t
*, , 
·g’um_t
, 
št64_t
, 
LockMode
, 
lock_t
**);

57 
boŞ
 
lock_»c_has_cÚæiù
(
Œx_t
*, , 
·g’um_t
, 
št64_t
, 
LockMode
, 
lock_t
*,†ock_t**);

59 
lock_g¿Áed_»c_add_to_queue
(
Œx_t
*, , 
·g’um_t
, 
št64_t
, 
LockMode
, 
lock_t
*);

60 
lock_wa™_»c_add_to_queue
(
Œx_t
*, , 
·g’um_t
, 
št64_t
, 
LockMode
, 
lock_t
*,†ock_t*);

62 
lock_t
* 
lock_»c_ü—‹
(
Œx_t
*, , 
·g’um_t
, 
št64_t
, 
LockMode
,†ock_t*);

64 
	g¡d
::
veùÜ
<> 
lock_wa™_fÜ
(
Œx_t
*, 
lock_t
*,†ock_t*, 
LockMode
);

66 
rŞlback_d©a
(
Œx_t
*);

68 
lock_g¿Á
(
lock_t
*);

69 
boŞ
 
¡l_lock_wa™
(
lock_t
*);

71 cÚ¡ 
boŞ
 
lock_mode_com·tibË
(
LockMode
, LockMode);

72 cÚ¡ 
boŞ
 
lock_mode_¡rÚg”_Ü_eq
(
LockMode
, LockMode);

74 
»Ëa£_lock_abÜ‹d_low
(
Œx_t
*, 
lock_t
*);

75 
boŞ
 
»Ëa£_lock_abÜ‹d
(
Œx_t
*);

76 
»Ëa£_lock_low
(
Œx_t
*, 
lock_t
*);

78 
	gpublic
:

80 
	$LockMªag”
(è: 
	$dl_check”
(è{
	}
};

81 ~
	$LockMªag”
(){
	}
};

83 
acquœe_lock
(
Œx_t
*, 
bË_id
, 
·g’um_t
, 
št64_t
 
key
, 
LockMode
 
lock_mode
);

84 
boŞ
 
»Ëa£_lock
(
Œx_t
*);

88 
	#LOCK_SYS_MUTEX_ENTER
 \

89 
¡d
::
unique_lock
<¡d::
mu‹x
> 
	`l_mu‹x
(
lock_sys_mu‹x
);

	)

	@include/page.h

1 #iâdeà
__PAGE_H__


2 
	#__PAGE_H__


	)

3 
	~<¡ddef.h
>

4 
	~<¡dboŞ.h
>

5 
	~<š‰y³s.h
>

7 
	#BPTREE_INTERNAL_ORDER
 249

	)

8 
	#BPTREE_LEAF_ORDER
 32

	)

10 
	#PAGE_SIZE
 4096

	)

12 
	#SIZE_KEY
 8

	)

13 
	#SIZE_COLUMN
 15

	)

14 
	#SIZE_VALUE
 120

	)

15 
	#SIZE_RECORD
 (
SIZE_KEY
 + 
SIZE_VALUE
)

	)

17 
	#BPTREE_MAX_NODE
 (1024 * 1024)

18 

	)

19 
ušt64_t
 
	t·g’um_t
;

20 
	#PAGENUM_TO_FILEOFF
(
pgnum
è(Õgnumè* 
PAGE_SIZE
)

	)

21 
	#FILEOFF_TO_PAGENUM
(
off
è((
·g’um_t
)((offè/ 
PAGE_SIZE
))

	)

33 
	s_RecÜd
 {

34 
št64_t
 
	mkey
;

35 
št64_t
 
	mv®ue
[
SIZE_COLUMN
];

36 } 
	tRecÜd
;

38 
	s_IÁ”ÇlRecÜd
 {

39 
št64_t
 
	mkey
;

40 
off_t
 
	moff£t
;

41 } 
	tIÁ”ÇlRecÜd
;

43 
	#INMEM_PAGE
 \

44 
bË_id
; \

45 
·g’um_t
 
·g’um
; \

46 
boŞ
 
is_dœty
; \

47 
pšút
; \

48 
_Page
* 
Ìu_Ãxt
; \

49 
_Page
* 
Ìu_´ev


	)

51 
	s_Page
 {

52 
	mby‹s
[
PAGE_SIZE
];

55 
	mINMEM_PAGE
;

56 } 
	tPage
;

58 
	s_F»ePage
 {

59 
off_t
 
	mÃxt
;

60 
	m»£rved
[
PAGE_SIZE
 - 8];

63 
	mINMEM_PAGE
;

64 } 
	tF»ePage
;

66 
	s_H—d”Page
 {

67 
off_t
 
	mä“li¡
;

68 
off_t
 
	mroÙ_off£t
;

69 
ušt64_t
 
	mnum_·ges
;

70 
off_t
 
	mnum_cŞumn
;

71 
	m»£rved
[
PAGE_SIZE
 - 32];

74 
	mINMEM_PAGE
;

75 } 
	tH—d”Page
;

77 
	#INTERNAL_KEY
(
n
, 
i
è(Ò)->
œecÜds
[(i)+1].
key
)

	)

78 
	#INTERNAL_OFFSET
(
n
, 
i
è(Ò)->
œecÜds
[(i)].
off£t
)

	)

79 
	s_IÁ”ÇlPage
 {

82 
off_t
 
	m·»Á
;

83 
	mis_Ëaf
;

84 
	mnum_keys
;

85 
	m»£rved
[112 - 16];

86 
IÁ”ÇlRecÜd
 
	mœecÜds
[
BPTREE_INTERNAL_ORDER
];

88 
	m¥aû
[
PAGE_SIZE
];

91 
	mINMEM_PAGE
;

92 } 
	tIÁ”ÇlPage
;

94 
	#LEAF_KEY
(
n
, 
i
è(Ò)->
»cÜds
[(i)].
key
)

	)

95 
	#LEAF_VALUE
(
n
, 
i
è(Ò)->
»cÜds
[(i)].
v®ue
)

	)

96 
	s_L—fPage
 {

99 
off_t
 
	m·»Á
;

100 
	mis_Ëaf
;

101 
	mnum_keys
;

102 
	m»£rved
[120 - 16];

103 
off_t
 
	msiblšg
;

104 
RecÜd
 
	m»cÜds
[
BPTREE_LEAF_ORDER
-1];

106 
	m¥aû
[
PAGE_SIZE
];

110 
	mINMEM_PAGE
;

111 } 
	tL—fPage
;

113 
	s_NodePage
 {

116 
off_t
 
	m·»Á
;

117 
	mis_Ëaf
;

118 
	mnum_keys
;

120 
	m¥aû
[
PAGE_SIZE
];

124 
	mINMEM_PAGE
;

125 } 
	tNodePage
;

	@include/panic.h

1 #iâdeà
__PANIC_H__


2 
	#__PANIC_H__


	)

3 
	~<¡dio.h
>

5 
	#PANIC
(
msg
,...) do{\

6 
	`årštf
(
¡d”r
, "PANIC: [%s:%d iÀ%s] " 
msg
 "\n", \

7 
__FILE__
, 
__LINE__
, 
__func__
 , ##
__VA_ARGS__
); \

8 
	`ex™
(
EXIT_FAILURE
); \

9 }0)

	)

	@include/table.h

1 #iâdeà
__TABLE_H__


2 
	#__TABLE_H__


	)

4 
	~"·ge.h
"

6 
	s_TabË
 {

7 
H—d”Page
 
	mdbh—d”
;

8 
	mdbfe
;

9 
	mbË_id
;

11 } 
	tTabË
;

13 
	#MAX_NUM_TABLE
 10

	)

16 
İ’_Ü_ü—‹_bË_fe
(cÚ¡ * 
f’ame
, 
num_cŞumn
);

18 
şo£_bË_fe
(
TabË
 *
bË
);

21 
TabË
 *
g‘_bË
(
bË_id
);

	@include/trx.h

2 #iâdeà
__TRX_HPP__


3 
	#__TRX_HPP__


	)

5 
	~<li¡
>

6 
	~<unÜd”ed_m­
>

7 
	~<©omic
>

8 
	~<mu‹x
>

9 
	~<cÚd™iÚ_v¬ŸbË
>

10 
	~"ty³s.h
"

12 
	~<uni¡d.h
>

14 
şass
 
	gLockMªag”
;

15 
	glock_t
;

17 
	sundo_log
 {

18 
undo_log
(
bË_id
, 
ušt64_t
 
·ge_id
, 
št64_t
 
key
, iÁ64_t* 
Şd_v®ue
) :able_id(table_id),…age_id(page_id), key(key) {

19 
memıy
(
undo_v®ue
, 
Şd_v®ue
, 120);

21 
	mbË_id
;

22 
ušt64_t
 
	m·ge_id
;

23 
št64_t
 
	mkey
;

24 
št64_t
 
	mundo_v®ue
[15];

27 şas 
	cŒx_t
 {

29 
	m´iv©e
:

30 
Œx_id
;

31 
	m¡d
::
li¡
<
lock_t
*> 
acquœed_lock
;

33 
	m¡d
::
mu‹x
 
Œx_mu‹x
;

34 
	m¡d
::
cÚd™iÚ_v¬ŸbË_ªy
 
Œx_t_cv
;

36 
	m¡d
::
li¡
<
undo_log
> 
undo_log_li¡
;

38 
S‹
 
	m¡©e
;

39 
LockS‹
 
	mlock_¡©e
;

40 
lock_t
* 
	mwa™_lock
;

42 
	mpublic
:

43 
	$Œx_t
(
Œx_id_t
 
t_id
è: 
	`Œx_id
Ñ_idè, 
	$¡©e
(
RUNNING
) {};

44 ~
	$Œx_t
(){ 
acquœed_lock
.
	`ş—r
(); 
undo_log_li¡
.ş—r(); 
	}
}

47 
	$push_undo_log
(
bË_id
, 
ušt64_t
 
·ge_id
, 
št64_t
 
key
, iÁ64_t* 
Şd_v®ue
) {

48 
undo_log
 
	`log
(
bË_id
, 
·ge_id
, 
key
, 
Şd_v®ue
); 
undo_log_li¡
.
	`push_back
(
log
); 
	}
}

49 
undo_log
 
	$pİ_undo_log
(è{ 
undo_log
 
log
 = 
undo_log_li¡
.
	`back
(); undo_log_li¡.
	`pİ_back
(); †og; 
	}
}

52 
	$push_acquœed_lock
(
lock_t
* 
lock
è{ 
acquœed_lock
.
	`push_back
Öock); 
	}
}

53 
	$£tS‹
(
S‹
 
¡©e
è{ 
this
 -> s‹ = s‹; 
	}
}

56 
	$Œx_mu‹x_’‹r
(è{ 
Œx_mu‹x
.
	`lock
(); 
	}
}

57 
	$Œx_mu‹x_ex™
(è{ 
Œx_mu‹x
.
	`uÆock
(); 
	}
}

58 
	$Œx_wa™_lock
(è{ 
Œx_t_cv
.
	`wa™
(
Œx_mu‹x
);rx_mu‹x.
	`uÆock
(); 
	}
}

59 
	$Œx_wa™_»Ëa£
(è{ 
Œx_t_cv
.
	`nÙify_®l
();
	}
}

62 
undo_upd©e
();

64 
	$£t_wa™_lock
(
lock_t
* 
wa™_lock
è{ 
this
->wa™_lock = wa™_lock; 
	}
}

65 
lock_t
* 
	$g‘_wa™_lock
(è{  
wa™_lock
; 
	}
}

67 cÚ¡ 
	g¡d
::
li¡
<
lock_t
*> 
	$g‘AcquœedLock
 (ècÚ¡ {  
acquœed_lock
; 
	}
}

68 cÚ¡ 
S‹
 
	$g‘S‹
(ècÚ¡ {  
¡©e
; 
	}
}

69 cÚ¡ 
Œx_id_t
 
	$g‘T¿n§ùiÚId
 (ècÚ¡ {  
Œx_id
; 
	}
}

70 cÚ¡ 
	g¡d
::
li¡
<
undo_log
> 
	$g‘_undo_log_li¡
(ècÚ¡ {  
undo_log_li¡
; 
	}
}

74 şas 
	cT¿n§ùiÚMªag”
 {

76 
	m´iv©e
:

77 
¡d
::
unÜd”ed_m­
<
Œx_id_t
, 
	mŒx_t
*> 
	maùive_Œx
;

78 
	m¡d
::
©omic
<> 
Œx_id
;

80 
	mpublic
:

81 
	$T¿n§ùiÚMªag”
():
	$Œx_id
(0) {};

83 ~
	`T¿n§ùiÚMªag”
();

85 
Œx_t
* 
	`makeNewT¿n§ùiÚ
();

86 
boŞ
 
	`d–‘eT¿n§ùiÚ
(
Œx_id_t
);

88 
¡d
::
unÜd”ed_m­
<
Œx_id_t
, 
Œx_t
*> 
	$g‘AùiveTrx
(ècÚ¡ {  
aùive_Œx
; 
	}
}

89 
Œx_t
* 
g‘T¿n§ùiÚ
(
Œx_id_t
 
Œx_id
);

	@include/types.h

1 #iâdeà
__TYPES_H__


2 
	#__TYPES_H__


	)

4 
	#NONE
 0

	)

5 
	#RUNNING
 1

	)

6 
	#ABORTED
 2

	)

8 
	#LOCK_S
 0

	)

9 
	#LOCK_X
 1

	)

11 
	#LOCK_SUCCESS
 0

	)

12 
	#LOCK_WAIT
 1

	)

13 
	#DEADLOCK
 2

	)

15 
	tŒx_id_t
;

16 
	tS‹
;

17 
	tLockS‹
;

18 
	tLockMode
;

	@src/bpt_ext.cpp

1 
	~"b±_š‹º®.h
"

4 
	$š™_db
(
num_buf
) {

5  
	`š™_buf_poŞ
(
num_buf
);

6 
	}
}

8 
	$shutdown_db
() {

9  
	`de¡roy_buf_poŞ
();

10 
	}
}

13 
	$İ’_bË
(* 
f’ame
, 
num_cŞumn
) {

14  
	`İ’_Ü_ü—‹_bË_fe
(
f’ame
, 
num_cŞumn
);

15 
	}
}

18 
	$şo£_bË
(
bË_id
) {

19 
TabË
* 
bË
 = 
	`g‘_bË
(
bË_id
);

20 
	`æush_bË
(
bË
);

21  
	`şo£_bË_fe
(
bË
);

22 
	}
}

28 
	$š£¹
(
bË_id
, 
št64_t
 
key
, iÁ64_t* 
v®ue
) {

29 
TabË
* 
bË
 = 
	`g‘_bË
(
bË_id
);

30  
	`š£¹_»cÜd
(
bË
, 
key
, 
v®ue
);

31 
	}
}

35 
	$»move
(
bË_id
, 
št64_t
 
key
) {

36 
TabË
* 
bË
 = 
	`g‘_bË
(
bË_id
);

37  
	`d–‘e_»cÜd
(
bË
, 
key
);

38 
	}
}

42 
št64_t
* 
	$fšd
(
bË_id
, 
št64_t
 
key
) {

43 
TabË
* 
bË
 = 
	`g‘_bË
(
bË_id
);

45  
	`fšd_»cÜd
(
bË
, 
key
);

46 
	}
}

48 
št64_t
* 
	$fšd
(
bË_id
, 
št64_t
 
key
, 
Œx_id
, * 
»suÉ
) {

49 
TabË
* 
bË
 = 
	`g‘_bË
(
bË_id
);

50 
T¿n§ùiÚMªag”
* 
tm
 = &
Œx_sys
;

51 
Œx_t
* 
Œx
 = 
tm
 -> 
	`g‘T¿n§ùiÚ
(
Œx_id
);

53 ià(
Œx
 -> 
	`g‘S‹
(è=ğ
ABORTED
) {

54 *
»suÉ
 = 0;

55  
nuÎ±r
;

58 
št64_t
* 
»t
 = 
	`fšd_»cÜd
(
bË
, 
key
, 
Œx
);

60 ià(
Œx
 -> 
	`g‘S‹
(è=ğ
ABORTED
) {

61 *
»suÉ
 = 0;

62  
nuÎ±r
;

65 *
»suÉ
 = 1;

66  
»t
;

67 
	}
}

71 
	$upd©e
(
bË_id
, 
št64_t
 
key
, iÁ64_t* 
v®ue
, 
Œx_id
, * 
»suÉ
) {

72 
TabË
* 
bË
 = 
	`g‘_bË
(
bË_id
);

73 
T¿n§ùiÚMªag”
* 
tm
 = &
Œx_sys
;

75 
Œx_t
* 
Œx
 = 
tm
 -> 
	`g‘T¿n§ùiÚ
(
Œx_id
);

77 ià(
Œx
 -> 
	`g‘S‹
(è=ğ
ABORTED
) {

78 *
»suÉ
 = 0;

82 
»t
 = 
	`upd©e_»cÜd
(
bË
, 
key
, 
v®ue
, 
Œx
);

84 ià(
Œx
 -> 
	`g‘S‹
(è=ğ
ABORTED
) {

85 *
»suÉ
 = 0;

89 *
»suÉ
 = 1;

90  
»t
;

91 
	}
}

97 
	$begš_tx
() {

98 
T¿n§ùiÚMªag”
* 
tm
 = &
Œx_sys
;

99 
Œx_t
* 
Ãw_t
 = 
tm
 -> 
	`makeNewT¿n§ùiÚ
();

100  
Ãw_t
 -> 
	`g‘T¿n§ùiÚId
();

101 
	}
}

109 
	$’d_tx
(
Œx_id
) {

110 
T¿n§ùiÚMªag”
* 
tm
 = &
Œx_sys
;

111 
LockMªag”
* 
lm
 = &
lock_sys
;

113 
Œx_t
* 
’d_t
 = 
tm
 -> 
	`g‘T¿n§ùiÚ
(
Œx_id
);

114 
boŞ
 
»t
;

115 ià(
’d_t
 -> 
	`g‘S‹
(è=ğ
ABORTED
) {

116 
»t
 = 
tm
 -> 
	`d–‘eT¿n§ùiÚ
(
Œx_id
);

119 
’d_t
 -> 
	`£tS‹
(
NONE
);

120 
»t
 = 
lm
->
	`»Ëa£_lock
(
’d_t
è& 
tm
->
	`d–‘eT¿n§ùiÚ
(
Œx_id
);

123 ià(!
»t
)

124 
	`PANIC
("end_tx.\n");

127 
	}
}

138 
	$´št_Œ“
(
bË_id
) {

139 
off_t
* 
queue
;

140 
i
;

141 
äÚt
 = 0;

142 
»¬
 = 0;

144 
TabË
* 
bË
 = 
	`g‘_bË
(
bË_id
);

146 
	`´št_buf_poŞ
();

147 ià(
bË
->
dbh—d”
.
roÙ_off£t
 == 0) {

148 
	`´štf
("Emptyree.\n");

151 
queue
 = (
off_t
*)
	`m®loc
((off_tè* 
BPTREE_MAX_NODE
);

153 
queue
[
»¬
] = 
bË
->
dbh—d”
.
roÙ_off£t
;

154 
»¬
++;

155 
queue
[
»¬
] = 0;

156 
»¬
++;

157 
äÚt
 < 
»¬
) {

158 
off_t
 
·ge_off£t
 = 
queue
[
äÚt
];

159 
äÚt
++;

161 ià(
·ge_off£t
 == 0) {

162 
	`´štf
("\n");

164 ià(
äÚt
 =ğ
»¬
) ;

167 
queue
[
»¬
] = 0;

168 
»¬
++;

172 
NodePage
* 
node_·ge
;

173 
node_·ge
 = (
NodePage
*)
	`g‘_·ge
(
bË
, 
	`FILEOFF_TO_PAGENUM
(
·ge_off£t
));

174 ià(
node_·ge
->
is_Ëaf
 == 1) {

176 
L—fPage
* 
Ëaf_node
 = (L—fPage*)
node_·ge
;

177 
i
 = 0; i < 
Ëaf_node
->
num_keys
; i++) {

178 
	`´štf
("%" 
PRIu64
 " ", 
	`LEAF_KEY
(
Ëaf_node
, 
i
));

180 
	`´štf
("| ");

183 
IÁ”ÇlPage
* 
š‹º®_node
 = (IÁ”ÇlPage*)
node_·ge
;

184 
i
 = 0; i < 
š‹º®_node
->
num_keys
; i++) {

185 
	`´štf
("%" 
PRIu64
 " ", 
	`INTERNAL_KEY
(
š‹º®_node
, 
i
));

186 
queue
[
»¬
] = 
	`INTERNAL_OFFSET
(
š‹º®_node
, 
i
);

187 
NodePage
* 
chd_node
 = (NodePage*è
	`g‘_·ge
(
bË
,

188 
	`FILEOFF_TO_PAGENUM
(
	`INTERNAL_OFFSET
(
š‹º®_node
, 
i
)));

189 ià(
chd_node
->
·»Á
 !ğ
·ge_off£t
){

190 
	`PANIC
("btree structure crashed");

192 
	`»Ëa£_·ge
((
Page
*)
chd_node
);

193 
»¬
++;

195 
queue
[
»¬
] = 
	`INTERNAL_OFFSET
(
š‹º®_node
, 
i
);

196 
»¬
++;

197 
	`´štf
("| ");

199 
	`»Ëa£_·ge
((
Page
*)
node_·ge
);

201 
	`ä“
(
queue
);

202 
	}
}

207 
	$fšd_ªd_´št
(
bË_id
, 
št64_t
 
key
) {

208 
št64_t
* 
v®ue_found
 = 
NULL
;

209 
v®ue_found
 = 
	`fšd
(
bË_id
, 
key
);

210 ià(
v®ue_found
 =ğ
NULL
) {

211 
	`´štf
("RecÜd‚Ù found und” key %" 
PRIu64
 ".\n", 
key
);

215 
	`ä“
(
v®ue_found
);

217 
	}
}

221 
	$liûn£_nÙiû
( ) {

222 
	`´štf
("bpt version %s -- Copyright (C) 2010 Amittai Aviram "

223 "h‰p://www.am™i.com\n", 
V”siÚ
);

224 
	`´štf
("This…rogram comes with ABSOLUTELY NO WARRANTY; for details "

228 
	}
}

232 
	$´št_liûn£
Ğ
liûn£_·¹
 ) {

233 
¡¬t
, 
’d
, 
lše
;

234 
FILE
 * 
å
;

235 
bufãr
[0x100];

237 
liûn£_·¹
) {

238 
LICENSE_WARRANTEE
:

239 
¡¬t
 = 
LICENSE_WARRANTEE_START
;

240 
’d
 = 
LICENSE_WARRANTEE_END
;

242 
LICENSE_CONDITIONS
:

243 
¡¬t
 = 
LICENSE_CONDITIONS_START
;

244 
’d
 = 
LICENSE_CONDITIONS_END
;

250 
å
 = 
	`fİ’
(
LICENSE_FILE
, "r");

251 ià(
å
 =ğ
NULL
) {

252 
	`³¼Ü
("print_license: fopen");

253 
	`ex™
(
EXIT_FAILURE
);

255 
lše
 = 0;†š< 
¡¬t
;†ine++)

256 
	`fg‘s
(
bufãr
, (bufãr), 
å
);

257  ; 
lše
 < 
’d
;†ine++) {

258 
	`fg‘s
(
bufãr
, (bufãr), 
å
);

259 
	`´štf
("%s", 
bufãr
);

261 
	`fşo£
(
å
);

262 
	}
}

266 
	$u§ge_1
( ) {

267 
	`´štf
("B+ T»oàOrd” %d(IÁ”Çl).\n", 
Üd”_š‹º®
);

268 
	`´štf
("Following Silberschatz, Korth, Sidarshan, Database Concepts, "

270 
	}
}

274 
	$u§ge_2
( ) {

275 
	`´štf
("Enter‡ny ofhe following commands‡fterhe…rompt > :\n"

284 
	}
}

	@src/buf.cpp

1 
	~<sys/ty³s.h
>

2 
	~<fú.h
>

3 
	~<¡dlib.h
>

4 
	~<as£¹.h
>

5 
	~<¡dio.h
>

6 
	~<uni¡d.h
>

7 
	~<¡ršg.h
>

8 
	~"·ge.h
"

9 
	~"fe.h
"

10 
	~"buf.h
"

11 
	~"·nic.h
"

13 
BufPoŞ
 
	gpoŞ
;

17 
	$æush_·ge
(
Page
* 
·ge
) {

18 
	`fe_wr™e_·ge
(
	`g‘_bË
(
·ge
->
bË_id
),…age->
·g’um
,…age);

19 
·ge
->
is_dœty
 = 
çl£
;

20 
	}
}

24 
	$pİ_äom_Ìu
(
Page
* 
·ge
){

25 ià(
·ge
 =ğ
poŞ
.
Ìu_h—d
 ||…ag=ğpoŞ.
Ìu_
){

26 ià(
·ge
 =ğ
poŞ
.
Ìu_h—d
){

27 
poŞ
.
Ìu_h—d
 = 
·ge
->
Ìu_Ãxt
;

28 ià(
·ge
->
Ìu_Ãxt
)

29 
·ge
->
Ìu_Ãxt
->
Ìu_´ev
 = 
NULL
;

31 ià(
·ge
 =ğ
poŞ
.
Ìu_
){

32 
poŞ
.
Ìu_
 = 
·ge
->
Ìu_´ev
;

33 ià(
·ge
->
Ìu_´ev
)

34 
·ge
->
Ìu_´ev
->
Ìu_Ãxt
 = 
NULL
;

38 
·ge
->
Ìu_´ev
->
Ìu_Ãxt
 =…age->lru_next;

39 
·ge
->
Ìu_Ãxt
->
Ìu_´ev
 =…age->lru_prev;

42 
·ge
->
Ìu_´ev
 =…age->
Ìu_Ãxt
 = 
NULL
;

44 
	}
}

48 
	$push_to_Ìu
(
Page
* 
·ge
){

49 
·ge
->
Ìu_Ãxt
 = 
poŞ
.
Ìu_h—d
;

50 ià(
·ge
->
Ìu_Ãxt
){

51 
·ge
->
Ìu_Ãxt
->
Ìu_´ev
 =…age;

53 
·ge
->
Ìu_´ev
 = 
NULL
;

54 
poŞ
.
Ìu_h—d
 = 
·ge
;

55 ià(
poŞ
.
Ìu_
 =ğ
NULL
){

56 
poŞ
.
Ìu_
 = 
·ge
;

58 
	}
}

62 
Page
* 
	$eviù_·ge
(){

63 
Page
* 
·ge
 = 
poŞ
.
Ìu_
;

64 
·ge
 !ğ
NULL
){

65 ià(
·ge
->
pšút
 != 0){

66 
·ge
 =…age->
Ìu_´ev
;

69 
	`pİ_äom_Ìu
(
·ge
);

70 ià(
·ge
->
is_dœty
)

71 
	`æush_·ge
(
·ge
);

72 
·ge
->
Ìu_Ãxt
 =…age->
Ìu_´ev
 = 
NULL
;

73  
·ge
;

75 
	`PANIC
("evict_page");

76 
	`ex™
(1);

77 
	}
}

81 
	$upd©e_Ìu
(
Page
* 
·ge
){

82 
	`pİ_äom_Ìu
(
·ge
);

83 
	`push_to_Ìu
(
·ge
);

84 
	}
}

88 
	$š™_Ãw_h—d”_·ge
(
H—d”Page
* 
h—d”
, 
bË_id
, 
num_cŞumn
) {

89 
	`mem£t
(
h—d”
, 0, (
H—d”Page
));

91 
h—d”
->
bË_id
 =able_id;

92 
h—d”
->
·g’um
 = 0;

93 
h—d”
->
ä“li¡
 = 0;

94 
h—d”
->
roÙ_off£t
 = 0;

95 
h—d”
->
num_cŞumn
 =‚um_column;

96 
h—d”
->
num_·ges
 = 1;

97 
	`£t_dœty_·ge
((
Page
*)
h—d”
);

98 
h—d”
->
pšút
++;

99 
poŞ
.
tÙ_pšút
++;

100 
	}
}

104 
	$lßd_h—d”_·ge
(
TabË
* 
bË
) {

105 
	`fe_»ad_·ge
(
bË
, 0, &bË->
dbh—d”
);

106 
bË
->
dbh—d”
.
bË_id
 =able->table_id;

107 
bË
->
dbh—d”
.
·g’um
 = 0;

108 
bË
->
dbh—d”
.
is_dœty
 = 
çl£
;

109 
bË
->
dbh—d”
.
pšút
 = 1;

110 
bË
->
dbh—d”
.
Ìu_Ãxt
 = 
NULL
;

111 
bË
->
dbh—d”
.
Ìu_´ev
 = 
NULL
;

112 
poŞ
.
tÙ_pšút
++;

113 
	}
}

117 
Page
* 
	$®loc_·ge
(
TabË
* 
bË
) {

118 
·g’um_t
 
·g’um
 = 
	`FILEOFF_TO_PAGENUM
(
bË
->
dbh—d”
.
ä“li¡
);

119 
F»ePage
* 
ä“·ge
;

120 ià(
·g’um
 == 0){

121 
	`ex·nd_fe
(
bË
,abË->
dbh—d”
.
num_·ges
);

122 
·g’um
 = 
	`FILEOFF_TO_PAGENUM
(
bË
->
dbh—d”
.
ä“li¡
);

124 
ä“·ge
 = (
F»ePage
*)
	`g‘_·ge
(
bË
, 
·g’um
);

125 
bË
->
dbh—d”
.
ä“li¡
 = 
ä“·ge
->
Ãxt
;

127 
	`£t_dœty_·ge
((
Page
*)&
bË
->
dbh—d”
);

128 
	`mem£t
(
ä“·ge
, 0, 
PAGE_SIZE
);

130 
	`£t_dœty_·ge
((
Page
*)
ä“·ge
);

131  (
Page
*)
ä“·ge
;

132 
	}
}

136 
Page
* 
	$g‘_·ge
(
TabË
* 
bË
, 
·g’um_t
 
·g’um
) {

137 
Page
* 
Ãw_·ge
 = 
NULL
;

138 
i
;

139 
i
 = 0; i < 
poŞ
.
num_buf
; i++){

140 ià(!
Ãw_·ge
 && 
poŞ
.
·ges
[
i
].
bË_id
 == 0){

141 
Ãw_·ge
 = &
poŞ
.
·ges
[
i
];

143 ià(
poŞ
.
·ges
[
i
].
bË_id
 =ğ
bË
->table_id &&

144 
poŞ
.
·ges
[
i
].
·g’um
 ==…agenum){

145 
poŞ
.
·ges
[
i
].
pšút
++;

146 
poŞ
.
tÙ_pšút
++;

147  &
poŞ
.
·ges
[
i
];

150 ià(!
Ãw_·ge
){

151 ià((
Ãw_·ge
 = 
	`eviù_·ge
()è=ğ
NULL
){

152 
	`PANIC
("Notƒnough buffer\n");

154 ià(
Ãw_·ge
->
is_dœty
){

155 
	`æush_·ge
(
Ãw_·ge
);

158 
	`fe_»ad_·ge
(
bË
, 
·g’um
, 
Ãw_·ge
);

159 
Ãw_·ge
->
bË_id
 = 
bË
->table_id;

160 
Ãw_·ge
->
·g’um
 =…agenum;

161 
Ãw_·ge
->
pšút
 = 1;

162 
poŞ
.
tÙ_pšút
++;

163 
	`push_to_Ìu
(
Ãw_·ge
);

164  
Ãw_·ge
;

165 
	}
}

171 
Page
* 
	$g‘_·ge
(
TabË
* 
bË
, 
·g’um_t
 
·g’um
, * 
buf_·ge_i
) {

172 
Page
* 
Ãw_·ge
 = 
NULL
;

173 
i
;

174 
Ãw_·ge_i
;

175 
i
 = 0; i < 
poŞ
.
num_buf
; i++){

176 ià(!
Ãw_·ge
 && 
poŞ
.
·ges
[
i
].
bË_id
 == 0){

177 
Ãw_·ge
 = &
poŞ
.
·ges
[
i
];

178 
Ãw_·ge_i
 = 
i
;

180 ià(
poŞ
.
·ges
[
i
].
bË_id
 =ğ
bË
->table_id &&

181 
poŞ
.
·ges
[
i
].
·g’um
 ==…agenum){

183 
Ãw_·ge
 = &
poŞ
.
·ges
[
i
];

184 ià(((
L—fPage
*)
Ãw_·ge
è-> 
is_Ëaf
) {

185 
	`BUF_PAGE_MUTEX_ENTER
(
i
);

187 ià(
»t
) {

188 *
buf_·ge_i
 = 
i
;

189 
poŞ
.
·ges
[
i
].
pšút
++;

190 
poŞ
.
tÙ_pšút
++;

191  &
poŞ
.
·ges
[
i
];

194  
nuÎ±r
;

197 
poŞ
.
·ges
[
i
].
pšút
++;

198 
poŞ
.
tÙ_pšút
++;

199  &
poŞ
.
·ges
[
i
];

204 ià(!
Ãw_·ge
){

205 ià((
Ãw_·ge
 = 
	`eviù_·ge
()è=ğ
NULL
){

206 
	`PANIC
("Notƒnough buffer\n");

208 ià(
Ãw_·ge
->
is_dœty
){

209 
	`æush_·ge
(
Ãw_·ge
);

213 
	`BUF_PAGE_MUTEX_ENTER
(
Ãw_·ge_i
);

215 ià(!
»t
)

216 
	`PANIC
("Evicted…age holdhe†atch\n");

218 
	`fe_»ad_·ge
(
bË
, 
·g’um
, 
Ãw_·ge
);

219 
Ãw_·ge
->
bË_id
 = 
bË
->table_id;

220 
Ãw_·ge
->
·g’um
 =…agenum;

221 
Ãw_·ge
->
pšút
 = 1;

222 
poŞ
.
tÙ_pšút
++;

223 *
buf_·ge_i
 = 
Ãw_·ge_i
;

224 
	`push_to_Ìu
(
Ãw_·ge
);

225  
Ãw_·ge
;

226 
	}
}

231 
	$»Ëa£_h—d”_·ge
(
TabË
* 
bË
) {

232 ià(
bË
->
dbh—d”
.
is_dœty
){

233 
	`fe_wr™e_·ge
(
bË
, 0, &bË->
dbh—d”
);

234 
bË
->
dbh—d”
.
is_dœty
 = 
çl£
;

236 
	`mem£t
(&
bË
->
dbh—d”
, 0, (
H—d”Page
));

237 
poŞ
.
tÙ_pšút
--;

238 
	}
}

242 
	$»Ëa£_·ge
(
Page
* 
·ge
) {

243 
poŞ
.
tÙ_pšút
--;

244 
·ge
->
pšút
--;

245 
	}
}

250 
	$»Ëa£_·ge
(
Page
* 
·ge
, * 
buf_·ge_i
) {

251 
poŞ
.
tÙ_pšút
--;

252 
·ge
->
pšút
--;

253 
poŞ
.
buf_·ge_mu‹x
[*
buf_·ge_i
].
	`uÆock
();

254 
	}
}

258 
	$£t_dœty_·ge
(
Page
* 
·ge
) {

259 
·ge
->
is_dœty
 = 
Œue
;

260 
	}
}

264 
	$ä“_·ge
(
TabË
* 
bË
, 
Page
* 
·ge
) {

265 
F»ePage
* 
ä“·ge
 = (F»ePage*)
·ge
;

266 
	`mem£t
(
ä“·ge
, 0, 
PAGE_SIZE
);

267 
ä“·ge
->
Ãxt
 = 
bË
->
dbh—d”
.
ä“li¡
;

268 
	`£t_dœty_·ge
(
·ge
);

269 
bË
->
dbh—d”
.
ä“li¡
 = 
	`PAGENUM_TO_FILEOFF
(
ä“·ge
->
·g’um
);

270 
	`£t_dœty_·ge
((
Page
*)&
bË
->
dbh—d”
);

271 
	}
}

275 
	$æush_bË
(
TabË
* 
bË
) {

276 
i
;

277 
i
 = 0; i < 
poŞ
.
num_buf
; i++){

278 ià(
poŞ
.
·ges
[
i
].
bË_id
 =ğ
bË
->table_id &&

279 
poŞ
.
·ges
[
i
].
is_dœty
){

280 
	`æush_·ge
(&
poŞ
.
·ges
[
i
]);

283 
	}
}

287 
	$š™_buf_poŞ
(
num_buf
) {

288 
poŞ
.
·ges
 = (
Page
*è
	`ÿÎoc
(
num_buf
, (Page));

289 
poŞ
.
buf_·ge_mu‹x
 = 
Ãw
 
¡d
::
mu‹x
[
num_buf
];

291 
poŞ
.
Ìu_h—d
 = 
NULL
;

292 
poŞ
.
Ìu_
 = 
NULL
;

293 
poŞ
.
num_buf
 =‚um_buf;

294 
poŞ
.
tÙ_pšút
 = 0;

296 
	}
}

300 
	$de¡roy_buf_poŞ
() {

301 
	`ä“
(
poŞ
.
·ges
);

302 
d–‘e
[] 
poŞ
.
buf_·ge_mu‹x
;

304 
poŞ
.
·ges
 = 
NULL
;

305 
poŞ
.
Ìu_h—d
 = 
NULL
;

306 
poŞ
.
Ìu_
 = 
NULL
;

307 
poŞ
.
num_buf
 = 0;

308 
poŞ
.
tÙ_pšút
 = 0;

310 
	}
}

314 
	$´št_buf_poŞ
() {

315 
	`´štf
("tÙ…šúˆğ%d\n", 
poŞ
.
tÙ_pšút
);

316 
	}
}

	@src/deadlock.cpp

1 
	~"d—dlock.h
"

7 
	gDLCheck”
::
	$š™Ÿlize_rjª_acyşic
() {

8 !
s_rjª
.
	`em±y
())

9 
s_rjª
.
	`pİ
();

11 
dfs_Üd”
 = -1;

12 
cyşe_æag
 = 
çl£
;

14 autØ
™
 = 
dl_g¿ph
.
	`begš
(); iˆ!ğdl_g¿ph.
	`’d
(); ++it) {

15 (
™
 -> 
£cÚd
).
fšished
 = 
çl£
;

16 (
™
 -> 
£cÚd
).
dfs_Üd”
 = -1;

18 
	}
}

25 
	gDLCheck”
::
	$š™Ÿlize_rjª_cyşic
() {

26 !
s_rjª
.
	`em±y
())

27 
s_rjª
.
	`pİ
();

29 
dfs_Üd”
 = -1;

30 
cyşe_æag
 = 
çl£
;

32 
dl_g¿ph
.
	`”a£
(
Ï‹¡_Œx_id
);

34 
¡d
::
veùÜ
<> 
”a£_li¡
;

36 
rjª_t
* 
rjª
 = 
nuÎ±r
;

38 autØ
™
 = 
dl_g¿ph
.
	`begš
(); iˆ!ğdl_g¿ph.
	`’d
(); ++it) {

39 
rjª
 = &(
™
 -> 
£cÚd
);

41 autØ
loÿl_™
 = 
rjª
 -> 
wa™šg_Œx_id
.
	`begš
();†oÿl_™ !ğrjª -> wa™šg_Œx_id.
	`’d
(); ++local_it) {

42 ià(*
loÿl_™
 =ğ
Ï‹¡_Œx_id
) {

43 
rjª
 -> 
wa™šg_Œx_id
.
	`”a£
(
loÿl_™
);

44 --
loÿl_™
;

47 
rjª
 -> 
fšished
 = 
çl£
;

48 
rjª
 -> 
dfs_Üd”
 = -1;

50 ià(
rjª
 -> 
wa™šg_Œx_id
.
	`size
() == 0) {

51 
”a£_li¡
.
	`push_back
(
™
 -> 
fœ¡
);

55 autØ
i
 : 
”a£_li¡
)

56 
dl_g¿ph
.
	`”a£
(
i
);

57 
	}
}

64 
	gDLCheck”
::
	$dfs_rjª
(
rjª_t
* 
cur
) {

65 
cur
 -> 
dfs_Üd”
 = ++(
this
 -> dfs_order);

66 
s_rjª
.
	`push
(
cur
);

68 
mš_Üd”
 = 
cur
 -> 
dfs_Üd”
;

70 autØ
™
 = 
cur
 -> 
wa™šg_Œx_id
.
	`begš
(); iˆ!ğcu¸-> wa™šg_Œx_id.
	`’d
(); ++it){

71 ià(
dl_g¿ph
.
	`couÁ
(*
™
) != 0){

72 
rjª_t
* 
Ãxt
 = &(
dl_g¿ph
[*
™
]);

74 ià(
Ãxt
 -> 
dfs_Üd”
 == -1)

75 
mš_Üd”
 = 
¡d
::
	`mš
(mš_Üd”, 
	`dfs_rjª
(
Ãxt
));

76 ià(!
Ãxt
 -> 
fšished
)

77 
mš_Üd”
 = 
¡d
::
	`mš
(mš_Üd”, 
Ãxt
 -> 
dfs_Üd”
);

79 ià(
cyşe_æag
)

80  
INT_MAX
;

84 ià(
cyşe_æag
)

85  
INT_MAX
;

87 ià(
mš_Üd”
 =ğ
cur
 -> 
dfs_Üd”
) {

88 
rjª_t
* 
tmp
 = 
nuÎ±r
;

89 
út_size
 = 0;

91 ià(
út_size
 == 1)

92 
cyşe_æag
 = 
Œue
;

93 
út_size
++;

94 
tmp
 = 
s_rjª
.
	`tİ
();

95 
s_rjª
.
	`pİ
();

97 ià(
cur
 =ğ
tmp
)

102 
cur
 -> 
fšished
 = 
Œue
;

103  
mš_Üd”
;

104 
	}
}

113 
boŞ
 
	gDLCheck”
::
	$is_cyşic
() {

114 autØ
™
 = 
dl_g¿ph
.
	`begš
(); iˆ!ğdl_g¿ph.
	`’d
(); ++it) {

116 ià(
™
 -> 
£cÚd
.
dfs_Üd”
 == -1)

117 
	`dfs_rjª
(&(
™
 -> 
£cÚd
));

119 ià(
cyşe_æag
) {

120 
	`š™Ÿlize_rjª_cyşic
();

121  
Œue
;

124 
	`š™Ÿlize_rjª_acyşic
();

125  
çl£
;

126 
	}
}

136 
boŞ
 
	gDLCheck”
::
d—dlock_checkšg
(
Œx_id
, 
¡d
::
veùÜ
<> 
wa™_fÜ
) {

138 ià(
dl_g¿ph
.
couÁ
(
Œx_id
) != 0)

139 
PANIC
("In deadlock checking. Theransaction cannot wait for morehan oneransaction.\n");

141 
rjª_t
 
cur
(
wa™_fÜ
);

142 
	gÏ‹¡_Œx_id
 = 
Œx_id
;

144 
	gdl_g¿ph
[
Œx_id
] = 
cur
;

146  
is_cyşic
();

156 
	gDLCheck”
::
	$d–‘e_wa™šg_fÜ_Œx
(
Œx_id
) {

158 ià(
dl_g¿ph
.
	`couÁ
(
Œx_id
) != 0)

159 
	`PANIC
("In delete waiting forrx. Committingransaction cannot wait for some other one.\n");

161 
¡d
::
veùÜ
<> 
”a£_li¡
;

162 
rjª_t
* 
rjª
 = 
nuÎ±r
;

164 autØ
™
 = 
dl_g¿ph
.
	`begš
(); iˆ!ğdl_g¿ph.
	`’d
(); ++it) {

165 
rjª
 = &(
™
 -> 
£cÚd
);

167 autØ
loÿl_™
 = 
rjª
 -> 
wa™šg_Œx_id
.
	`begš
();†oÿl_™ !ğrjª -> wa™šg_Œx_id.
	`’d
(); ++local_it) {

168 ià(*
loÿl_™
 =ğ
Œx_id
) {

169 
rjª
 -> 
wa™šg_Œx_id
.
	`”a£
(
loÿl_™
);

170 --
loÿl_™
;

173 ià(
rjª
 -> 
wa™šg_Œx_id
.
	`size
() == 0) {

174 
”a£_li¡
.
	`push_back
(
™
 -> 
fœ¡
);

178 autØ
i
 : 
”a£_li¡
)

179 
dl_g¿ph
.
	`”a£
(
i
);

180 
	}
}

188 
	gDLCheck”
::
	$g‘_wa™_lock_Œx_id
(
Œx_id
) {

189 ià(
dl_g¿ph
.
	`couÁ
(
Œx_id
) == 0)

190  
NO_WAIT_LOCK
;

192  
dl_g¿ph
[
Œx_id
].
wa™šg_Œx_id
.
	`back
();

193 
	}
}

	@src/delete.cpp

1 
	~"b±_š‹º®.h
"

9 
	$g‘_ÃighbÜ_šdex
(
TabË
* 
bË
, 
NodePage
* 
node_·ge
) {

10 
i
;

15 
IÁ”ÇlPage
* 
·»Á_node
;

16 
·»Á_node
 = (
IÁ”ÇlPage
*)

17 
	`g‘_·ge
(
bË
, 
	`FILEOFF_TO_PAGENUM
(
node_·ge
->
·»Á
));

18 
i
 = 0; i <ğ
·»Á_node
->
num_keys
; i++)

19 ià(
	`INTERNAL_OFFSET
(
·»Á_node
, 
i
)

20 =ğ
	`PAGENUM_TO_FILEOFF
(
node_·ge
->
·g’um
)){

21 
	`»Ëa£_·ge
((
Page
*)
·»Á_node
);

22  
i
 - 1;

26 
	`PANIC
("Search for‚onexistent…ointero‚ode in…arent.");

28 
	}
}

30 
	$»move_’Œy_äom_node
(
TabË
* 
bË
, 
NodePage
* 
node_·ge
, 
št64_t
 
key
) {

31 
i
;

32 
key_idx
 = 0;

34 ià(
node_·ge
->
is_Ëaf
) {

35 
L—fPage
* 
Ëaf_node
 = (L—fPage*)
node_·ge
;

38 
i
 = 0; i < 
Ëaf_node
->
num_keys
; i++) {

39 ià(
	`LEAF_KEY
(
Ëaf_node
, 
i
è=ğ
key
) {

40 
key_idx
 = 
i
;

44 ià(
i
 =ğ
Ëaf_node
->
num_keys
) {

45 
	`PANIC
("remove_entry_from_node:‚o key inhis…age");

49 
i
 = 
key_idx
; i < 
Ëaf_node
->
num_keys
 - 1; i++) {

50 
	`LEAF_KEY
(
Ëaf_node
, 
i
) = LEAF_KEY(leaf_node, i+1);

51 
	`memıy
(
	`LEAF_VALUE
(
Ëaf_node
, 
i
), LEAF_VALUE(leaf_node, i+1),

52 
SIZE_VALUE
);

55 
	`LEAF_KEY
(
Ëaf_node
,†—f_node->
num_keys
 - 1) = 0;

56 
	`mem£t
(
	`LEAF_VALUE
(
Ëaf_node
,†—f_node->
num_keys
 - 1), 0, 
SIZE_VALUE
);

58 
Ëaf_node
->
num_keys
--;

60 
IÁ”ÇlPage
* 
š‹º®_node
 = (IÁ”ÇlPage*)
node_·ge
;

63 
i
 = 0; i < 
š‹º®_node
->
num_keys
; i++) {

64 ià(
	`INTERNAL_KEY
(
š‹º®_node
, 
i
è=ğ
key
) {

65 
key_idx
 = 
i
;

69 ià(
i
 =ğ
š‹º®_node
->
num_keys
) {

70 
	`PANIC
("remove_entry_from_node:‚o key inhis…age");

74 
i
 = 
key_idx
; i < 
š‹º®_node
->
num_keys
 - 1; i++) {

75 
	`INTERNAL_KEY
(
š‹º®_node
, 
i
) = INTERNAL_KEY(internal_node, i+1);

76 
	`INTERNAL_OFFSET
(
š‹º®_node
, 
i
+1) =

77 
	`INTERNAL_OFFSET
(
š‹º®_node
, 
i
+2);

80 
	`INTERNAL_KEY
(
š‹º®_node
, iÁ”Çl_node->
num_keys
 - 1) = 0;

81 
	`INTERNAL_OFFSET
(
š‹º®_node
, iÁ”Çl_node->
num_keys
) = 0;

83 
š‹º®_node
->
num_keys
--;

85 
	}
}

87 
	$adju¡_roÙ
(
TabË
* 
bË
, 
NodePage
* 
roÙ_·ge
) {

92 ià(
roÙ_·ge
->
num_keys
 > 0){

102 ià(!
roÙ_·ge
->
is_Ëaf
) {

103 
IÁ”ÇlPage
* 
roÙ_node
 = (IÁ”ÇlPage*)
roÙ_·ge
;

104 
bË
->
dbh—d”
.
roÙ_off£t
 = 
	`INTERNAL_OFFSET
(
roÙ_node
, 0);

106 
NodePage
* 
node_·ge
;

107 
node_·ge
 = (
NodePage
*è
	`g‘_·ge
(
bË
,

108 
	`FILEOFF_TO_PAGENUM
(
bË
->
dbh—d”
.
roÙ_off£t
));

109 
	`£t_dœty_·ge
((
Page
*)
node_·ge
);

111 
node_·ge
->
·»Á
 = 0;

113 
	`»Ëa£_·ge
((
Page
*)
node_·ge
);

120 
bË
->
dbh—d”
.
roÙ_off£t
 = 0;

122 
	`£t_dœty_·ge
((
Page
*)&
bË
->
dbh—d”
);

124 
	`ä“_·ge
(
bË
, (
Page
*)
roÙ_·ge
);

125 
	}
}

130 
	$cßËsû_nodes
(
TabË
* 
bË
, 
NodePage
* 
node_·ge
, NodePage* 
ÃighbÜ_·ge
,

131 
ÃighbÜ_šdex
, 
k_´ime
) {

133 
i
, 
j
, 
ÃighbÜ_š£¹iÚ_šdex
, 
n_’d
;

134 
NodePage
* 
tmp
;

140 ià(
ÃighbÜ_šdex
 == -1) {

141 
tmp
 = 
node_·ge
;

142 
node_·ge
 = 
ÃighbÜ_·ge
;

143 
ÃighbÜ_·ge
 = 
tmp
;

151 
ÃighbÜ_š£¹iÚ_šdex
 = 
ÃighbÜ_·ge
->
num_keys
;

158 ià(!
node_·ge
->
is_Ëaf
) {

159 
IÁ”ÇlPage
* 
node
 = (IÁ”ÇlPage*)
node_·ge
;

160 
IÁ”ÇlPage
* 
ÃighbÜ_node
 = (IÁ”ÇlPage*)
ÃighbÜ_·ge
;

165 
	`INTERNAL_KEY
(
ÃighbÜ_node
, 
ÃighbÜ_š£¹iÚ_šdex
èğ
k_´ime
;

166 
ÃighbÜ_node
->
num_keys
++;

168 
n_’d
 = 
node
->
num_keys
;

170 
i
 = 
ÃighbÜ_š£¹iÚ_šdex
 + 1, 
j
 = 0; j < 
n_’d
; i++, j++) {

171 
	`INTERNAL_KEY
(
ÃighbÜ_node
, 
i
èğINTERNAL_KEY(
node
, 
j
);

172 
	`INTERNAL_OFFSET
(
ÃighbÜ_node
, 
i
èğINTERNAL_OFFSET(
node
, 
j
);

173 
ÃighbÜ_node
->
num_keys
++;

174 
node
->
num_keys
--;

180 
	`INTERNAL_OFFSET
(
ÃighbÜ_node
, 
i
èğINTERNAL_OFFSET(
node
, 
j
);

185 
i
 = 0; i < 
ÃighbÜ_node
->
num_keys
 + 1; i++) {

186 
NodePage
* 
chd_·ge
;

187 
chd_·ge
 = (
NodePage
*)
	`g‘_·ge
(
bË
,

188 
	`FILEOFF_TO_PAGENUM
(
	`INTERNAL_OFFSET
(
ÃighbÜ_node
, 
i
)));

189 
chd_·ge
->
·»Á
 = 
	`PAGENUM_TO_FILEOFF
(
ÃighbÜ_node
->
·g’um
);

190 
	`£t_dœty_·ge
((
Page
*)
chd_·ge
);

191 
	`»Ëa£_·ge
((
Page
*)
chd_·ge
);

194 
	`ä“_·ge
(
bË
, (
Page
*)
node
);

203 
L—fPage
* 
node
 = (L—fPage*)
node_·ge
;

204 
L—fPage
* 
ÃighbÜ_node
 = (L—fPage*)
ÃighbÜ_·ge
;

206 
i
 = 
ÃighbÜ_š£¹iÚ_šdex
, 
j
 = 0; j < 
node
->
num_keys
; i++, j++) {

207 
	`LEAF_KEY
(
ÃighbÜ_node
, 
i
èğLEAF_KEY(
node
, 
j
);

208 
	`memıy
(
	`LEAF_VALUE
(
ÃighbÜ_node
, 
i
), LEAF_VALUE(
node
, 
j
),

209 
SIZE_VALUE
);

210 
ÃighbÜ_node
->
num_keys
++;

212 
ÃighbÜ_node
->
siblšg
 = 
node
->sibling;

214 
	`ä“_·ge
(
bË
, (
Page
*)
node
);

217 
NodePage
* 
·»Á_node
;

218 
·»Á_node
 = (
NodePage
*è
	`g‘_·ge
(
bË
,

219 
	`FILEOFF_TO_PAGENUM
(
ÃighbÜ_·ge
->
·»Á
));

220 
	`£t_dœty_·ge
((
Page
*)
·»Á_node
);

221 
	`d–‘e_’Œy
(
bË
, 
·»Á_node
, 
k_´ime
);

222 
	`»Ëa£_·ge
((
Page
*)
·»Á_node
);

223 
	}
}

229 
	$»di¡ribu‹_nodes
(
TabË
* 
bË
, 
NodePage
* 
node_·ge
, NodePage* 
ÃighbÜ_·ge
,

230 
ÃighbÜ_šdex
,

231 
k_´ime_šdex
, 
k_´ime
) {

233 
i
;

240 ià(
ÃighbÜ_šdex
 != -1) {

241 ià(!
node_·ge
->
is_Ëaf
) {

242 
IÁ”ÇlPage
* 
node
 = (IÁ”ÇlPage*)
node_·ge
;

243 
IÁ”ÇlPage
* 
ÃighbÜ_node
 = (IÁ”ÇlPage*)
ÃighbÜ_·ge
;

244 
	`INTERNAL_OFFSET
(
node
,‚ode->
num_keys
 + 1) =

245 
	`INTERNAL_OFFSET
(
node
,‚ode->
num_keys
);

247 
i
 = 
node
->
num_keys
; i > 0; i--) {

248 
	`INTERNAL_KEY
(
node
, 
i
) = INTERNAL_KEY(node, i - 1);

249 
	`INTERNAL_OFFSET
(
node
, 
i
) = INTERNAL_OFFSET(node, i - 1);

251 
	`INTERNAL_OFFSET
(
node
, 0) =

252 
	`INTERNAL_OFFSET
(
ÃighbÜ_node
,‚eighbÜ_node->
num_keys
);

253 
NodePage
* 
chd_·ge
 = (NodePage*)
	`g‘_·ge
(
bË
,

254 
	`FILEOFF_TO_PAGENUM
(
	`INTERNAL_OFFSET
(
node
, 0)));

255 
	`£t_dœty_·ge
((
Page
*)
chd_·ge
);

256 
chd_·ge
->
·»Á
 = 
	`PAGENUM_TO_FILEOFF
(
node
->
·g’um
);

257 
	`»Ëa£_·ge
((
Page
*)
chd_·ge
);

259 
	`INTERNAL_OFFSET
(
ÃighbÜ_node
,‚eighbÜ_node->
num_keys
) = 0;

260 
	`INTERNAL_KEY
(
node
, 0èğ
k_´ime
;

262 
IÁ”ÇlPage
* 
·»Á_node
 = (IÁ”ÇlPage*)
	`g‘_·ge
(
bË
,

263 
	`FILEOFF_TO_PAGENUM
(
node
->
·»Á
));

264 
	`INTERNAL_KEY
(
·»Á_node
, 
k_´ime_šdex
) =

265 
	`INTERNAL_KEY
(
ÃighbÜ_node
,‚eighbÜ_node->
num_keys
 - 1);

267 
	`£t_dœty_·ge
((
Page
*)
·»Á_node
);

268 
	`»Ëa£_·ge
((
Page
*)
·»Á_node
);

273 
node
->
num_keys
++;

274 
ÃighbÜ_node
->
num_keys
--;

276 
L—fPage
* 
node
 = (L—fPage*)
node_·ge
;

277 
L—fPage
* 
ÃighbÜ_node
 = (L—fPage*)
ÃighbÜ_·ge
;

279 
i
 = 
node
->
num_keys
; i > 0; i--) {

280 
	`LEAF_KEY
(
node
, 
i
) = LEAF_KEY(node, i - 1);

281 
	`memıy
(
	`LEAF_VALUE
(
node
, 
i
), LEAF_VALUEÒode, i - 1), 
SIZE_VALUE
);

283 
	`memıy
(
	`LEAF_VALUE
(
node
, 0),

284 
	`LEAF_VALUE
(
ÃighbÜ_node
,‚eighbÜ_node->
num_keys
 - 1),

285 
SIZE_VALUE
);

286 
	`mem£t
(
	`LEAF_VALUE
(
ÃighbÜ_node
,‚eighbÜ_node->
num_keys
 - 1), 0,

287 
SIZE_VALUE
);

288 
	`LEAF_KEY
(
node
, 0èğLEAF_KEY(
ÃighbÜ_node
,‚eighbÜ_node->
num_keys
 - 1);

290 
IÁ”ÇlPage
* 
·»Á_node
;

291 
·»Á_node
 = (
IÁ”ÇlPage
*)
	`g‘_·ge
(
bË
,

292 
	`FILEOFF_TO_PAGENUM
(
node
->
·»Á
));

293 
	`INTERNAL_KEY
(
·»Á_node
, 
k_´ime_šdex
èğ
	`LEAF_KEY
(
node
, 0);

294 
	`£t_dœty_·ge
((
Page
*)
·»Á_node
);

295 
	`»Ëa£_·ge
((
Page
*)
·»Á_node
);

300 
node
->
num_keys
++;

301 
ÃighbÜ_node
->
num_keys
--;

311 ià(
node_·ge
->
is_Ëaf
) {

312 
L—fPage
* 
node
 = (L—fPage*)
node_·ge
;

313 
L—fPage
* 
ÃighbÜ_node
 = (L—fPage*)
ÃighbÜ_·ge
;;

315 
	`LEAF_KEY
(
node
,‚ode->
num_keys
èğLEAF_KEY(
ÃighbÜ_node
, 0);

316 
	`memıy
(
	`LEAF_VALUE
(
node
,‚ode->
num_keys
), LEAF_VALUE(
ÃighbÜ_node
, 0),

317 
SIZE_VALUE
);

319 
IÁ”ÇlPage
* 
·»Á_node
;

320 
·»Á_node
 = (
IÁ”ÇlPage
*)
	`g‘_·ge
(
bË
,

321 
	`FILEOFF_TO_PAGENUM
(
node
->
·»Á
));

322 
	`INTERNAL_KEY
(
·»Á_node
, 
k_´ime_šdex
èğ
	`LEAF_KEY
(
ÃighbÜ_node
, 1);

323 
	`£t_dœty_·ge
((
Page
*)
·»Á_node
);

324 
	`»Ëa£_·ge
((
Page
*)
·»Á_node
);

326 
i
 = 0; i < 
ÃighbÜ_node
->
num_keys
 - 1; i++) {

327 
	`LEAF_KEY
(
ÃighbÜ_node
, 
i
) = LEAF_KEY(neighbor_node, i + 1);

328 
	`memıy
(
	`LEAF_VALUE
(
ÃighbÜ_node
, 
i
), LEAF_VALUE(neighbor_node, i + 1),

329 
SIZE_VALUE
);

335 
node
->
num_keys
++;

336 
ÃighbÜ_node
->
num_keys
--;

339 
IÁ”ÇlPage
* 
node
 = (IÁ”ÇlPage*)
node_·ge
;

340 
IÁ”ÇlPage
* 
ÃighbÜ_node
 = (IÁ”ÇlPage*)
ÃighbÜ_·ge
;

342 
	`INTERNAL_KEY
(
node
,‚ode->
num_keys
èğ
k_´ime
;

343 
	`INTERNAL_OFFSET
(
node
,‚ode->
num_keys
 + 1) =

344 
	`INTERNAL_OFFSET
(
ÃighbÜ_node
, 0);

346 
NodePage
* 
chd_·ge
;

347 
chd_·ge
 = (
NodePage
*)
	`g‘_·ge
(
bË
, 
	`FILEOFF_TO_PAGENUM
(

348 
	`INTERNAL_OFFSET
(
node
,‚ode->
num_keys
 + 1)));

349 
chd_·ge
->
·»Á
 = 
	`PAGENUM_TO_FILEOFF
(
node
->
·g’um
);

350 
	`£t_dœty_·ge
((
Page
*)
chd_·ge
);

351 
	`»Ëa£_·ge
((
Page
*)
chd_·ge
);

353 
IÁ”ÇlPage
* 
·»Á_node
;

354 
·»Á_node
 = (
IÁ”ÇlPage
*)
	`g‘_·ge
(
bË
,

355 
	`FILEOFF_TO_PAGENUM
(
node
->
·»Á
));

356 
	`INTERNAL_KEY
(
·»Á_node
, 
k_´ime_šdex
) =

357 
	`INTERNAL_KEY
(
ÃighbÜ_node
, 0);

358 
	`£t_dœty_·ge
((
Page
*)
·»Á_node
);

359 
	`»Ëa£_·ge
((
Page
*)
·»Á_node
);

361 
i
 = 0; i < 
ÃighbÜ_node
->
num_keys
 - 1; i++) {

362 
	`INTERNAL_KEY
(
ÃighbÜ_node
, 
i
) = INTERNAL_KEY(neighbor_node, i + 1);

363 
	`INTERNAL_OFFSET
(
ÃighbÜ_node
, 
i
) =

364 
	`INTERNAL_OFFSET
(
ÃighbÜ_node
, 
i
 + 1);

367 
	`INTERNAL_OFFSET
(
ÃighbÜ_node
, 
i
) = INTERNAL_OFFSET(neighbor_node, i + 1);

374 
node
->
num_keys
++;

375 
ÃighbÜ_node
->
num_keys
--;

378 
	}
}

385 
	$d–‘e_’Œy
(
TabË
* 
bË
, 
NodePage
* 
node_·ge
, 
št64_t
 
key
) {

387 
mš_keys
;

388 
off_t
 
ÃighbÜ_off£t
;

389 
ÃighbÜ_šdex
;

390 
k_´ime_šdex
, 
k_´ime
;

391 
ÿ·c™y
;

395 
	`»move_’Œy_äom_node
(
bË
, 
node_·ge
, 
key
);

399 ià(
bË
->
dbh—d”
.
roÙ_off£t
 =ğ
	`PAGENUM_TO_FILEOFF
(
node_·ge
->
·g’um
)) {

400 
	`adju¡_roÙ
(
bË
, 
node_·ge
);

411 #ifdeà
IS_DELAYED_MERGE


412 
mš_keys
 = 1;

414 
mš_keys
 = 
node_·ge
->
is_Ëaf
 ? 
	`cut
(
Üd”_Ëaf
 - 1è: cut(
Üd”_š‹º®
) - 1;

421 ià(
node_·ge
->
num_keys
 >ğ
mš_keys
)

433 
ÃighbÜ_šdex
 = 
	`g‘_ÃighbÜ_šdex
(
bË
, 
node_·ge
);

434 
k_´ime_šdex
 = 
ÃighbÜ_šdex
 == -1 ? 0 :‚eighbor_index;

436 
IÁ”ÇlPage
* 
·»Á_node
;

437 
·»Á_node
 = (
IÁ”ÇlPage
*)

438 
	`g‘_·ge
(
bË
, 
	`FILEOFF_TO_PAGENUM
(
node_·ge
->
·»Á
));

440 
k_´ime
 = 
	`INTERNAL_KEY
(
·»Á_node
, 
k_´ime_šdex
);

441 
ÃighbÜ_off£t
 = 
ÃighbÜ_šdex
 =ğ-1 ? 
	`INTERNAL_OFFSET
(
·»Á_node
, 1) :

442 
	`INTERNAL_OFFSET
(
·»Á_node
, 
ÃighbÜ_šdex
);

443 
	`»Ëa£_·ge
((
Page
*)
·»Á_node
);

445 
ÿ·c™y
 = 
node_·ge
->
is_Ëaf
 ? 
Üd”_Ëaf
 : 
Üd”_š‹º®
 - 1;

447 
NodePage
* 
ÃighbÜ_·ge
;

448 
ÃighbÜ_·ge
 = (
NodePage
*è
	`g‘_·ge
(
bË
,

449 
	`FILEOFF_TO_PAGENUM
(
ÃighbÜ_off£t
));

450 
	`£t_dœty_·ge
((
Page
*)
ÃighbÜ_·ge
);

453 ià(
ÃighbÜ_·ge
->
num_keys
 + 
node_·ge
->num_key < 
ÿ·c™y
){

454 
	`cßËsû_nodes
(
bË
, 
node_·ge
, 
ÃighbÜ_·ge
, 
ÃighbÜ_šdex
, 
k_´ime
);

458 
	`»di¡ribu‹_nodes
(
bË
, 
node_·ge
, 
ÃighbÜ_·ge
, 
ÃighbÜ_šdex
,

459 
k_´ime_šdex
, 
k_´ime
);

461 
	`»Ëa£_·ge
((
Page
*)
ÃighbÜ_·ge
);

462 
	}
}

466 
	$d–‘e_»cÜd
(
TabË
* 
bË
, 
št64_t
 
key
) {

467 
št64_t
* 
v®ue_found
 = 
NULL
;

468 ià((
v®ue_found
 = 
	`fšd_»cÜd
(
bË
, 
key
)) == 0) {

470 
	`ä“
(
v®ue_found
);

474 
L—fPage
* 
Ëaf_node
;

475 
	`fšd_Ëaf
(
bË
, 
key
, &
Ëaf_node
);

476 
	`£t_dœty_·ge
((
Page
*)
Ëaf_node
);

478 
	`d–‘e_’Œy
(
bË
, (
NodePage
*)
Ëaf_node
, 
key
);

479 
	`»Ëa£_·ge
((
Page
*)
Ëaf_node
);

482 
	}
}

	@src/file.cpp

1 
	~<sys/ty³s.h
>

2 
	~<fú.h
>

3 
	~<¡dlib.h
>

4 
	~<as£¹.h
>

5 
	~<¡dio.h
>

6 
	~<uni¡d.h
>

7 
	~<¡ršg.h
>

8 
	~"fe.h
"

9 
	~"·nic.h
"

11 
	gdbfe
;

14 
	$fe_ä“_·ge
(
TabË
* 
bË
, 
·g’um_t
 
·g’um
) {

15 
F»ePage
 
ä“·ge
;

16 
	`mem£t
(&
ä“·ge
, 0, 
PAGE_SIZE
);

18 
ä“·ge
.
Ãxt
 = 
bË
->
dbh—d”
.
ä“li¡
;

19 
	`fe_wr™e_·ge
(
bË
, 
·g’um
, &
ä“·ge
);

21 
bË
->
dbh—d”
.
ä“li¡
 = 
	`PAGENUM_TO_FILEOFF
(
·g’um
);

22 
	}
}

25 
	$ex·nd_fe
(
TabË
* 
bË
, 
size_t
 
út_·ge_to_ex·nd
) {

26 
off_t
 
off£t
 = 
bË
->
dbh—d”
.
num_·ges
 * 
PAGE_SIZE
;

28 ià(
bË
->
dbh—d”
.
num_·ges
 > 1024 * 1024) {

30 
	`PANIC
("Test: you‡re‡lready having‡ DB file overhan 4GB");

33 
i
;

34 
i
 = 0; i < 
út_·ge_to_ex·nd
; i++) {

35 
	`fe_ä“_·ge
(
bË
, 
	`FILEOFF_TO_PAGENUM
(
off£t
));

36 
bË
->
dbh—d”
.
num_·ges
++;

37 
off£t
 +ğ
PAGE_SIZE
;

39 
	}
}

41 
	$fe_»ad_·ge
(
TabË
* 
bË
, 
·g’um_t
 
·g’um
, * 
·ge
) {

42 
	`l£ek
(
bË
->
dbfe
, 
	`PAGENUM_TO_FILEOFF
(
·g’um
), 
SEEK_SET
);

43 
	`»ad
(
bË
->
dbfe
, 
·ge
, 
PAGE_SIZE
);

44 
	}
}

46 
	$fe_wr™e_·ge
(
TabË
* 
bË
, 
·g’um_t
 
·g’um
, * 
·ge
) {

47 
	`l£ek
(
bË
->
dbfe
, 
	`PAGENUM_TO_FILEOFF
(
·g’um
), 
SEEK_SET
);

48 
	`wr™e
(
bË
->
dbfe
, 
·ge
, 
PAGE_SIZE
);

49 
	}
}

	@src/global_vars.cpp

1 
	~"b±_š‹º®.h
"

10 
	gÜd”_š‹º®
 = 
BPTREE_INTERNAL_ORDER
;

11 
	gÜd”_Ëaf
 = 
BPTREE_LEAF_ORDER
;

	@src/insert.cpp

1 
	~"b±_š‹º®.h
"

6 
	$g‘_Ëá_šdex
(
TabË
* 
bË
, 
IÁ”ÇlPage
* 
·»Á
, 
off_t
 
Ëá_off£t
) {

7 
Ëá_šdex
 = 0;

8 
Ëá_šdex
 <ğ
·»Á
->
num_keys
 &&

9 
	`INTERNAL_OFFSET
(
·»Á
, 
Ëá_šdex
è!ğ
Ëá_off£t
)

10 
Ëá_šdex
++;

11  
Ëá_šdex
;

12 
	}
}

16 
	$š£¹_što_Ëaf
(
TabË
* 
bË
, 
L—fPage
* 
Ëaf_node
, 
št64_t
 
key
, iÁ64_t* 
v®ue
) {

17 
š£¹iÚ_pošt
;

18 
i
;

20 
š£¹iÚ_pošt
 = 0;

21 
š£¹iÚ_pošt
 < 
Ëaf_node
->
num_keys
 &&

22 
	`LEAF_KEY
(
Ëaf_node
, 
š£¹iÚ_pošt
è< 
key
)

23 
š£¹iÚ_pošt
++;

26 
i
 = 
Ëaf_node
->
num_keys
 - 1; i >ğ
š£¹iÚ_pošt
; i--) {

27 
	`LEAF_KEY
(
Ëaf_node
, 
i
+1) = LEAF_KEY(leaf_node, i);

28 
	`memıy
(
	`LEAF_VALUE
(
Ëaf_node
, 
i
+1), LEAF_VALUE(leaf_node, i),

29 
SIZE_VALUE
);

32 
	`LEAF_KEY
(
Ëaf_node
, 
š£¹iÚ_pošt
èğ
key
;

33 
	`memıy
(
	`LEAF_VALUE
(
Ëaf_node
, 
š£¹iÚ_pošt
), 
v®ue
, 
SIZE_VALUE
);

34 
Ëaf_node
->
num_keys
++;

38 
	}
}

43 
	$š£¹_što_Ëaf_aá”_¥l™tšg
(
TabË
* 
bË
, 
L—fPage
* 
Ëaf
, 
št64_t
 
key
,

44 
št64_t
* 
v®ue
) {

45 
š£¹iÚ_šdex
, 
¥l™
, 
i
, 
j
;

46 
št64_t
 
Ãw_key
;

49 
L—fPage
* 
Ãw_Ëaf
 = (L—fPage*)
	`®loc_·ge
(
bË
);

50 
Ãw_Ëaf
->
is_Ëaf
 = 
Œue
;

51 
Ãw_Ëaf
->
num_keys
 = 0;

53 
š£¹iÚ_šdex
 = 0;

54 
š£¹iÚ_šdex
 < 
Üd”_Ëaf
 - 1 &&

55 
	`LEAF_KEY
(
Ëaf
, 
š£¹iÚ_šdex
è< 
key
){

56 
š£¹iÚ_šdex
++;

59 
¥l™
 = 
	`cut
(
Üd”_Ëaf
 - 1);

61 ià(
š£¹iÚ_šdex
 < 
¥l™
) {

63 
i
 = 
¥l™
 - 1, 
j
 = 0; i < 
Üd”_Ëaf
 - 1; i++, j++) {

64 
	`LEAF_KEY
(
Ãw_Ëaf
, 
j
èğLEAF_KEY(
Ëaf
, 
i
);

65 
	`memıy
(
	`LEAF_VALUE
(
Ãw_Ëaf
, 
j
), LEAF_VALUE(
Ëaf
, 
i
), 
SIZE_VALUE
);

67 
Ãw_Ëaf
->
num_keys
++;

68 
Ëaf
->
num_keys
--;

71 
i
 = 
¥l™
 - 2; i >ğ
š£¹iÚ_šdex
; i--) {

72 
	`LEAF_KEY
(
Ëaf
, 
i
+1) = LEAF_KEY(leaf, i);

73 
	`memıy
(
	`LEAF_VALUE
(
Ëaf
, 
i
+1), LEAF_VALUEÖ—f, i), 
SIZE_VALUE
);

75 
	`LEAF_KEY
(
Ëaf
, 
š£¹iÚ_šdex
èğ
key
;

76 
	`memıy
(
	`LEAF_VALUE
(
Ëaf
, 
š£¹iÚ_šdex
), 
v®ue
, 
SIZE_VALUE
);

77 
Ëaf
->
num_keys
++;

80 
i
 = 
¥l™
, 
j
 = 0; i < 
Üd”_Ëaf
 - 1; i++, j++) {

81 ià(
i
 =ğ
š£¹iÚ_šdex
) {

83 
j
++;

85 
	`LEAF_KEY
(
Ãw_Ëaf
, 
j
èğLEAF_KEY(
Ëaf
, 
i
);

86 
	`memıy
(
	`LEAF_VALUE
(
Ãw_Ëaf
, 
j
), LEAF_VALUE(
Ëaf
, 
i
), 
SIZE_VALUE
);

88 
Ãw_Ëaf
->
num_keys
++;

89 
Ëaf
->
num_keys
--;

91 
	`LEAF_KEY
(
Ãw_Ëaf
, 
š£¹iÚ_šdex
 - 
¥l™
èğ
key
;

92 
	`memıy
(
	`LEAF_VALUE
(
Ãw_Ëaf
, 
š£¹iÚ_šdex
 - 
¥l™
), 
v®ue
,

93 
SIZE_VALUE
);

94 
Ãw_Ëaf
->
num_keys
++;

98 
Ãw_Ëaf
->
siblšg
 = 
Ëaf
->sibling;

99 
Ëaf
->
siblšg
 = 
	`PAGENUM_TO_FILEOFF
(
Ãw_Ëaf
->
·g’um
);

102 
i
 = 
Ëaf
->
num_keys
; i < 
Üd”_Ëaf
 - 1; i++) {

103 
	`LEAF_KEY
(
Ëaf
, 
i
) = 0;

104 
	`mem£t
(
	`LEAF_VALUE
(
Ëaf
, 
i
), 0, 
SIZE_VALUE
);

106 
i
 = 
Ãw_Ëaf
->
num_keys
; i < 
Üd”_Ëaf
 - 1; i++) {

107 
	`LEAF_KEY
(
Ãw_Ëaf
, 
i
) = 0;

108 
	`mem£t
(
	`LEAF_VALUE
(
Ãw_Ëaf
, 
i
), 0, 
SIZE_VALUE
);

111 
Ãw_Ëaf
->
·»Á
 = 
Ëaf
->parent;

113 
Ãw_key
 = 
	`LEAF_KEY
(
Ãw_Ëaf
, 0);

116 
	`š£¹_što_·»Á
(
bË
, (
NodePage
*)
Ëaf
, 
Ãw_key
, (NodePage*)
Ãw_Ëaf
);

118 
	`»Ëa£_·ge
((
Page
*)
Ãw_Ëaf
);

119 
	}
}

124 
	$š£¹_što_node
(
TabË
* 
bË
, 
IÁ”ÇlPage
* 
n
, 
Ëá_šdex
, 
št64_t
 
key
,

125 
off_t
 
right_off£t
) {

126 
i
;

128 
i
 = 
n
->
num_keys
; i > 
Ëá_šdex
; i--) {

129 
	`INTERNAL_OFFSET
(
n
, 
i
 + 1) = INTERNAL_OFFSET(n, i);

130 
	`INTERNAL_KEY
(
n
, 
i
) = INTERNAL_KEY(n, i - 1);

132 
	`INTERNAL_OFFSET
(
n
, 
Ëá_šdex
 + 1èğ
right_off£t
;

133 
	`INTERNAL_KEY
(
n
, 
Ëá_šdex
èğ
key
;

134 
n
->
num_keys
++;

135 
	}
}

140 
	$š£¹_što_node_aá”_¥l™tšg
(
TabË
* 
bË
, 
IÁ”ÇlPage
* 
Şd_node
, 
Ëá_šdex
,

141 
št64_t
 
key
, 
off_t
 
right_off£t
) {

142 
i
, 
j
, 
¥l™
, 
k_´ime
;

143 
št64_t
* 
‹mp_keys
;

144 
off_t
* 
‹mp_poš‹rs
;

153 
‹mp_poš‹rs
 = (
off_t
*)
	`m®loc
Ğ(
Üd”_š‹º®
 + 1) * (off_t) );

154 ià(
‹mp_poš‹rs
 =ğ
NULL
) {

155 
	`PANIC
("Temporary…ointers‡rray for splitting‚odes.");

157 
‹mp_keys
 = (
št64_t
*)
	`m®loc
Ğ
Üd”_š‹º®
 * (int64_t) );

158 ià(
‹mp_keys
 =ğ
NULL
) {

159 
	`PANIC
("Temporary keys‡rray for splitting‚odes.");

162 
i
 = 0, 
j
 = 0; i < 
Şd_node
->
num_keys
 + 1; i++, j++) {

163 ià(
j
 =ğ
Ëá_šdex
 + 1) j++;

164 
‹mp_poš‹rs
[
j
] = 
	`INTERNAL_OFFSET
(
Şd_node
, 
i
);

167 
i
 = 0, 
j
 = 0; i < 
Şd_node
->
num_keys
; i++, j++) {

168 ià(
j
 =ğ
Ëá_šdex
) j++;

169 
‹mp_keys
[
j
] = 
	`INTERNAL_KEY
(
Şd_node
, 
i
);

172 
‹mp_poš‹rs
[
Ëá_šdex
 + 1] = 
right_off£t
;

173 
‹mp_keys
[
Ëá_šdex
] = 
key
;

178 
¥l™
 = 
	`cut
(
Üd”_š‹º®
);

180 
IÁ”ÇlPage
* 
Ãw_node
 = (IÁ”ÇlPage*)
	`®loc_·ge
(
bË
);

181 
Ãw_node
->
num_keys
 = 0;

182 
Ãw_node
->
is_Ëaf
 = 0;

184 
Şd_node
->
num_keys
 = 0;

185 
i
 = 0; i < 
¥l™
 - 1; i++) {

186 
	`INTERNAL_OFFSET
(
Şd_node
, 
i
èğ
‹mp_poš‹rs
[i];

187 
	`INTERNAL_KEY
(
Şd_node
, 
i
èğ
‹mp_keys
[i];

188 
Şd_node
->
num_keys
++;

190 
	`INTERNAL_OFFSET
(
Şd_node
, 
i
èğ
‹mp_poš‹rs
[i];

191 
k_´ime
 = 
‹mp_keys
[
¥l™
 - 1];

192 ++
i
, 
j
 = 0; i < 
Üd”_š‹º®
; i++, j++) {

193 
	`INTERNAL_OFFSET
(
Ãw_node
, 
j
èğ
‹mp_poš‹rs
[
i
];

194 
	`INTERNAL_KEY
(
Ãw_node
, 
j
èğ
‹mp_keys
[
i
];

195 
Ãw_node
->
num_keys
++;

197 
	`INTERNAL_OFFSET
(
Ãw_node
, 
j
èğ
‹mp_poš‹rs
[
i
];

198 
	`ä“
(
‹mp_poš‹rs
);

199 
	`ä“
(
‹mp_keys
);

200 
Ãw_node
->
·»Á
 = 
Şd_node
->parent;

201 
i
 = 0; i <ğ
Ãw_node
->
num_keys
; i++) {

202 
NodePage
* 
chd_·ge
 =

203 (
NodePage
*è
	`g‘_·ge
(
bË
,

204 
	`FILEOFF_TO_PAGENUM
(
	`INTERNAL_OFFSET
(
Ãw_node
, 
i
)));

206 
chd_·ge
->
·»Á
 = 
	`PAGENUM_TO_FILEOFF
(
Ãw_node
->
·g’um
);

207 
	`£t_dœty_·ge
((
Page
*)
chd_·ge
);

208 
	`»Ëa£_·ge
((
Page
*)
chd_·ge
);

212 
i
 = 
Şd_node
->
num_keys
; i < 
Üd”_š‹º®
 - 1; i++) {

213 
	`INTERNAL_OFFSET
(
Şd_node
, 
i
+1) = 0;

214 
	`INTERNAL_KEY
(
Şd_node
, 
i
) = 0;

217 
i
 = 
Ãw_node
->
num_keys
; i < 
Üd”_š‹º®
 - 1; i++) {

218 
	`INTERNAL_OFFSET
(
Ãw_node
, 
i
+1) = 0;

219 
	`INTERNAL_KEY
(
Ãw_node
, 
i
) = 0;

225 
	`š£¹_što_·»Á
(
bË
, (
NodePage
*)
Şd_node
, 
k_´ime
, (NodePage*)
Ãw_node
);

227 
	`»Ëa£_·ge
((
Page
*)
Ãw_node
);

228 
	}
}

233 
	$š£¹_što_·»Á
(
TabË
* 
bË
, 
NodePage
* 
Ëá
, 
št64_t
 
key
, NodePage* 
right
) {

234 
Ëá_šdex
;

235 
IÁ”ÇlPage
* 
·»Á_node
;

238 ià(
Ëá
->
·»Á
 == 0) {

239 
	`š£¹_što_Ãw_roÙ
(
bË
, 
Ëá
, 
key
, 
right
);

243 
·»Á_node
 = (
IÁ”ÇlPage
*è
	`g‘_·ge
(
bË
, 
	`FILEOFF_TO_PAGENUM
(
Ëá
->
·»Á
));

244 
	`£t_dœty_·ge
((
Page
*)
·»Á_node
);

251 
Ëá_šdex
 = 
	`g‘_Ëá_šdex
(
bË
, 
·»Á_node
,

252 
	`PAGENUM_TO_FILEOFF
(
Ëá
->
·g’um
));

256 ià(
·»Á_node
->
num_keys
 < 
Üd”_š‹º®
 - 1) {

257 
	`š£¹_što_node
(
bË
, 
·»Á_node
, 
Ëá_šdex
, 
key
,

258 
	`PAGENUM_TO_FILEOFF
(
right
->
·g’um
));

259 
	`»Ëa£_·ge
((
Page
*)
·»Á_node
);

266 
	`š£¹_što_node_aá”_¥l™tšg
(
bË
, 
·»Á_node
, 
Ëá_šdex
, 
key
,

267 
	`PAGENUM_TO_FILEOFF
(
right
->
·g’um
));

268 
	`»Ëa£_·ge
((
Page
*)
·»Á_node
);

269 
	}
}

274 
	$š£¹_što_Ãw_roÙ
(
TabË
* 
bË
, 
NodePage
* 
Ëá
, 
št64_t
 
key
, NodePage* 
right
) {

276 
IÁ”ÇlPage
* 
roÙ_node
 = (IÁ”ÇlPage*)
	`®loc_·ge
(
bË
);

277 
	`INTERNAL_KEY
(
roÙ_node
, 0èğ
key
;

278 
	`INTERNAL_OFFSET
(
roÙ_node
, 0èğ
	`PAGENUM_TO_FILEOFF
(
Ëá
->
·g’um
);

279 
	`INTERNAL_OFFSET
(
roÙ_node
, 1èğ
	`PAGENUM_TO_FILEOFF
(
right
->
·g’um
);

280 
roÙ_node
->
num_keys
++;

281 
roÙ_node
->
·»Á
 = 0;

282 
roÙ_node
->
is_Ëaf
 = 0;

283 
Ëá
->
·»Á
 = 
	`PAGENUM_TO_FILEOFF
(
roÙ_node
->
·g’um
);

284 
right
->
·»Á
 = 
	`PAGENUM_TO_FILEOFF
(
roÙ_node
->
·g’um
);

286 
bË
->
dbh—d”
.
roÙ_off£t
 = 
	`PAGENUM_TO_FILEOFF
(
roÙ_node
->
·g’um
);

288 
	`»Ëa£_·ge
((
Page
*)
roÙ_node
);

289 
	}
}

292 
	$¡¬t_Ãw_Œ“
(
TabË
* 
bË
, 
št64_t
 
key
, iÁ64_t* 
v®ue
) {

293 
L—fPage
* 
roÙ_node
 = (L—fPage*)
	`®loc_·ge
(
bË
);

294 
roÙ_node
->
·»Á
 = 0;

295 
roÙ_node
->
is_Ëaf
 = 1;

296 
roÙ_node
->
num_keys
 = 1;

297 
	`LEAF_KEY
(
roÙ_node
, 0èğ
key
;

298 
roÙ_node
->
siblšg
 = 0;

299 
	`memıy
(
	`LEAF_VALUE
(
roÙ_node
, 0), 
v®ue
, 
SIZE_VALUE
);

301 
bË
->
dbh—d”
.
roÙ_off£t
 = 
	`PAGENUM_TO_FILEOFF
(
roÙ_node
->
·g’um
);

302 
	`£t_dœty_·ge
((
Page
*)&
bË
->
dbh—d”
);

304 
	`»Ëa£_·ge
((
Page
*)
roÙ_node
);

305 
	}
}

311 
	$š£¹_»cÜd
(
TabË
* 
bË
, 
št64_t
 
key
, iÁ64_t* 
v®ue
) {

312 
št64_t
* 
v®ue_found
 = 
NULL
;

316 ià((
v®ue_found
 = 
	`fšd_»cÜd
(
bË
, 
key
)) != 0) {

317 
	`ä“
(
v®ue_found
);

323 ià(
bË
->
dbh—d”
.
roÙ_off£t
 == 0) {

324 
	`¡¬t_Ãw_Œ“
(
bË
, 
key
, 
v®ue
);

330 
L—fPage
* 
Ëaf_node
;

331 
	`fšd_Ëaf
(
bË
, 
key
, &
Ëaf_node
);

335 ià(
Ëaf_node
->
num_keys
 < 
Üd”_Ëaf
 - 1) {

336 
	`š£¹_što_Ëaf
(
bË
, 
Ëaf_node
, 
key
, 
v®ue
);

340 
	`š£¹_što_Ëaf_aá”_¥l™tšg
(
bË
, 
Ëaf_node
, 
key
, 
v®ue
);

342 
	`£t_dœty_·ge
((
Page
*)
Ëaf_node
);

343 
	`»Ëa£_·ge
((
Page
*)
Ëaf_node
);

345 
	}
}

	@src/lock.cpp

1 
	~"lock.h
"

3 
LockMªag”
 
	glock_sys
;

11 
boŞ
 
	gLockMªag”
::
	$lock_»c_has_lock
(
Œx_t
* 
Œx
, 
bË_id
, 
·g’um_t
 
·ge_id
,

12 
št64_t
 
key
, 
LockMode
 
mode
, 
lock_t
** 
äÚt_lock_±r
) {

14 autØ
™
 = 
lock_bË
[
·ge_id
].
lock_li¡
.
	`begš
(); iˆ!ğlock_bË[·ge_id].lock_li¡.
	`’d
(); ++it) {

16 ià(
™
 -> 
key
 =ğkey && iˆ-> 
bË_id
 ==able_id) {

18 *
äÚt_lock_±r
 = &(*
™
);

20 
lock_t
* 
lock
 = *
äÚt_lock_±r
; (lock &&†ock -> 
acquœed
);) {

21 ià(
lock
 -> 
Œx
 -> 
	`g‘T¿n§ùiÚId
(è=ğŒx -> g‘T¿n§ùiÚId(è&& 
	`lock_mode_¡rÚg”_Ü_eq
Öock -> 
lock_mode
, 
mode
)) {

22  
Œue
;

24 
lock
 =†ock -> 
Ãxt
;

28  
çl£
;

29 
	}
}

36 
lock_t
* 
	gLockMªag”
::
	$lock_»c_ü—‹
(
Œx_t
* 
Œx
, 
bË_id
, 
·g’um_t
 
·ge_id
,

37 
št64_t
 
key
, 
LockMode
 
mode
, 
lock_t
* 
_lock_±r
) {

38 
lock_t
 
	`lock_»q
(
bË_id
, 
Œx
, 
·ge_id
, 
key
, 
mode
);

39 
lock_bË
[
·ge_id
].
lock_li¡
.
	`push_back
(
lock_»q
);

40 
lock_t
* 
lock_±r
 = &(
lock_bË
[
·ge_id
].
lock_li¡
.
	`back
());

42 ià(
_lock_±r
) {

43 
lock_±r
 -> 
´ev
 = 
_lock_±r
;

44 
_lock_±r
 -> 
Ãxt
 = 
lock_±r
;

46  
lock_±r
;

47 
	}
}

56 
	gLockMªag”
::
	$lock_wa™_»c_add_to_queue
(
Œx_t
* 
Œx
, 
bË_id
, 
·g’um_t
 
·ge_id
, 
št64_t
 
key
, 
LockMode
 
mode
,

57 
lock_t
* 
äÚt_lock_±r
,†ock_t* 
wa™_lock
) {

59 
Œx
->
	`Œx_mu‹x_’‹r
();

60 
lock_t
* 
_lock_±r
 = 
nuÎ±r
;

62 
lock_t
* 
lock
 = 
äÚt_lock_±r
;†ock !ğ
nuÎ±r
;){

63 
_lock_±r
 = 
lock
;

64 
lock
 =†ock -> 
Ãxt
;

67 
lock_t
* 
lock_±r
 = 
	`lock_»c_ü—‹
(
Œx
, 
bË_id
, 
·ge_id
, 
key
, 
mode
, 
_lock_±r
);

68 
lock_±r
 -> 
acquœed
 = 
çl£
;

70 ià(
Œx
 -> 
	`g‘_wa™_lock
())

71 
	`PANIC
("In†ock wait„ec‡ddo queue. It‡lready have wait†ock.\n");

73 
Œx
 -> 
	`£t_wa™_lock
(
wa™_lock
);

74 
	}
}

83 
	gLockMªag”
::
	$lock_g¿Áed_»c_add_to_queue
(
Œx_t
* 
Œx
, 
bË_id
, 
·g’um_t
 
·ge_id
, 
št64_t
 
key
,

84 
LockMode
 
mode
, 
lock_t
* 
äÚt_lock_±r
) {

86 
lock_t
* 
_lock_±r
 = 
nuÎ±r
;

87 
lock_t
* 
lock
 = 
äÚt_lock_±r
;†ock !ğ
nuÎ±r
;) {

88 
_lock_±r
 = 
lock
;

89 
lock
 =†ock -> 
Ãxt
;

92 
lock_t
* 
lock_±r
 = 
	`lock_»c_ü—‹
(
Œx
, 
bË_id
, 
·ge_id
, 
key
, 
mode
, 
_lock_±r
);

93 
lock_±r
 -> 
acquœed
 = 
Œue
;

94 
Œx
 -> 
	`push_acquœed_lock
(
lock_±r
);

95 
	}
}

102 
boŞ
 
	gLockMªag”
::
	$lock_»c_has_cÚæiù
(
Œx_t
* 
Œx
, 
bË_id
, 
·g’um_t
 
·ge_id
, 
št64_t
 
key
, 
LockMode
 
mode
,

103 
lock_t
* 
äÚt_lock_±r
,†ock_t** 
wa™_lock
) {

105 ià(!
äÚt_lock_±r
)

106  
çl£
;

108 
lock_t
* 
lock
 = 
äÚt_lock_±r
;†ock !ğ
nuÎ±r
;) {

109 ià(
lock
 -> 
Œx
 -> 
	`g‘T¿n§ùiÚId
() !=rx -> getTransactionId() &&

110 !
	`lock_mode_com·tibË
(
lock
 -> 
lock_mode
, 
mode
)) {

111 *
wa™_lock
 = 
lock
;

113 
lock
 =†ock -> 
Ãxt
;

116 ià(*
wa™_lock
){

117  
Œue
;

119  
çl£
;

120 
	}
}

127 
	g¡d
::
veùÜ
<> 
LockMªag”
::
	$lock_wa™_fÜ
(
Œx_t
* 
Œx
, 
lock_t
* 
äÚt_lock_±r
,†ock_t* 
wa™_lock
, 
LockMode
 
mode
) {

128 
¡d
::
veùÜ
<> 
wa™_fÜ
;

130 
lock_t
* 
lock
 = 
äÚt_lock_±r
;†ock !ğ
wa™_lock
;) {

131 ià(
lock
 -> 
Œx
 -> 
	`g‘T¿n§ùiÚId
() !=rx -> getTransactionId() &&

132 !
	`lock_mode_com·tibË
(
lock
 -> 
lock_mode
, 
mode
))

133 
wa™_fÜ
.
	`push_back
(
lock
 -> 
Œx
 -> 
	`g‘T¿n§ùiÚId
());

134 
lock
 =†ock -> 
Ãxt
;

137 
wa™_fÜ
.
	`push_back
(
wa™_lock
 -> 
Œx
 -> 
	`g‘T¿n§ùiÚId
());

138  
wa™_fÜ
;

139 
	}
}

150 
	gLockMªag”
::
	$acquœe_lock
(
Œx_t
* 
Œx
, 
bË_id
, 
·g’um_t
 
·ge_id
, 
št64_t
 
key
, 
LockMode
 
mode
) {

152 
LOCK_SYS_MUTEX_ENTER
;

153 
TabË
* 
bË
 = 
	`g‘_bË
(
bË_id
);

155 ià(
Œx
->
	`g‘S‹
(è!ğ
RUNNING
)

156 
	`PANIC
("Cannot‡cquire†ock in other mode.\n");

158 
wa™šg_fÜ_Œx_id
 = -1;

159 
lock_t
* 
äÚt_lock_±r
 = 
nuÎ±r
;

160 
lock_t
* 
wa™_lock
 = 
nuÎ±r
;

161 
lock_t
* 
lock_±r
 = 
nuÎ±r
;

166 ià(
	`lock_»c_has_lock
(
Œx
, 
bË_id
, 
·ge_id
, 
key
, 
mode
, &
äÚt_lock_±r
))

167  
LOCK_SUCCESS
;

173 ià(!
	`lock_»c_has_cÚæiù
(
Œx
, 
bË_id
, 
·ge_id
, 
key
, 
mode
, 
äÚt_lock_±r
, &
wa™_lock
)){

174 
	`lock_g¿Áed_»c_add_to_queue
(
Œx
, 
bË_id
, 
·ge_id
, 
key
, 
mode
, 
äÚt_lock_±r
);

175  
LOCK_SUCCESS
;

183 ià(
dl_check”
.
	`d—dlock_checkšg
(
Œx
 -> 
	`g‘T¿n§ùiÚId
(), 
	`lock_wa™_fÜ
Ñrx, 
äÚt_lock_±r
, 
wa™_lock
, 
mode
))) {

184 
Œx
 -> 
	`£tS‹
(
ABORTED
);

185 
	`»Ëa£_lock_abÜ‹d
(
Œx
);

186  
DEADLOCK
;

189 
	`lock_wa™_»c_add_to_queue
(
Œx
, 
bË_id
, 
·ge_id
, 
key
, 
mode
, 
äÚt_lock_±r
, 
wa™_lock
);

190  
LOCK_WAIT
;

193 
	`PANIC
("In‡cquire†ock. Unknownƒvent.\n");

194 
	}
}

205 cÚ¡ 
boŞ
 
	gLockMªag”
::
	$lock_mode_com·tibË
(
LockMode
 
lock_mode1
, LockMod
lock_mode2
) {

206  (
lock_com·tib™y_m©rix
[
lock_mode1
][
lock_mode2
]);

207 
	}
}

219 cÚ¡ 
boŞ
 
	gLockMªag”
::
	$lock_mode_¡rÚg”_Ü_eq
(
LockMode
 
lock_mode1
, LockMod
lock_mode2
) {

220  (
lock_¡»ngth_m©rix
[
lock_mode1
][
lock_mode2
]);

221 
	}
}

231 
	gLockMªag”
::
	$lock_g¿Á
(
lock_t
* 
lock_±r
) {

232 
lock_±r
 -> 
Œx
 -> 
	`Œx_mu‹x_’‹r
();

234 
lock_±r
 -> 
acquœed
 = 
Œue
;

235 
lock_±r
 -> 
Œx
 -> 
	`push_acquœed_lock
(lock_ptr);

237 
lock_±r
 -> 
Œx
 -> 
	`Œx_wa™_»Ëa£
();

238 
lock_±r
 -> 
Œx
 -> 
	`Œx_mu‹x_ex™
();

239 
	}
}

246 
boŞ
 
	gLockMªag”
::
	$¡l_lock_wa™
(
lock_t
* 
lock
) {

247 
wa™_fÜ_Œx_id
 = 
dl_check”
.
	`g‘_wa™_lock_Œx_id
(
lock
 -> 
Œx
 -> 
	`g‘T¿n§ùiÚId
());

249 ià(
wa™_fÜ_Œx_id
 =ğ
NO_WAIT_LOCK
) {

250 
lock
 -> 
Œx
 -> 
	`£t_wa™_lock
(
nuÎ±r
);

251  
çl£
;

254 
lock_t
* 
´ev
 = 
lock
 ->…»v;…»v !ğ
nuÎ±r
;) {

255 ià(
´ev
 -> 
Œx
 -> 
	`g‘T¿n§ùiÚId
(è=ğ
wa™_fÜ_Œx_id
) {

256 
lock
 -> 
Œx
 -> 
	`£t_wa™_lock
(
´ev
);

257  
Œue
;

261 
	`PANIC
("In still†ock wait. Thisransaction should wait for otherransaction but it doesn't.\n");

262 
	}
}

273 
	gLockMªag”
::
	$rŞlback_d©a
(
Œx_t
* 
Œx
) {

275 
BUF_POOL_MUTEX_ENTER
;

277 
L—fPage
* 
Ëaf_node
 = 
nuÎ±r
;

278 
TabË
* 
bË
 = 
nuÎ±r
;

279 
¡d
::
li¡
<
undo_log
> 
undo_log_li¡
 = 
Œx
 -> 
	`g‘_undo_log_li¡
();

281 
boŞ
 
æag
;

283 autØ
r™
 = 
undo_log_li¡
.
	`rbegš
();„™ !ğundo_log_li¡.
	`»nd
(); ++rit) {

284 
æag
 = 
çl£
;

285 
Ëaf_node
 = 
nuÎ±r
;

286 
bË
 = 
	`g‘_bË
(
r™
 -> 
bË_id
);

288 
Ëaf_node
 = (
L—fPage
*)
	`g‘_·ge
(
bË
, 
r™
 -> 
·ge_id
);

290 
i
 = 0; i < 
Ëaf_node
 -> 
num_keys
; i++) {

291 ià(
	`LEAF_KEY
(
Ëaf_node
, 
i
è=ğ
r™
 -> 
key
) {

292 
	`memıy
(
	`LEAF_VALUE
(
Ëaf_node
, 
i
), 
r™
 -> 
undo_v®ue
, 
SIZE_VALUE
);

293 
	`»Ëa£_·ge
((
Page
*)
Ëaf_node
);

294 
æag
 = 
Œue
;

299 ià(!
æag
)

300 
	`PANIC
("In„ollback_data. Cannot findhe given key.\n");

303 
BUF_POOL_MUTEX_EXIT
;

304 
	}
}

315 
	gLockMªag”
::
	$»Ëa£_lock_abÜ‹d_low
(
Œx_t
* 
Œx
, 
lock_t
* 
lock_±r
) {

316 
·ge_id
 = 
lock_±r
 ->…age_id;

317 ià(
lock_±r
 -> 
´ev
)

318 
lock_±r
 -> 
´ev
 -> 
Ãxt
 =†ock_ptr ->‚ext;

319 ià(
lock_±r
 -> 
Ãxt
)

320 
lock_±r
 -> 
Ãxt
 -> 
´ev
 =†ock_ptr ->…rev;

322 
lock_t
* 
lock
 = 
lock_±r
 -> 
Ãxt
;†ock !ğ
nuÎ±r
;) {

323 ià(
lock
 -> 
Œx
 -> 
	`g‘_wa™_lock
(è=ğ
lock_±r
 && !
	`¡l_lock_wa™
(lock)) {

324 
	`lock_g¿Á
(
lock
);

326 
lock
 =†ock -> 
Ãxt
;

328 
boŞ
 
æag
 = 
Œue
;

330 autØ
™
 = 
lock_bË
[
·ge_id
].
lock_li¡
.
	`begš
(); iˆ!ğlock_bË[·ge_id].lock_li¡.
	`’d
(); ++it) {

331 ià(&(*
™
è=ğ
lock_±r
) {

332 
lock_bË
[
·ge_id
].
lock_li¡
.
	`”a£
(
™
);

333 
æag
 = 
çl£
;

338 ià(
æag
)

339 
	`PANIC
("In„elease_lock_low. Cannotƒrase†ock„equest in†ist).\n");

341 
	}
}

350 
boŞ
 
	gLockMªag”
::
	$»Ëa£_lock_abÜ‹d
(
Œx_t
* 
Œx
) {

351 
	`rŞlback_d©a
(
Œx
);

352 cÚ¡ 
¡d
::
li¡
<
lock_t
*> 
acquœed_lock
 = 
Œx
 -> 
	`g‘AcquœedLock
();

354 autØ
r™
 = 
acquœed_lock
.
	`rbegš
();„™ !ğacquœed_lock.
	`»nd
(); ++rit) {

355 
	`»Ëa£_lock_abÜ‹d_low
(
Œx
, *
r™
);

358  
Œue
;

359 
	}
}

369 
	gLockMªag”
::
	$»Ëa£_lock_low
(
Œx_t
* 
Œx
, 
lock_t
* 
lock_±r
) {

370 
·ge_id
 = 
lock_±r
 ->…age_id;

371 ià(
lock_±r
 -> 
´ev
)

372 
lock_±r
 -> 
´ev
 -> 
Ãxt
 =†ock_ptr ->‚ext;

373 ià(
lock_±r
 -> 
Ãxt
)

374 
lock_±r
 -> 
Ãxt
 -> 
´ev
 =†ock_ptr ->…rev;

376 
lock_t
* 
lock
 = 
lock_±r
 -> 
Ãxt
;†ock !ğ
nuÎ±r
;) {

377 ià(
lock
 -> 
Œx
 -> 
	`g‘_wa™_lock
(è=ğ
lock_±r
 && !
	`¡l_lock_wa™
(lock)) {

378 
	`lock_g¿Á
(
lock
);

380 
lock
 =†ock -> 
Ãxt
;

382 
boŞ
 
æag
 = 
Œue
;

384 autØ
™
 = 
lock_bË
[
·ge_id
].
lock_li¡
.
	`begš
(); iˆ!ğlock_bË[·ge_id].lock_li¡.
	`’d
(); ++it) {

385 ià(&(*
™
è=ğ
lock_±r
) {

386 
lock_bË
[
·ge_id
].
lock_li¡
.
	`”a£
(
™
);

387 
æag
 = 
çl£
;

392 ià(
æag
)

393 
	`PANIC
("In„elease_lock_low. Cannotƒrase†ock„equest in†ist.\n");

395 
	}
}

403 
boŞ
 
	gLockMªag”
::
	$»Ëa£_lock
(
Œx_t
* 
Œx
) {

404 
LOCK_SYS_MUTEX_ENTER
;

406 
dl_check”
.
	`d–‘e_wa™šg_fÜ_Œx
(
Œx
->
	`g‘T¿n§ùiÚId
());

408 cÚ¡ 
¡d
::
li¡
<
lock_t
*> 
acquœed_lock
 = 
Œx
->
	`g‘AcquœedLock
();

409 autØ
™
 = 
acquœed_lock
.
	`begš
(); iˆ!ğacquœed_lock.
	`’d
(); ++it) {

410 
	`»Ëa£_lock_low
(
Œx
, *
™
);

412  
Œue
;

413 
	}
}

	@src/main.cpp

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<fú.h
>

4 
	~<uni¡d.h
>

5 
	~<sys/ty³s.h
>

6 
	~<š‰y³s.h
>

7 
	~"b±.h
"

8 
	~"fe.h
"

11 
	$maš
Ğ
¬gc
, ** 
¬gv
 ) {

12 
št64_t
 
šput_key
;

13 
št64_t
 
šput_v®ue
[
SIZE_COLUMN
];

14 
š¡ruùiÚ
;

15 
bË_id
;

18 
	`liûn£_nÙiû
();

19 
	`u§ge_1
();

20 
	`u§ge_2
();

22 
	`š™_db
(1000);

23 
bË_id
 = 
	`İ’_bË
("test.db", 15);

24 
	`´št_Œ“
(
bË_id
);

25 
	`´štf
("> ");

26 
	`sÿnf
("%c", &
š¡ruùiÚ
è!ğ
EOF
) {

27 
š¡ruùiÚ
) {

30 
	`š£¹
(
bË_id
, 
šput_key
, 
šput_v®ue
);

31 
	`´št_Œ“
(
bË_id
);

34 
	`sÿnf
("%" 
PRIu64
 "", &
šput_key
);

35 
	`»move
(
bË_id
, 
šput_key
);

36 
	`´št_Œ“
(
bË_id
);

40 
	`sÿnf
("%" 
PRIu64
 "", &
šput_key
);

41 
	`fšd_ªd_´št
(
bË_id
, 
šput_key
);

44 
	`g‘ch¬
() != ()'\n');

45 
	`şo£_bË
(
bË_id
);

46 
	`shutdown_db
();

47  
EXIT_SUCCESS
;

50 
	`´št_Œ“
(
bË_id
);

53 
	`u§ge_2
();

56 
	`g‘ch¬
() != ()'\n');

57 
	`´štf
("> ");

59 
	`´štf
("\n");

61 
	`şo£_bË
(
bË_id
);

62 
	`shutdown_db
();

64  
EXIT_SUCCESS
;

65 
	}
}

	@src/table.cpp

1 
	~"b±_š‹º®.h
"

3 
TabË
 
	gbËs
[
MAX_NUM_TABLE
];

9 
	$®loc_bË
() {

10 
i
 = 0; i < 
MAX_NUM_TABLE
; i++){

11 ià(
bËs
[
i
].
bË_id
 == 0){

12 
bËs
[
i
].
bË_id
 = i+1;

13  
i
+1;

16 
	`PANIC
("Allocable†imit.");

18 
	}
}

20 
TabË
* 
	$g‘_bË
(
bË_id
) {

21 ià(
bË_id
 <= 0){

22 
	`PANIC
("get_table");

24  &
bËs
[
bË_id
-1];

25 
	}
}

28 
	$İ’_Ü_ü—‹_bË_fe
(cÚ¡ * 
f’ame
, 
num_cŞumn
) {

29 
bË_id
 = 
	`®loc_bË
();

30 
TabË
* 
bË
;

32 ià(
bË_id
 <= 0){

35 
bË
 = 
	`g‘_bË
(
bË_id
);

36 
bË
->
dbfe
 = 
	`İ’
(
f’ame
, 
O_RDWR
);

37 ià(
bË
->
dbfe
 < 0) {

39 
bË
->
dbfe
 = 
	`İ’
(
f’ame
, 
O_CREAT
|
O_RDWR
, 
S_IRUSR
|
S_IWUSR
);

40 ià(
bË
->
dbfe
 < 0) {

41 
	`PANIC
("failedo create‚ew db file");

43 
	`š™_Ãw_h—d”_·ge
(&
bË
->
dbh—d”
, 
bË_id
, 
num_cŞumn
);

46 
	`lßd_h—d”_·ge
(
bË
);

48  
bË_id
;

49 
	}
}

52 
	$şo£_bË_fe
(
TabË
* 
bË
) {

53 
	`»Ëa£_h—d”_·ge
(
bË
);

54 
	`şo£
(
bË
->
dbfe
);

55 
bË
->
dbfe
 = 0;

56 
bË
->
bË_id
 = 0;

58 
	}
}

	@src/test.cpp

1 
	~<¡dio.h
>

2 
	~<¡dlib.h
>

3 
	~<fú.h
>

4 
	~<uni¡d.h
>

5 
	~<sys/ty³s.h
>

6 
	~<š‰y³s.h
>

7 
	~<th»ad
>

8 
	~<¡dlib.h
>

10 
	~<io¡»am
>

11 
	~<veùÜ
>

12 
	~<io¡»am
>

13 
	~"b±.h
"

14 
	~"fe.h
"

16 
usšg
 
Çme¥aû
 
	g¡d
;

18 
št64_t
 
	gf_upd©e_v®ue
[
SIZE_COLUMN
];

19 
št64_t
 
	gs_upd©e_v®ue
[
SIZE_COLUMN
];

21 
	$sh¬ed_lock
(
bË_id
, 
key
, 
Œx_id
, * 
»suÉ
) {

22 
št64_t
* 
»t
 = 
	`fšd
(
bË_id
, 
key
, 
Œx_id
, 
»suÉ
);

23 
cout
 << "SHARED TRX ID : " << 
Œx_id
 << " READ" << 
’dl
;

24 
i
 = 0; i < 15; ++i)

25 
cout
 << 
»t
[
i
] << ' ';

26 
cout
 << 
’dl
;

27 ià(*
»suÉ
 == 0)

28 
cout
 << "AbÜ‹d Now" << 
’dl
;

29 
cout
 << "-----------" << 
’dl
;

30 
	}
}

32 
	$exşusive_lock
(
bË_id
, 
key
, 
št64_t
* 
šput_v®ue
, 
Œx_id
, * 
»suÉ
) {

33 
»t
 = 
	`upd©e
(
bË_id
, 
key
, 
šput_v®ue
, 
Œx_id
, 
»suÉ
);

34 
cout
 << "EXCLUSIVE TRX ID : " << 
Œx_id
 << "wr™e" << 
’dl
;

35 ià(*
»suÉ
 == 0)

36 
cout
 << "AbÜ‹d Now" << 
’dl
;

37 
cout
 << "----------------" << 
’dl
;

38 
	}
}

40 
	$’d_Œx
(
Œx_id
){

41 
i
 = 
	`’d_tx
(
Œx_id
);

42 
cout
 << "END TRX ID : " << 
Œx_id
;

43 ià(
i
 == -1)

44 
cout
 << " ABORTED";

46 
cout
 << " COMMITTED";

47 
cout
 << "----------------" << 
’dl
;

48 
	}
}

50 
	$maš
Ğ
¬gc
, ** 
¬gv
 ) {

51 
ios_ba£
::
	`sync_w™h_¡dio
(
çl£
);

52 
št64_t
 
šput_key
;

53 
»suÉ
 = 0;

54 
i
 = 0; i < 
SIZE_COLUMN
; ++i){

55 
f_upd©e_v®ue
[
i
] = 5000+i;

56 
s_upd©e_v®ue
[
i
] = 100+i;

59 
bË_id
;

60 
	`š™_db
(1000);

61 
f_»suÉ
 = 0;

62 
s_»suÉ
 = 0;

63 
t_»suÉ
 = 0;

64 
fo_»suÉ
 = 0;

66 
bË_id
 = 
	`İ’_bË
("test1_10.db", 15);

67 autØ
‹¡1
 = [&]() {

68 
cout
 << ">> Fœ¡ ScheduË : RecÜd 1 : RÑ1èWÑ2èWÑ1)" << 
’dl
;

69 
f_Œx_id
 = 
	`begš_tx
();

70 
s_Œx_id
 = 
	`begš_tx
();

72 
th»ad
 
	`fœ¡_s
(
sh¬ed_lock
, 
bË_id
, 1, 
f_Œx_id
, &
f_»suÉ
);

73 
fœ¡_s
.
	`još
();

74 
th»ad
 
	`£cÚd_x
(
exşusive_lock
, 
bË_id
, 1, 
s_upd©e_v®ue
, 
s_Œx_id
, &
s_»suÉ
);

75 
th»ad
 
	`fœ¡_x
(
exşusive_lock
, 
bË_id
, 1, 
f_upd©e_v®ue
, 
f_Œx_id
, &
f_»suÉ
);

76 
fœ¡_x
.
	`još
();

78 
£cÚd_x
.
	`još
();

79 
th»ad
 
	`fœ¡_e
(
’d_Œx
, 
f_Œx_id
);

80 
fœ¡_e
.
	`još
();

81 
th»ad
 
	`£cÚd_e
(
’d_Œx
, 
s_Œx_id
);

82 
£cÚd_e
.
	`još
();

84 
cout
 << "<< Fœ¡ ScheduË dÚe" << 
’dl
;

87 autØ
‹¡2
 = [&]() {

89 
cout
 << ">> SecÚd ScheduË : RecÜd 1 : WÑ1èWÑ2èRÑ1èRÑ2)" << 
’dl
;

90 
f_Œx_id
 = 
	`begš_tx
();

91 
s_Œx_id
 = 
	`begš_tx
();

92 
th»ad
 
	`fœ¡_x
(
exşusive_lock
, 
bË_id
, 1, 
f_upd©e_v®ue
, 
f_Œx_id
, &
f_»suÉ
);

93 
fœ¡_x
.
	`još
();

94 
th»ad
 
	`£cÚd_x
(
exşusive_lock
, 
bË_id
, 1, 
s_upd©e_v®ue
, 
s_Œx_id
, &
s_»suÉ
);

95 
th»ad
 
	`fœ¡_s
(
sh¬ed_lock
, 
bË_id
, 1, 
f_Œx_id
, &
f_»suÉ
);

96 
fœ¡_s
.
	`još
();

97 
th»ad
 
	`fœ¡_e
(
’d_Œx
, 
f_Œx_id
);

98 
fœ¡_e
.
	`još
();

99 
£cÚd_x
.
	`još
();

100 
th»ad
 
	`£cÚd_s
(
sh¬ed_lock
, 
bË_id
, 1, 
s_Œx_id
, &
s_»suÉ
);

101 
£cÚd_s
.
	`još
();

102 
th»ad
 
	`£cÚd_e
(
’d_Œx
, 
s_Œx_id
);

103 
£cÚd_e
.
	`još
();

104 
cout
 << "<< SecÚd scheduË dÚe" << 
’dl
;

107 autØ
‹¡3
 = [&](){

108 
cout
 << ">> Thœd ScheduË : RecÜd 1 : WÑ1è RÑ2)" << 
’dl
;

109 
cout
 << ">> RecÜd 2 : WÑ2è WÑ1)" << 
’dl
;

110 
f_Œx_id
 = 
	`begš_tx
();

111 
s_Œx_id
 = 
	`begš_tx
();

112 
th»ad
 
	`fœ¡_x
(
exşusive_lock
, 
bË_id
, 1, 
f_upd©e_v®ue
, 
f_Œx_id
, &
f_»suÉ
);

113 
fœ¡_x
.
	`još
();

114 
th»ad
 
	`£cÚd_x
(
exşusive_lock
, 
bË_id
, 2, 
s_upd©e_v®ue
, 
s_Œx_id
, &
s_»suÉ
);

115 
£cÚd_x
.
	`još
();

116 
th»ad
 
	`£cÚd_s_s2
(
sh¬ed_lock
, 
bË_id
, 1,
s_Œx_id
, &
s_»suÉ
);

117 
	`u¦“p
(5000);

118 
th»ad
 
	`fœ¡_x_2
(
exşusive_lock
, 
bË_id
, 2, 
f_upd©e_v®ue
, 
f_Œx_id
, &
f_»suÉ
);

119 
fœ¡_x_2
.
	`još
();

120 
th»ad
 
	`fœ¡_e
(
’d_Œx
, 
f_Œx_id
);

121 
fœ¡_e
.
	`još
();

122 
£cÚd_s_s2
.
	`još
();

123 
th»ad
 
	`£cÚd_s
(
sh¬ed_lock
, 
bË_id
, 1, 
s_Œx_id
, &
s_»suÉ
);

124 
£cÚd_s
.
	`još
();

125 
th»ad
 
	`£cÚd_s_2
(
sh¬ed_lock
, 
bË_id
, 2, 
s_Œx_id
, &
s_»suÉ
);

126 
£cÚd_s_2
.
	`još
();

127 
th»ad
 
	`£cÚd_e
(
’d_Œx
, 
s_Œx_id
);

128 
£cÚd_e
.
	`još
();

129 
cout
 << "<< Thœd scheduË dÚe" << 
’dl
;

132 autØ
‹¡4
 = [&]() {

133 
cout
 << ">> FÜuth ScheduË : RecÜd 1 : SÑ1èSÑ2èSÑ3èWÑ4)" << 
’dl
;

134 
fi_Œx_id
 = 
	`begš_tx
();

135 
£_Œx_id
 = 
	`begš_tx
();

136 
th_Œx_id
 = 
	`begš_tx
();

137 
fo_Œx_id
 = 
	`begš_tx
();

138 
th»ad
 
	`fi_s
(
sh¬ed_lock
, 
bË_id
, 1, 
fi_Œx_id
, &
f_»suÉ
);

140 
fi_s
.
	`još
();

141 
th»ad
 
	`£_s
(
sh¬ed_lock
, 
bË_id
, 1, 
£_Œx_id
, &
s_»suÉ
);

143 
£_s
.
	`još
();

144 
th»ad
 
	`th_s
(
sh¬ed_lock
, 
bË_id
, 1, 
th_Œx_id
, &
t_»suÉ
);

146 
th_s
.
	`još
();

147 
th»ad
 
	`fo_x
(
exşusive_lock
, 
bË_id
, 1, 
s_upd©e_v®ue
, 
fo_Œx_id
, &
fo_»suÉ
);

149 
th»ad
 
	`f_c
(
’d_Œx
, 
fi_Œx_id
);

151 
f_c
.
	`još
();

152 
th»ad
 
	`s_c
(
’d_Œx
, 
£_Œx_id
);

154 
s_c
.
	`još
();

155 
th»ad
 
	`t_c
(
’d_Œx
, 
th_Œx_id
);

157 
t_c
.
	`još
();

158 
fo_x
.
	`još
();

160 
th»ad
 
	`fo_c
(
’d_Œx
, 
fo_Œx_id
);

161 
fo_c
.
	`još
();

162 
cout
 << "<< Fou¹h scheduË dÚe" << 
’dl
;

166 autØ
‹¡5
 = [&]() {

167 
cout
 << ">> Fiáh ScheduË : RecÜd 1 : WÑ1èSÑ2èSÑ3èSÑ4)" << 
’dl
;

168 
fi_Œx_id
 = 
	`begš_tx
();

169 
£_Œx_id
 = 
	`begš_tx
();

170 
th_Œx_id
 = 
	`begš_tx
();

171 
fo_Œx_id
 = 
	`begš_tx
();

172 
th»ad
 
	`fi_s
(
exşusive_lock
, 
bË_id
, 1, 
f_upd©e_v®ue
, 
fi_Œx_id
, &
f_»suÉ
);

174 
fi_s
.
	`još
();

176 
th»ad
 
	`£_s
(
sh¬ed_lock
, 
bË_id
, 1, 
£_Œx_id
, &
s_»suÉ
);

177 
th»ad
 
	`th_s
(
sh¬ed_lock
, 
bË_id
, 1, 
th_Œx_id
, &
t_»suÉ
);

178 
th»ad
 
	`fo_x
(
sh¬ed_lock
, 
bË_id
, 1, 
fo_Œx_id
, &
fo_»suÉ
);

180 
th»ad
 
	`f_c
(
’d_Œx
, 
fi_Œx_id
);

181 
f_c
.
	`još
();

183 
£_s
.
	`još
();

184 
th_s
.
	`još
();

185 
fo_x
.
	`još
();

186 
th»ad
 
	`s_c
(
’d_Œx
, 
£_Œx_id
);

187 
s_c
.
	`još
();

188 
th»ad
 
	`t_c
(
’d_Œx
, 
th_Œx_id
);

189 
t_c
.
	`još
();

190 
th»ad
 
	`fo_c
(
’d_Œx
, 
fo_Œx_id
);

191 
fo_c
.
	`još
();

192 
cout
 << "<< Fiáh scheduË dÚe" << 
’dl
;

198 autØ
dl_‹¡1
 = [&]() {

199 
cout
 << ">> Fœ¡ D—dLock check”" << 
’dl
;

200 
fi
 = 
	`begš_tx
();

201 
£
 = 
	`begš_tx
();

205 autØ
dl_‹¡2
 = [&]() {

207 autØ
dl_‹¡3
 = [&]() {

209 autØ
dl_‹¡4
 = [&]() {

211 autØ
dl_‹¡5
 = [&]() {

219 
	`‹¡1
();

220 
cout
 << 
’dl
;

221 
	`‹¡2
();

222 
cout
 << 
’dl
;

223 
	`‹¡3
();

224 
cout
 << 
’dl
;

225 
	`‹¡4
();

226 
cout
 << 
’dl
;

227 
	`‹¡5
();

228 
cout
 << 
’dl
;

229 
	`şo£_bË
(
bË_id
);

230 
	`shutdown_db
();

232 
	}
}

	@src/trx.cpp

1 
	~"Œx.h
"

3 
T¿n§ùiÚMªag”
 
	gŒx_sys
;

5 
	gT¿n§ùiÚMªag”
::~
	$T¿n§ùiÚMªag”
() {

6 autØ
™
 = 
aùive_Œx
.
	`begš
(); iˆ!ğaùive_Œx.
	`’d
(); ++it) {

7 ià(
™
 -> 
£cÚd
)

8 
d–‘e
 
™
->
£cÚd
;

10 
aùive_Œx
.
	`ş—r
();

11 
	}
}

13 
Œx_t
* 
	gT¿n§ùiÚMªag”
::
	$makeNewT¿n§ùiÚ
() {

14 
Œx_t
* 
Ãw_Œx
 = 
Ãw
 
	`Œx_t
(
Œx_id
++);

15 
aùive_Œx
[
Ãw_Œx
->
	`g‘T¿n§ùiÚId
()] =‚ew_trx;

16  
Ãw_Œx
;

17 
	}
}

19 
Œx_t
* 
	gT¿n§ùiÚMªag”
::
	$g‘T¿n§ùiÚ
(
Œx_id_t
 
Œx_id
) {

20 ià(
aùive_Œx
.
	`couÁ
(
Œx_id
) != 0)

21  
aùive_Œx
[
Œx_id
];

23  
nuÎ±r
;

24 
	}
}

26 
boŞ
 
	gT¿n§ùiÚMªag”
::
	$d–‘eT¿n§ùiÚ
(
Œx_id_t
 
Œx_id
) {

27 
Œx_t
* 
Œx
 = 
	`g‘T¿n§ùiÚ
(
Œx_id
);

28 ià(!
Œx
)

29  
çl£
;

31 
Œx_t
* 
Œx_±r
 = 
nuÎ±r
;

33 autØ
™
 = 
aùive_Œx
.
	`begš
(); iˆ!ğaùive_Œx.
	`’d
(); ++it) {

34 ià(
™
 -> 
fœ¡
 =ğ
Œx_id
){

35 
Œx_±r
 = 
™
 -> 
£cÚd
;

36 
aùive_Œx
.
	`”a£
(
Œx_id
);

37 
d–‘e
 
Œx_±r
;

38  
Œue
;

42  
çl£
;

43 
	}
}

	@src/univ.cpp

1 
	~"b±_š‹º®.h
"

8 
BufPoŞ
 
poŞ
;

9 
LockMªag”
 
lock_sys
;

11 
boŞ
 
	$fšd_Ëaf
(
TabË
* 
bË
, 
št64_t
 
key
, 
L—fPage
** 
out_Ëaf_node
) {

13 
i
 = 0;

14 
off_t
 
roÙ_off£t
 = 
bË
->
dbh—d”
.root_offset;

16 ià(
roÙ_off£t
 == 0) {

17  
çl£
;

20 
NodePage
* 
·ge
;

21 
·ge
 = (
NodePage
*)
	`g‘_·ge
(
bË
, 
	`FILEOFF_TO_PAGENUM
(
roÙ_off£t
));

23 !
·ge
->
is_Ëaf
) {

24 
IÁ”ÇlPage
* 
š‹º®_node
 = (IÁ”ÇlPage*)
·ge
;

26 
i
 = 0;

27 
i
 < 
š‹º®_node
->
num_keys
) {

28 ià(
key
 >ğ
	`INTERNAL_KEY
(
š‹º®_node
, 
i
)) i++;

32 
NodePage
* 
ÃxtPage
 = (NodePage*)
	`g‘_·ge
(
bË
,

33 
	`FILEOFF_TO_PAGENUM
(
	`INTERNAL_OFFSET
(
š‹º®_node
, 
i
)));

34 ià(
ÃxtPage
->
is_Ëaf
 =ğ0 &&‚extPage->
num_keys
 == 0){

35 
	`PANIC
("find_leaf infinite†oop!\n");

37 
	`»Ëa£_·ge
((
Page
*)
·ge
);

38 
·ge
 = 
ÃxtPage
;

42 *
out_Ëaf_node
 = (
L—fPage
*)
·ge
;

44  
Œue
;

45 
	}
}

54 
boŞ
 
	$fšd_Ëaf
(
TabË
* 
bË
, 
št64_t
 
key
, 
L—fPage
** 
out_Ëaf_node
, * 
buf_·ge_i
) {

55 
BUF_POOL_MUTEX_ENTER
;

57 
i
 = 0;

58 
off_t
 
roÙ_off£t
 = 
bË
->
dbh—d”
.root_offset;

60 ià(
roÙ_off£t
 == 0) {

61  
çl£
;

64 
NodePage
* 
·ge
;

65 
·ge
 = (
NodePage
*)
	`g‘_·ge
(
bË
, 
	`FILEOFF_TO_PAGENUM
(
roÙ_off£t
), 
buf_·ge_i
);

67 !
·ge
->
is_Ëaf
) {

68 
IÁ”ÇlPage
* 
š‹º®_node
 = (IÁ”ÇlPage*)
·ge
;

70 
i
 = 0;

71 
i
 < 
š‹º®_node
->
num_keys
) {

72 ià(
key
 >ğ
	`INTERNAL_KEY
(
š‹º®_node
, 
i
)) i++;

76 
NodePage
* 
ÃxtPage
 = (NodePage*)
	`g‘_·ge
(
bË
,

77 
	`FILEOFF_TO_PAGENUM
(
	`INTERNAL_OFFSET
(
š‹º®_node
, 
i
)), 
buf_·ge_i
);

80 ià(!
ÃxtPage
) {

81 
BUF_POOL_MUTEX_EXIT
;

82 
	`»Ëa£_·ge
((
Page
*)
·ge
);

83 *
buf_·ge_i
 = 
BUF_PAGE_MUTEX_FAIL
;

85  
çl£
;

87 ià(
ÃxtPage
->
is_Ëaf
 =ğ0 &&‚extPage->
num_keys
 == 0){

88 
	`PANIC
("find_leaf infinite†oop!\n");

90 
	`»Ëa£_·ge
((
Page
*)
·ge
);

91 
·ge
 = 
ÃxtPage
;

95 *
out_Ëaf_node
 = (
L—fPage
*)
·ge
;

96 
BUF_POOL_MUTEX_EXIT
;

97  
Œue
;

98 
	}
}

103 
št64_t
* 
	$fšd_»cÜd
(
TabË
* 
bË
, 
št64_t
 
key
) {

104 
i
 = 0;

105 
št64_t
* 
out_v®ue
;

107 
L—fPage
* 
Ëaf_node
;

108 ià(!
	`fšd_Ëaf
(
bË
, 
key
, &
Ëaf_node
)) {

109  
NULL
;

112 
i
 = 0; i < 
Ëaf_node
->
num_keys
; i++) {

113 ià(
	`LEAF_KEY
(
Ëaf_node
, 
i
è=ğ
key
) {

114 
out_v®ue
 = (
št64_t
*)
	`m®loc
(
SIZE_COLUMN
 * (int64_t));

115 
	`memıy
(
out_v®ue
, 
	`LEAF_VALUE
(
Ëaf_node
, 
i
), 
SIZE_VALUE
);

116 
	`»Ëa£_·ge
((
Page
*)
Ëaf_node
);

117  
out_v®ue
;

121 
	`»Ëa£_·ge
((
Page
*)
Ëaf_node
);

122  
NULL
;

123 
	}
}

130 
št64_t
* 
	$fšd_»cÜd
(
TabË
* 
bË
, 
št64_t
 
key
, 
Œx_t
* 
Œx
) {

132 
i
 = 0;

133 
buf_·ge_i
 = 0;

134 
št64_t
* 
out_v®ue
;

136 
L—fPage
* 
Ëaf_node
;

138 
boŞ
 
g‘_·ge_Ïtch
;

139 
lock_»q_»t
;

141 
Œue
) {

147 
g‘_·ge_Ïtch
 = 
	`fšd_Ëaf
(
bË
, 
key
, &
Ëaf_node
, &
buf_·ge_i
);

149 ià(!
g‘_·ge_Ïtch
) {

150 ià(
buf_·ge_i
 !ğ
BUF_PAGE_MUTEX_FAIL
)

151  
nuÎ±r
;

156 
lock_»q_»t
 = 
lock_sys
.
	`acquœe_lock
(
Œx
, 
bË
->
bË_id
, 
poŞ
.
·ges
[
buf_·ge_i
].
·g’um
, 
key
, 
LOCK_S
);

158 ià(
lock_»q_»t
 =ğ
LOCK_SUCCESS
) {

161 } ià(
lock_»q_»t
 =ğ
DEADLOCK
) {

162 
	`»Ëa£_·ge
((
Page
*)
Ëaf_node
, &
buf_·ge_i
);

163  
nuÎ±r
;

165 } ià(
lock_»q_»t
 =ğ
LOCK_WAIT
) {

166 
	`»Ëa£_·ge
((
Page
*)
Ëaf_node
, &
buf_·ge_i
);

167 
Œx
->
	`Œx_wa™_lock
();

170 
	`PANIC
("In find„ecord. Unknown„eturn value.\n");

174 
i
 = 0; i < 
Ëaf_node
->
num_keys
; i++) {

175 ià(
	`LEAF_KEY
(
Ëaf_node
, 
i
è=ğ
key
) {

176 
out_v®ue
 = (
št64_t
*)
	`m®loc
(
SIZE_COLUMN
 * (int64_t));

177 
	`memıy
(
out_v®ue
, 
	`LEAF_VALUE
(
Ëaf_node
, 
i
), 
SIZE_VALUE
);

178 
	`»Ëa£_·ge
((
Page
*)
Ëaf_node
, &
buf_·ge_i
);

179  
out_v®ue
;

183 
	`»Ëa£_·ge
((
Page
*)
Ëaf_node
, &
buf_·ge_i
);

184  
nuÎ±r
;

185 
	}
}

190 
	$cut
Ğ
Ëngth
 ) {

191 ià(
Ëngth
 % 2 == 0)

192  
Ëngth
/2;

194  
Ëngth
/2 + 1;

195 
	}
}

	@src/update.cpp

1 
	~"b±_š‹º®.h
"

2 
	~"ty³s.h
"

8 
	$upd©e_»cÜd
(
TabË
* 
bË
, 
št64_t
 
key
, iÁ64_t* 
v®ue
, 
Œx_t
* 
Œx
) {

9 
i
 = 0;

10 
buf_·ge_i
 = 0;

11 
L—fPage
* 
Ëaf_node
;

13 
boŞ
 
g‘_·ge_Ïtch
;

14 
lock_»q_»t
;

17 
Œue
) {

23 
g‘_·ge_Ïtch
 = 
	`fšd_Ëaf
(
bË
, 
key
, &
Ëaf_node
, &
buf_·ge_i
);

25 ià(!
g‘_·ge_Ïtch
) {

26 ià(
buf_·ge_i
 !ğ
BUF_PAGE_MUTEX_FAIL
)

35 
lock_»q_»t
 = 
lock_sys
.
	`acquœe_lock
(
Œx
, 
bË
->
bË_id
, 
poŞ
.
·ges
[
buf_·ge_i
].
·g’um
, 
key
, 
LOCK_X
);

37 ià(
lock_»q_»t
 =ğ
LOCK_SUCCESS
) {

40 } ià(
lock_»q_»t
 =ğ
DEADLOCK
) {

41 
	`»Ëa£_·ge
((
Page
*)
Ëaf_node
, &
buf_·ge_i
);

44 } ià(
lock_»q_»t
 =ğ
LOCK_WAIT
) {

45 
	`»Ëa£_·ge
((
Page
*)
Ëaf_node
, &
buf_·ge_i
);

46 
Œx
->
	`Œx_wa™_lock
();

49 
	`PANIC
("In update„ecord. Unknown„eturn value.\n");

53 
i
 = 0; i < 
Ëaf_node
->
num_keys
; i++) {

54 ià(
	`LEAF_KEY
(
Ëaf_node
, 
i
è=ğ
key
) {

55 
Œx
 -> 
	`push_undo_log
(
bË
->
bË_id
, 
key
, 
Ëaf_node
 -> 
·g’um
, 
	`LEAF_VALUE
Ö—f_node, 
i
));

57 
	`memıy
(
	`LEAF_VALUE
(
Ëaf_node
, 
i
), 
v®ue
, 
SIZE_VALUE
);

58 
	`»Ëa£_·ge
((
Page
*)
Ëaf_node
, &
buf_·ge_i
);

63 
	`»Ëa£_·ge
((
Page
*)
Ëaf_node
, &
buf_·ge_i
);

65 
	}
}

	@
1
.
0
25
378
include/bpt.h
include/bpt_internal.h
include/buf.h
include/deadlock.h
include/file.h
include/lock.h
include/page.h
include/panic.h
include/table.h
include/trx.h
include/types.h
src/bpt_ext.cpp
src/buf.cpp
src/deadlock.cpp
src/delete.cpp
src/file.cpp
src/global_vars.cpp
src/insert.cpp
src/lock.cpp
src/main.cpp
src/table.cpp
src/test.cpp
src/trx.cpp
src/univ.cpp
src/update.cpp
