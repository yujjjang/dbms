cscope 15 $HOME/Documents/DBMS_2018_2/dbms/proj3 -q 0000000475 0000066975
	@include/bpt.h

1 #i‚de‡
__BPT_H__


2 
	#__BPT_H__


	)

5 
öô_db
(
num_buf
);

6 
shutdown_db
();

8 
›í_èbÀ
(* 
fûíame
, 
num_cﬁumn
);

9 
˛o£_èbÀ
(
èbÀ_id
);

12 
öt64_t
* 
föd
(
èbÀ_id
, i¡64_à
key
);

13 
ö£π
(
èbÀ_id
, 
öt64_t
 
key
, i¡64_t* 
vÆue
);

14 
ªmove
(
èbÀ_id
, 
öt64_t
 
key
);

17 
öt64_t
* 
föd
(
èbÀ_id
, i¡64_à
key
, 
åx_id
, * 
ªsu…
);

18 
upd©e
(
èbÀ_id
, 
öt64_t
 
key
, i¡64_t* 
vÆue
, 
åx_id
, * 
ªsu…
);

20 
begö_tx
();

21 
boﬁ
 
íd_tx
(
åx_id
);

23 
¥öt_åì
(
èbÀ_id
);

24 
föd_™d_¥öt
(
èbÀ_id
, 
öt64_t
 
key
);

25 
li˚n£_nŸi˚
( );

26 
ußge_1
( );

27 
ußge_2
( );

	@include/bpt_internal.h

1 #i‚de‡
__BPT_INTERNAL_H__


2 
	#__BPT_INTERNAL_H__


	)

3 
	#Vîsi⁄
 "1.14"

	)

56 
	~<°dio.h
>

57 
	~<°dlib.h
>

58 
	~<°dboﬁ.h
>

59 
	~<°döt.h
>

60 
	~<°rög.h
>

61 
	~<öây≥s.h
>

62 
	~<as£π.h
>

63 
	~<f˙é.h
>

64 
	~<uni°d.h
>

66 
	~"ty≥s.h
"

67 
	~"∑ge.h
"

68 
	~"èbÀ.h
"

69 
	~"fûe.h
"

70 
	~"buf.h
"

71 
	~"∑nic.h
"

72 
	~"lock.h
"

73 
	~"åx.h
"

75 #ifde‡
WINDOWS


76 
	#boﬁ
 

	)

77 
	#Ál£
 0

	)

78 
	#åue
 1

	)

85 
	#MIN_ORDER
 3

	)

86 
	#MAX_ORDER
 256

	)

88 
	#IS_DELAYED_MERGE


	)

91 
	#LICENSE_FILE
 "LICENSE.txt"

	)

92 
	#LICENSE_WARRANTEE
 0

	)

93 
	#LICENSE_WARRANTEE_START
 592

	)

94 
	#LICENSE_WARRANTEE_END
 624

	)

95 
	#LICENSE_CONDITIONS
 1

	)

96 
	#LICENSE_CONDITIONS_START
 70

	)

97 
	#LICENSE_CONDITIONS_END
 625

	)

100 
‹dî_öã∫Æ
;

101 
‹dî_Àaf
;

102 
Tønß˘i⁄M™agî
 
åx_sys
;

103 
LockM™agî
 
lock_sys
;

104 
BufPoﬁ
 
poﬁ
;

109 
boﬁ
 
föd_Àaf
(
TabÀ
 *
èbÀ
, 
öt64_t
 
key
, 
LófPage
** 
out_Àaf_node
);

110 
boﬁ
 
föd_Àaf
(
TabÀ
 *
èbÀ
, 
öt64_t
 
key
, 
LófPage
** 
out_Àaf_node
, * 
buf_∑ge_i
);

111 
öt64_t
 *
föd_ªc‹d
(
TabÀ
 *
èbÀ
, i¡64_à
key
);

112 
öt64_t
 *
föd_ªc‹d
(
TabÀ
 *
èbÀ
, i¡64_à
key
, 
åx_t
* 
åx
);

115 
cut
–
Àngth
 );

118 
upd©e_ªc‹d
(
TabÀ
* 
èbÀ
, 
öt64_t
 
key
, i¡64_t* 
vÆue
, 
åx_t
* 
åx
);

121 
°¨t_√w_åì
(
TabÀ
 *
èbÀ
, 
öt64_t
 
key
, i¡64_t* 
vÆue
);

122 
ö£π_öto_Àaf
(
TabÀ
 *
èbÀ
, 
LófPage
* 
Àaf_node
, 
öt64_t
 
key
,

123 
öt64_t
* 
vÆue
);

124 
ö£π_öto_Àaf_a·î_•lôtög
(
TabÀ
 *
èbÀ
, 
LófPage
* 
Àaf_node
,

125 
öt64_t
 
key
, i¡64_t* 
vÆue
);

126 
ö£π_öto_∑ª¡
(
TabÀ
 *
èbÀ
, 
NodePage
* 
À·
, 
öt64_t
 
key
,

127 
NodePage
* 
right
);

128 
ö£π_öto_√w_roŸ
(
TabÀ
 *
èbÀ
, 
NodePage
* 
À·
, 
öt64_t
 
key
,

129 
NodePage
* 
right
);

130 
gë_À·_ödex
(
TabÀ
 *
èbÀ
, 
I¡î«lPage
* 
∑ª¡
, 
off_t
 
À·_off£t
);

131 
ö£π_öto_node
(
TabÀ
 *
èbÀ
, 
I¡î«lPage
 * 
∑ª¡
, 
À·_ödex
,

132 
öt64_t
 
key
, 
off_t
 
right_off£t
);

133 
ö£π_öto_node_a·î_•lôtög
(
TabÀ
 *
èbÀ
, 
I¡î«lPage
* 
∑ª¡
,

134 
À·_ödex
, 
öt64_t
 
key
, 
off_t
 
right_off£t
);

135 
ö£π_ªc‹d
(
TabÀ
 *
èbÀ
, 
öt64_t
 
key
, i¡64_t* 
vÆue
);

138 
gë_√ighb‹_ödex
(
TabÀ
 *
èbÀ
, 
NodePage
* 
node_∑ge
);

139 
adju°_roŸ
(
TabÀ
 *
èbÀ
, 
NodePage
* 
roŸ_∑ge
);

140 
cﬂÀs˚_nodes
(
TabÀ
 *
èbÀ
, 
NodePage
* 
node_∑ge
, NodePage* 
√ighb‹_∑ge
,

141 
√ighb‹_ödex
, 
k_¥ime
);

142 
ªdi°ribuã_nodes
(
TabÀ
 *
èbÀ
, 
NodePage
* 
node_∑ge
,

143 
NodePage
* 
√ighb‹_∑ge
, 
√ighb‹_ödex
, 
k_¥ime_ödex
,

144 
k_¥ime
);

147 
dñëe_íåy
(
TabÀ
 *
èbÀ
, 
NodePage
* 
node_∑ge
, 
öt64_t
 
key
);

148 
dñëe_ªc‹d
(
TabÀ
 *
èbÀ
, 
öt64_t
 
key
);

	@include/buf.h

1 #i‚de‡
__BUF_H__


2 
	#__BUF_H__


	)

3 
	~<muãx
>

5 
	~"èbÀ.h
"

6 
	~"∑ge.h
"

8 
	s_BufPoﬁ
 {

9 
Page
* 
	m∑ges
;

11 
	m°d
::
muãx
 
buf_poﬁ_muãx
;

14 
	m°d
::
muãx
* 
buf_∑ge_muãx
;

16 
Page
* 
	mÃu_hód
;

17 
Page
* 
	mÃu_èû
;

18 
	mnum_buf
;

19 
	mtŸ_pö˙t
;

20 } 
	tBufPoﬁ
;

22 
öô_√w_hódî_∑ge
(
HódîPage
 *
hódî_∑ge
, 
èbÀ_id
, 
num_cﬁumn
);

24 
lﬂd_hódî_∑ge
(
TabÀ
 *
èbÀ
);

26 
Page
* 
Æloc_∑ge
(
TabÀ
 *
èbÀ
);

28 
Page
* 
gë_∑ge
(
TabÀ
 *
èbÀ
, 
∑gíum_t
 
∑gíum
);

30 
Page
* 
gë_∑ge
(
TabÀ
 *
èbÀ
, 
∑gíum_t
 
∑gíum
, * 
buf_∑ge_i
);

32 
ªÀa£_hódî_∑ge
(
TabÀ
 *
èbÀ
);

34 
ªÀa£_∑ge
(
Page
* 
∑ge
);

36 
ªÀa£_∑ge
(
Page
* 
∑ge
, * 
buf_∑ge_i
);

38 
£t_dúty_∑ge
(
Page
* 
∑ge
);

40 
‰ì_∑ge
(
TabÀ
 *
èbÀ
, 
Page
* 
∑ge
);

42 
Êush_èbÀ
(
TabÀ
 *
èbÀ
);

44 
öô_buf_poﬁ
(
num_buf
);

46 
de°roy_buf_poﬁ
();

48 
¥öt_buf_poﬁ
();

50 
	#BUF_PAGE_MUTEX_FAIL
 -930209

	)

52 
	#BUF_POOL_MUTEX_ENTER
 \

53 
°d
::
unique_lock
<°d::
muãx
> 
	`buf_poﬁ_œtch
(
poﬁ
.
buf_poﬁ_muãx
);\

54 

	)

55 
	#BUF_PAGE_MUTEX_ENTER
(
i
)\

56 
boﬁ
 
ªt
 = 
poﬁ
.
buf_∑ge_muãx
[
i
].
	`åy_lock
();

	)

58 
	#BUF_PAGE_MUTEX_ENTER_WAIT
(
i
)\

59 
poﬁ
.
buf_∑ge_muãx
[
i
].
	`lock
();

	)

	@include/deadlock.h

1 #i‚de‡
__DEADLOCK__H__


2 
	#__DEADLOCK__H__


	)

4 
	~<un‹dîed_m≠
>

5 
	~<ve˘‹
>

6 
	~<°ack
>

7 
	~<Æg‹ôhm
>

8 
	~<˛imôs
>

9 
	~<∑nic.h
>

16 ˛as†
	cDLCheckî
 {

17 
	sèrj™_t
 {

18 
èrj™_t
(){};

19 
èrj™_t
(
waô_f‹
Ë: 
waôög_åx_id
(waô_f‹), 
föished
(
Ál£
), 
dfs_‹dî
(-1) {};

20 
	mwaôög_åx_id
;

21 
boﬁ
 
	mföished
;

22 
	mdfs_‹dî
;

25 
	g¥iv©e
:

26 
°d
::
°ack
<
èrj™_t
*> 
s_èrj™
;

27 
	gdfs_‹dî
;

28 
boﬁ
 
	gcy˛e_Êag
;

29 
	gœã°_åx_id
;

31 
dfs_èrj™
(
èrj™_t
* 
°
);

32 
öôülize_èrj™_acy˛ic
();

33 
öôülize_èrj™_cy˛ic
();

35 
	g°d
::
un‹dîed_m≠
<, 
	gèrj™_t
> 
	gdl_gøph
;

36 
boﬁ
 
is_cy˛ic
 ();

38 
	gpublic
:

39 
	$DLCheckî
(): 
	`dfs_‹dî
(-1), 
	`cy˛e_Êag
(
Ál£
), 
	$œã°_åx_id
(0Ë{
	}
};

40 ~
	$DLCheckî
(){
	}
};

42 
boﬁ
 
ch™ge_waôög_f‹
(
åx_id
, 
waô_f‹
);

43 
boﬁ
 
dódlock_checkög
(
åx_id
, 
waô_f‹
);

44 
dñëe_waôög_f‹_åx
(
åx_id
);

	@include/file.h

1 #i‚de‡
__FILE_H__


2 
	#__FILE_H__


	)

3 
	~"èbÀ.h
"

4 
	~"∑ge.h
"

7 
ex∑nd_fûe
(
TabÀ
 *
èbÀ
, 
size_t
 
˙t_∑ge_to_ex∑nd
);

10 
fûe_ªad_∑ge
(
TabÀ
 *
èbÀ
, 
∑gíum_t
 
∑gíum
, * 
∑ge
);

13 
fûe_wrôe_∑ge
(
TabÀ
 *
èbÀ
, 
∑gíum_t
 
∑gíum
, * 
∑ge
);

	@include/lock.h

1 #i‚de‡
__LOCK_HPP__


2 
	#__LOCK_HPP__


	)

4 
	~<un‹dîed_m≠
>

5 
	~<li°
>

6 
	~<muãx
>

7 
	~<c⁄dôi⁄_v¨übÀ
>

8 
	~<ve˘‹
>

9 
	~<un‹dîed_£t
>

11 
	~"∑ge.h
"

12 
	~"èbÀ.h
"

13 
	~"åx.h
"

14 
	~"ty≥s.h
"

15 
	~"∑nic.h
"

16 
	~"dódlock.h
"

17 
	~"buf.h
"

19 
Tønß˘i⁄M™agî
 
åx_sys
;

20 
BufPoﬁ
 
poﬁ
;

25 
	slock_t
 {

26 
lock_t
(
èbÀ_id
, 
åx_id_t
 
åx_id
, 
∑gíum_t
 
∑ge_id
, 
öt64_t
 
key
, 
LockMode
 
lock_mode
, 
buf_∑ge_i
,Üock_t* 
waô_lock
) :

27 
èbÀ_id
—abÀ_id), 
åx_id
—rx_id), 
∑ge_id
’age_id), 
key
(key), 
lock_mode
÷ock_mode), 
buf_∑ge_i
(buf_page_i),

28 
¥ev
(
nuŒ±r
), 
√xt
“uŒ±rË,
waô_lock
(wait_lock) {};

29 
	mèbÀ_id
;

30 
åx_id_t
 
	måx_id
;

31 
∑gíum_t
 
	m∑ge_id
;

32 
öt64_t
 
	mkey
;

33 
boﬁ
 
	macquúed
;

34 
LockMode
 
	mlock_mode
;

35 
	mbuf_∑ge_i
;

37 
lock_t
* 
	m¥ev
;

38 
lock_t
* 
	m√xt
;

40 
lock_t
* 
	mwaô_lock
;

42 } 
	tlock_t
;

44 
	slock_∑ge_t
 {

45 
	m°d
::
li°
<
lock_t
> 
lock_li°
;

46 } 
	tlock_∑ge_t
;

48 ˛as†
	cLockM™agî
 {

49 íum {
	mLOCK_WAITING
, 
	mLOCK_GRANTED_PUSH
, 
	mLOCK_GRANTED_NO_PUSH
} 
	tLOCK_REQ_STATE
;

51 
	g¥iv©e
:

52 
DLCheckî
 
dl_checkî
;

53 
	g°d
::
muãx
 
lock_sys_muãx
;

56 
	g°d
::
un‹dîed_m≠
<
∑gíum_t
, 
	glock_∑ge_t
> 
	glock_èbÀ
;

58 
rﬁlback_d©a
(, 
uöt64_t
, 
åx_t
*, 
undo_log
&);

59 
ªÀa£_lock_ab‹ãd_low
(
åx_t
*, 
lock_t
*);

60 
boﬁ
 
ªÀa£_lock_ab‹ãd
(
åx_t
*);

62 
ölöe
 
ªÀa£_∑ge_œtch
(
buf_∑ge_i
);

63 
ölöe
 
acquúe_∑ge_œtch
(
buf_∑ge_i
);

66 
	gpublic
:

68 
	$LockM™agî
(Ë: 
	$dl_checkî
(Ë{
	}
};

69 ~
	$LockM™agî
(){
	}
};

71 
boﬁ
 
acquúe_lock
(
åx_t
*, 
èbÀ_id
, 
∑gíum_t
, 
öt64_t
 
key
, 
LockMode
 
lock_mode
, 
buf_∑ge_i
);

72 
ªÀa£_lock_low
(
åx_t
*, 
lock_t
*);

73 
boﬁ
 
ªÀa£_lock
(
åx_t
*);

76 
	#LOCK_SYS_MUTEX_ENTER
 \

77 
°d
::
unique_lock
<°d::
muãx
> 
	`l_muãx
(
lock_sys_muãx
, std::
de„r_lock
);\

78 
boﬁ
 
lock_sys_muãx_acquúed
 = 
l_muãx
.
	`åy_lock
();

	)

80 
	#MAKE_LOCK_REQUEST_WAIT
 \

81 
lock_t
 
lock_ªq
{
èbÀ_id
, 
åx
->
	`gëTønß˘i⁄Id
(), 
∑ge_id
, 
key
, 
mode
, 
buf_∑ge_i
, 
waô_lock
};\

82 
lock_èbÀ
[
∑ge_id
].
lock_li°
.
	`push_back
(
lock_ªq
);\

83 
lock_±r
 = &(
lock_èbÀ
[
∑ge_id
].
lock_li°
.
	`back
());\

84 if(
¥ev_lock_±r
) {\

85 
lock_±r
 -> 
¥ev
 = 
¥ev_lock_±r
;\

86 
¥ev_lock_±r
 -> 
√xt
 = 
lock_±r
;\

87 }

	)

89 
	#MAKE_LOCK_REQUEST_GRANTED
 \

90 
lock_t
 
lock_ªq
{
èbÀ_id
, 
åx
->
	`gëTønß˘i⁄Id
(), 
∑ge_id
, 
key
, 
mode
, 
buf_∑ge_i
, 
nuŒ±r
};\

91 
lock_èbÀ
[
∑ge_id
].
lock_li°
.
	`push_back
(
lock_ªq
);\

92 
lock_±r
 = &(
lock_èbÀ
[
∑ge_id
].
lock_li°
.
	`back
());\

93 if(
¥ev_lock_±r
) {\

94 
lock_±r
 -> 
¥ev
 = 
¥ev_lock_±r
;\

95 
¥ev_lock_±r
 -> 
√xt
 = 
lock_±r
;\

96 }

	)

	@include/page.h

1 #i‚de‡
__PAGE_H__


2 
	#__PAGE_H__


	)

3 
	~<°ddef.h
>

4 
	~<°dboﬁ.h
>

5 
	~<öây≥s.h
>

7 
	#BPTREE_INTERNAL_ORDER
 249

	)

8 
	#BPTREE_LEAF_ORDER
 32

	)

10 
	#PAGE_SIZE
 4096

	)

12 
	#SIZE_KEY
 8

	)

13 
	#SIZE_COLUMN
 15

	)

14 
	#SIZE_VALUE
 120

	)

15 
	#SIZE_RECORD
 (
SIZE_KEY
 + 
SIZE_VALUE
)

	)

17 
	#BPTREE_MAX_NODE
 (1024 * 1024)

18 

	)

19 
uöt64_t
 
	t∑gíum_t
;

20 
	#PAGENUM_TO_FILEOFF
(
pgnum
Ë(’gnumË* 
PAGE_SIZE
)

	)

21 
	#FILEOFF_TO_PAGENUM
(
off
Ë((
∑gíum_t
)((offË/ 
PAGE_SIZE
))

	)

33 
	s_Rec‹d
 {

34 
öt64_t
 
	mkey
;

35 
öt64_t
 
	mvÆue
[
SIZE_COLUMN
];

36 } 
	tRec‹d
;

38 
	s_I¡î«lRec‹d
 {

39 
öt64_t
 
	mkey
;

40 
off_t
 
	moff£t
;

41 } 
	tI¡î«lRec‹d
;

43 
	#INMEM_PAGE
 \

44 
èbÀ_id
; \

45 
∑gíum_t
 
∑gíum
; \

46 
boﬁ
 
is_dúty
; \

47 
pö˙t
; \

48 
_Page
* 
Ãu_√xt
; \

49 
_Page
* 
Ãu_¥ev


	)

51 
	s_Page
 {

52 
	mbyãs
[
PAGE_SIZE
];

55 
	mINMEM_PAGE
;

56 } 
	tPage
;

58 
	s_FªePage
 {

59 
off_t
 
	m√xt
;

60 
	mª£rved
[
PAGE_SIZE
 - 8];

63 
	mINMEM_PAGE
;

64 } 
	tFªePage
;

66 
	s_HódîPage
 {

67 
off_t
 
	m‰ìli°
;

68 
off_t
 
	mroŸ_off£t
;

69 
uöt64_t
 
	mnum_∑ges
;

70 
off_t
 
	mnum_cﬁumn
;

71 
	mª£rved
[
PAGE_SIZE
 - 32];

74 
	mINMEM_PAGE
;

75 } 
	tHódîPage
;

77 
	#INTERNAL_KEY
(
n
, 
i
Ë(“)->
úec‹ds
[(i)+1].
key
)

	)

78 
	#INTERNAL_OFFSET
(
n
, 
i
Ë(“)->
úec‹ds
[(i)].
off£t
)

	)

79 
	s_I¡î«lPage
 {

82 
off_t
 
	m∑ª¡
;

83 
	mis_Àaf
;

84 
	mnum_keys
;

85 
	mª£rved
[112 - 16];

86 
I¡î«lRec‹d
 
	múec‹ds
[
BPTREE_INTERNAL_ORDER
];

88 
	m•a˚
[
PAGE_SIZE
];

91 
	mINMEM_PAGE
;

92 } 
	tI¡î«lPage
;

94 
	#LEAF_KEY
(
n
, 
i
Ë(“)->
ªc‹ds
[(i)].
key
)

	)

95 
	#LEAF_VALUE
(
n
, 
i
Ë(“)->
ªc‹ds
[(i)].
vÆue
)

	)

96 
	s_LófPage
 {

99 
off_t
 
	m∑ª¡
;

100 
	mis_Àaf
;

101 
	mnum_keys
;

102 
	mª£rved
[120 - 16];

103 
off_t
 
	msiblög
;

104 
Rec‹d
 
	mªc‹ds
[
BPTREE_LEAF_ORDER
-1];

106 
	m•a˚
[
PAGE_SIZE
];

110 
	mINMEM_PAGE
;

111 } 
	tLófPage
;

113 
	s_NodePage
 {

116 
off_t
 
	m∑ª¡
;

117 
	mis_Àaf
;

118 
	mnum_keys
;

120 
	m•a˚
[
PAGE_SIZE
];

124 
	mINMEM_PAGE
;

125 } 
	tNodePage
;

	@include/panic.h

1 #i‚de‡
__PANIC_H__


2 
	#__PANIC_H__


	)

3 
	~<°dio.h
>

5 
	#PANIC
(
msg
,...) do{\

6 
	`Ârötf
(
°dîr
, "PANIC: [%s:%d i¿%s] " 
msg
 "\n", \

7 
__FILE__
, 
__LINE__
, 
__func__
 , ##
__VA_ARGS__
); \

8 
	`exô
(
EXIT_FAILURE
); \

9 }0)

	)

	@include/table.h

1 #i‚de‡
__TABLE_H__


2 
	#__TABLE_H__


	)

4 
	~"∑ge.h
"

6 
	s_TabÀ
 {

7 
HódîPage
 
	mdbhódî
;

8 
	mdbfûe
;

9 
	mèbÀ_id
;

11 } 
	tTabÀ
;

13 
	#MAX_NUM_TABLE
 10

	)

16 
›í_‹_¸óã_èbÀ_fûe
(c⁄° * 
fûíame
, 
num_cﬁumn
);

18 
˛o£_èbÀ_fûe
(
TabÀ
 *
èbÀ
);

21 
TabÀ
 *
gë_èbÀ
(
èbÀ_id
);

	@include/trx.h

2 #i‚de‡
__TRX_HPP__


3 
	#__TRX_HPP__


	)

5 
	~<li°
>

6 
	~<un‹dîed_m≠
>

7 
	~<©omic
>

8 
	~<muãx
>

9 
	~<c⁄dôi⁄_v¨übÀ
>

10 
	~"ty≥s.h
"

12 
˛ass
 
	gLockM™agî
;

13 
	glock_t
;

15 
	sundo_log
 {

16 
undo_log
(
öt64_t
 
key
, i¡64_t* 
ﬁd_vÆue
) : key(key) {

17 
mem˝y
(
undo_vÆue
, 
ﬁd_vÆue
, 120);

19 
öt64_t
 
	mkey
;

20 
öt64_t
 
	mundo_vÆue
[15];

23 ˛as†
	cåx_t
 {

25 
	m¥iv©e
:

26 
åx_id
;

27 
	m°d
::
li°
<
lock_t
*> 
acquúed_lock
;

28 
	m°d
::
c⁄dôi⁄_v¨übÀ
 
åx_t_cv
;

30 
	m°d
::
li°
<
undo_log
> 
undo_log_li°
;

32 
Sèã
 
	m°©e
;

34 
	mpublic
:

35 
	$åx_t
(
åx_id_t
 
t_id
Ë: 
	`åx_id
—_idË, 
	$°©e
(
RUNNING
) {};

36 ~
	$åx_t
(){ 
acquúed_lock
.
	`˛ór
(); 
undo_log_li°
.˛ór(); 
	}
}

39 
	$push_undo_log
(
öt64_t
 
key
, i¡64_t* 
ﬁd_vÆue
Ë{ 
undo_log
 
	`log
(key, old_vÆue); 
undo_log_li°
.
	`push_back
(
log
); 
	}
}

40 
undo_log
 
	$p›_undo_log
(Ë{ 
undo_log
 
log
 = 
undo_log_li°
.
	`‰⁄t
(); undo_log_li°.
	`p›_‰⁄t
(); Üog; 
	}
}

43 
	$push_acquúed_lock
(
lock_t
* 
lock
Ë{ 
acquúed_lock
.
	`push_back
÷ock); 
	}
}

44 
	$£tSèã
(
Sèã
 
°©e
Ë{ 
this
->°©ê°©e; 
	}
}

46 c⁄° 
	g°d
::
li°
<
lock_t
*> 
	$gëAcquúedLock
 (Ëc⁄° {  
acquúed_lock
; 
	}
}

47 c⁄° 
Sèã
 
	$gëSèã
(Ëc⁄° {  
°©e
; 
	}
}

48 c⁄° 
åx_id_t
 
	$gëTønß˘i⁄Id
 (Ëc⁄° {  
åx_id
; 
	}
}

49 
	g°d
::
c⁄dôi⁄_v¨übÀ
* 
	$gëCV
(Ë{  &
åx_t_cv
; 
	}
}

53 ˛as†
	cTønß˘i⁄M™agî
 {

55 
	m¥iv©e
:

56 
°d
::
un‹dîed_m≠
<
åx_id_t
, 
	måx_t
*> 
	ma˘ive_åx
;

57 
	m°d
::
©omic
<> 
åx_id
;

59 
	mpublic
:

60 
	$Tønß˘i⁄M™agî
():
	$åx_id
(0) {};

62 ~
	`Tønß˘i⁄M™agî
();

64 
åx_t
* 
	`makeNewTønß˘i⁄
();

65 
boﬁ
 
	`dñëeTønß˘i⁄
(
åx_id_t
);

67 
°d
::
un‹dîed_m≠
<
åx_id_t
, 
åx_t
*> 
	$gëA˘iveTrx
(Ëc⁄° {  
a˘ive_åx
; 
	}
}

68 
åx_t
* 
gëTønß˘i⁄
(
åx_id_t
 
åx_id
);

	@include/types.h

1 #i‚de‡
__TYPES_H__


2 
	#__TYPES_H__


	)

4 
	#NONE
 0

	)

5 
	#RUNNING
 1

	)

6 
	#ABORTED
 2

	)

8 
	#LOCK_S
 0

	)

9 
	#LOCK_X
 1

	)

11 
	tåx_id_t
;

12 
	tSèã
;

13 
	tLockMode
;

	@src/bpt_ext.cpp

1 
	~"b±_öã∫Æ.h
"

4 
	$öô_db
(
num_buf
) {

5  
	`öô_buf_poﬁ
(
num_buf
);

6 
	}
}

8 
	$shutdown_db
() {

9  
	`de°roy_buf_poﬁ
();

10 
	}
}

13 
	$›í_èbÀ
(* 
fûíame
, 
num_cﬁumn
) {

14  
	`›í_‹_¸óã_èbÀ_fûe
(
fûíame
, 
num_cﬁumn
);

15 
	}
}

18 
	$˛o£_èbÀ
(
èbÀ_id
) {

19 
TabÀ
* 
èbÀ
 = 
	`gë_èbÀ
(
èbÀ_id
);

20 
	`Êush_èbÀ
(
èbÀ
);

21  
	`˛o£_èbÀ_fûe
(
èbÀ
);

22 
	}
}

28 
	$ö£π
(
èbÀ_id
, 
öt64_t
 
key
, i¡64_t* 
vÆue
) {

29 
TabÀ
* 
èbÀ
 = 
	`gë_èbÀ
(
èbÀ_id
);

30  
	`ö£π_ªc‹d
(
èbÀ
, 
key
, 
vÆue
);

31 
	}
}

35 
	$ªmove
(
èbÀ_id
, 
öt64_t
 
key
) {

36 
TabÀ
* 
èbÀ
 = 
	`gë_èbÀ
(
èbÀ_id
);

37  
	`dñëe_ªc‹d
(
èbÀ
, 
key
);

38 
	}
}

42 
öt64_t
* 
	$föd
(
èbÀ_id
, 
öt64_t
 
key
) {

43 
TabÀ
* 
èbÀ
 = 
	`gë_èbÀ
(
èbÀ_id
);

45  
	`föd_ªc‹d
(
èbÀ
, 
key
);

46 
	}
}

48 
öt64_t
* 
	$föd
(
èbÀ_id
, 
öt64_t
 
key
, 
åx_id
, * 
ªsu…
) {

49 
TabÀ
* 
èbÀ
 = 
	`gë_èbÀ
(
èbÀ_id
);

50 
Tønß˘i⁄M™agî
* 
tm
 = &
åx_sys
;

51 
åx_t
* 
åx
 = 
tm
 -> 
	`gëTønß˘i⁄
(
åx_id
);

53 i‡(
åx
 -> 
	`gëSèã
(Ë=
ABORTED
) {

54 *
ªsu…
 = 0;

55  
nuŒ±r
;

58 
öt64_t
* 
ªt
 = 
	`föd_ªc‹d
(
èbÀ
, 
key
, 
åx
);

60 i‡(
åx
 -> 
	`gëSèã
(Ë=
ABORTED
) {

61 *
ªsu…
 = 0;

62  
nuŒ±r
;

65 *
ªsu…
 = 1;

66  
ªt
;

67 
	}
}

71 
	$upd©e
(
èbÀ_id
, 
öt64_t
 
key
, i¡64_t* 
vÆue
, 
åx_id
, * 
ªsu…
) {

72 
TabÀ
* 
èbÀ
 = 
	`gë_èbÀ
(
èbÀ_id
);

73 
Tønß˘i⁄M™agî
* 
tm
 = &
åx_sys
;

75 
åx_t
* 
åx
 = 
tm
 -> 
	`gëTønß˘i⁄
(
åx_id
);

77 i‡(
åx
 -> 
	`gëSèã
(Ë=
ABORTED
) {

78 *
ªsu…
 = 0;

82 
ªt
 = 
	`upd©e_ªc‹d
(
èbÀ
, 
key
, 
vÆue
, 
åx
);

84 i‡(
åx
 -> 
	`gëSèã
(Ë=
ABORTED
) {

85 *
ªsu…
 = 0;

89  
ªt
;

90 
	}
}

96 
	$begö_tx
() {

97 
Tønß˘i⁄M™agî
* 
tm
 = &
åx_sys
;

98 
åx_t
* 
√w_t
 = 
tm
 -> 
	`makeNewTønß˘i⁄
();

99  
√w_t
 -> 
	`gëTønß˘i⁄Id
();

100 
	}
}

108 
	$íd_tx
(
åx_id
) {

109 
Tønß˘i⁄M™agî
* 
tm
 = &
åx_sys
;

110 
LockM™agî
* 
lm
 = &
lock_sys
;

112 
åx_t
* 
íd_t
 = 
tm
 -> 
	`gëTønß˘i⁄
(
åx_id
);

113 
boﬁ
 
ªt
;

114 i‡(
íd_t
 -> 
	`gëSèã
(Ë=
ABORTED
) {

115 
ªt
 = 
tm
->
	`dñëeTønß˘i⁄
(
åx_id
);

117 
íd_t
 -> 
	`£tSèã
(
NONE
);

119 
åue
) {

120 i‡(
lm
->
	`ªÀa£_lock
(
íd_t
))

124 
ªt
 = 
tm
 -> 
	`dñëeTønß˘i⁄
(
åx_id
);

126 i‡(!
ªt
)

127 
	`PANIC
("end_tx.\n");

130 
	}
}

141 
	$¥öt_åì
(
èbÀ_id
) {

142 
off_t
* 
queue
;

143 
i
;

144 
‰⁄t
 = 0;

145 
ª¨
 = 0;

147 
TabÀ
* 
èbÀ
 = 
	`gë_èbÀ
(
èbÀ_id
);

149 
	`¥öt_buf_poﬁ
();

150 i‡(
èbÀ
->
dbhódî
.
roŸ_off£t
 == 0) {

151 
	`¥ötf
("EmptyÅree.\n");

154 
queue
 = (
off_t
*)
	`mÆloc
((off_tË* 
BPTREE_MAX_NODE
);

156 
queue
[
ª¨
] = 
èbÀ
->
dbhódî
.
roŸ_off£t
;

157 
ª¨
++;

158 
queue
[
ª¨
] = 0;

159 
ª¨
++;

160 
‰⁄t
 < 
ª¨
) {

161 
off_t
 
∑ge_off£t
 = 
queue
[
‰⁄t
];

162 
‰⁄t
++;

164 i‡(
∑ge_off£t
 == 0) {

165 
	`¥ötf
("\n");

167 i‡(
‰⁄t
 =
ª¨
) ;

170 
queue
[
ª¨
] = 0;

171 
ª¨
++;

175 
NodePage
* 
node_∑ge
;

176 
node_∑ge
 = (
NodePage
*)
	`gë_∑ge
(
èbÀ
, 
	`FILEOFF_TO_PAGENUM
(
∑ge_off£t
));

177 i‡(
node_∑ge
->
is_Àaf
 == 1) {

179 
LófPage
* 
Àaf_node
 = (LófPage*)
node_∑ge
;

180 
i
 = 0; i < 
Àaf_node
->
num_keys
; i++) {

181 
	`¥ötf
("%" 
PRIu64
 " ", 
	`LEAF_KEY
(
Àaf_node
, 
i
));

183 
	`¥ötf
("| ");

186 
I¡î«lPage
* 
öã∫Æ_node
 = (I¡î«lPage*)
node_∑ge
;

187 
i
 = 0; i < 
öã∫Æ_node
->
num_keys
; i++) {

188 
	`¥ötf
("%" 
PRIu64
 " ", 
	`INTERNAL_KEY
(
öã∫Æ_node
, 
i
));

189 
queue
[
ª¨
] = 
	`INTERNAL_OFFSET
(
öã∫Æ_node
, 
i
);

190 
NodePage
* 
chûd_node
 = (NodePage*Ë
	`gë_∑ge
(
èbÀ
,

191 
	`FILEOFF_TO_PAGENUM
(
	`INTERNAL_OFFSET
(
öã∫Æ_node
, 
i
)));

192 i‡(
chûd_node
->
∑ª¡
 !
∑ge_off£t
){

193 
	`PANIC
("btree structure crashed");

195 
	`ªÀa£_∑ge
((
Page
*)
chûd_node
);

196 
ª¨
++;

198 
queue
[
ª¨
] = 
	`INTERNAL_OFFSET
(
öã∫Æ_node
, 
i
);

199 
ª¨
++;

200 
	`¥ötf
("| ");

202 
	`ªÀa£_∑ge
((
Page
*)
node_∑ge
);

204 
	`‰ì
(
queue
);

205 
	}
}

210 
	$föd_™d_¥öt
(
èbÀ_id
, 
öt64_t
 
key
) {

211 
öt64_t
* 
vÆue_found
 = 
NULL
;

212 
vÆue_found
 = 
	`föd
(
èbÀ_id
, 
key
);

213 i‡(
vÆue_found
 =
NULL
) {

214 
	`¥ötf
("Rec‹dÇŸ found undî key %" 
PRIu64
 ".\n", 
key
);

218 
	`‰ì
(
vÆue_found
);

220 
	}
}

224 
	$li˚n£_nŸi˚
( ) {

225 
	`¥ötf
("bpt version %s -- Copyright (C) 2010 Amittai Aviram "

226 "hâp://www.amôèi.com\n", 
Vîsi⁄
);

227 
	`¥ötf
("ThisÖrogram comes with ABSOLUTELY NO WARRANTY; for details "

231 
	}
}

235 
	$¥öt_li˚n£
–
li˚n£_∑π
 ) {

236 
°¨t
, 
íd
, 
löe
;

237 
FILE
 * 
Â
;

238 
buf„r
[0x100];

240 
li˚n£_∑π
) {

241 
LICENSE_WARRANTEE
:

242 
°¨t
 = 
LICENSE_WARRANTEE_START
;

243 
íd
 = 
LICENSE_WARRANTEE_END
;

245 
LICENSE_CONDITIONS
:

246 
°¨t
 = 
LICENSE_CONDITIONS_START
;

247 
íd
 = 
LICENSE_CONDITIONS_END
;

253 
Â
 = 
	`f›í
(
LICENSE_FILE
, "r");

254 i‡(
Â
 =
NULL
) {

255 
	`≥º‹
("print_license: fopen");

256 
	`exô
(
EXIT_FAILURE
);

258 
löe
 = 0;Üöê< 
°¨t
;Üine++)

259 
	`fgës
(
buf„r
, (buf„r), 
Â
);

260  ; 
löe
 < 
íd
;Üine++) {

261 
	`fgës
(
buf„r
, (buf„r), 
Â
);

262 
	`¥ötf
("%s", 
buf„r
);

264 
	`f˛o£
(
Â
);

265 
	}
}

269 
	$ußge_1
( ) {

270 
	`¥ötf
("B+ Tªêo‡Ordî %d(I¡î«l).\n", 
‹dî_öã∫Æ
);

271 
	`¥ötf
("Following Silberschatz, Korth, Sidarshan, Database Concepts, "

273 
	}
}

277 
	$ußge_2
( ) {

278 
	`¥ötf
("Enterány ofÅhe following commandsáfterÅheÖrompt > :\n"

287 
	}
}

	@src/buf.cpp

1 
	~<sys/ty≥s.h
>

2 
	~<f˙é.h
>

3 
	~<°dlib.h
>

4 
	~<as£π.h
>

5 
	~<°dio.h
>

6 
	~<uni°d.h
>

7 
	~<°rög.h
>

8 
	~"∑ge.h
"

9 
	~"fûe.h
"

10 
	~"buf.h
"

11 
	~"∑nic.h
"

13 
BufPoﬁ
 
	gpoﬁ
;

17 
	$Êush_∑ge
(
Page
* 
∑ge
) {

18 
	`fûe_wrôe_∑ge
(
	`gë_èbÀ
(
∑ge
->
èbÀ_id
),Öage->
∑gíum
,Öage);

19 
∑ge
->
is_dúty
 = 
Ál£
;

20 
	}
}

24 
	$p›_‰om_Ãu
(
Page
* 
∑ge
){

25 i‡(
∑ge
 =
poﬁ
.
Ãu_hód
 ||Öagê=poﬁ.
Ãu_èû
){

26 i‡(
∑ge
 =
poﬁ
.
Ãu_hód
){

27 
poﬁ
.
Ãu_hód
 = 
∑ge
->
Ãu_√xt
;

28 i‡(
∑ge
->
Ãu_√xt
)

29 
∑ge
->
Ãu_√xt
->
Ãu_¥ev
 = 
NULL
;

31 i‡(
∑ge
 =
poﬁ
.
Ãu_èû
){

32 
poﬁ
.
Ãu_èû
 = 
∑ge
->
Ãu_¥ev
;

33 i‡(
∑ge
->
Ãu_¥ev
)

34 
∑ge
->
Ãu_¥ev
->
Ãu_√xt
 = 
NULL
;

38 
∑ge
->
Ãu_¥ev
->
Ãu_√xt
 =Öage->lru_next;

39 
∑ge
->
Ãu_√xt
->
Ãu_¥ev
 =Öage->lru_prev;

42 
∑ge
->
Ãu_¥ev
 =Öage->
Ãu_√xt
 = 
NULL
;

44 
	}
}

48 
	$push_to_Ãu
(
Page
* 
∑ge
){

49 
∑ge
->
Ãu_√xt
 = 
poﬁ
.
Ãu_hód
;

50 i‡(
∑ge
->
Ãu_√xt
){

51 
∑ge
->
Ãu_√xt
->
Ãu_¥ev
 =Öage;

53 
∑ge
->
Ãu_¥ev
 = 
NULL
;

54 
poﬁ
.
Ãu_hód
 = 
∑ge
;

55 i‡(
poﬁ
.
Ãu_èû
 =
NULL
){

56 
poﬁ
.
Ãu_èû
 = 
∑ge
;

58 
	}
}

62 
Page
* 
	$evi˘_∑ge
(){

63 
Page
* 
∑ge
 = 
poﬁ
.
Ãu_èû
;

64 
∑ge
 !
NULL
){

65 i‡(
∑ge
->
pö˙t
 != 0){

66 
∑ge
 =Öage->
Ãu_¥ev
;

69 
	`p›_‰om_Ãu
(
∑ge
);

70 i‡(
∑ge
->
is_dúty
)

71 
	`Êush_∑ge
(
∑ge
);

72 
∑ge
->
Ãu_√xt
 =Öage->
Ãu_¥ev
 = 
NULL
;

73  
∑ge
;

75 
	`PANIC
("evict_page");

76 
	`exô
(1);

77 
	}
}

81 
	$upd©e_Ãu
(
Page
* 
∑ge
){

82 
	`p›_‰om_Ãu
(
∑ge
);

83 
	`push_to_Ãu
(
∑ge
);

84 
	}
}

88 
	$öô_√w_hódî_∑ge
(
HódîPage
* 
hódî
, 
èbÀ_id
, 
num_cﬁumn
) {

89 
	`mem£t
(
hódî
, 0, (
HódîPage
));

91 
hódî
->
èbÀ_id
 =Åable_id;

92 
hódî
->
∑gíum
 = 0;

93 
hódî
->
‰ìli°
 = 0;

94 
hódî
->
roŸ_off£t
 = 0;

95 
hódî
->
num_cﬁumn
 =Çum_column;

96 
hódî
->
num_∑ges
 = 1;

97 
	`£t_dúty_∑ge
((
Page
*)
hódî
);

98 
hódî
->
pö˙t
++;

99 
poﬁ
.
tŸ_pö˙t
++;

100 
	}
}

104 
	$lﬂd_hódî_∑ge
(
TabÀ
* 
èbÀ
) {

105 
	`fûe_ªad_∑ge
(
èbÀ
, 0, &èbÀ->
dbhódî
);

106 
èbÀ
->
dbhódî
.
èbÀ_id
 =Åable->table_id;

107 
èbÀ
->
dbhódî
.
∑gíum
 = 0;

108 
èbÀ
->
dbhódî
.
is_dúty
 = 
Ál£
;

109 
èbÀ
->
dbhódî
.
pö˙t
 = 1;

110 
èbÀ
->
dbhódî
.
Ãu_√xt
 = 
NULL
;

111 
èbÀ
->
dbhódî
.
Ãu_¥ev
 = 
NULL
;

112 
poﬁ
.
tŸ_pö˙t
++;

113 
	}
}

117 
Page
* 
	$Æloc_∑ge
(
TabÀ
* 
èbÀ
) {

118 
∑gíum_t
 
∑gíum
 = 
	`FILEOFF_TO_PAGENUM
(
èbÀ
->
dbhódî
.
‰ìli°
);

119 
FªePage
* 
‰ì∑ge
;

120 i‡(
∑gíum
 == 0){

121 
	`ex∑nd_fûe
(
èbÀ
,ÅabÀ->
dbhódî
.
num_∑ges
);

122 
∑gíum
 = 
	`FILEOFF_TO_PAGENUM
(
èbÀ
->
dbhódî
.
‰ìli°
);

124 
‰ì∑ge
 = (
FªePage
*)
	`gë_∑ge
(
èbÀ
, 
∑gíum
);

125 
èbÀ
->
dbhódî
.
‰ìli°
 = 
‰ì∑ge
->
√xt
;

127 
	`£t_dúty_∑ge
((
Page
*)&
èbÀ
->
dbhódî
);

128 
	`mem£t
(
‰ì∑ge
, 0, 
PAGE_SIZE
);

130 
	`£t_dúty_∑ge
((
Page
*)
‰ì∑ge
);

131  (
Page
*)
‰ì∑ge
;

132 
	}
}

136 
Page
* 
	$gë_∑ge
(
TabÀ
* 
èbÀ
, 
∑gíum_t
 
∑gíum
) {

137 
Page
* 
√w_∑ge
 = 
NULL
;

138 
i
;

139 
i
 = 0; i < 
poﬁ
.
num_buf
; i++){

140 i‡(!
√w_∑ge
 && 
poﬁ
.
∑ges
[
i
].
èbÀ_id
 == 0){

141 
√w_∑ge
 = &
poﬁ
.
∑ges
[
i
];

143 i‡(
poﬁ
.
∑ges
[
i
].
èbÀ_id
 =
èbÀ
->table_id &&

144 
poﬁ
.
∑ges
[
i
].
∑gíum
 ==Öagenum){

145 
poﬁ
.
∑ges
[
i
].
pö˙t
++;

146 
poﬁ
.
tŸ_pö˙t
++;

147  &
poﬁ
.
∑ges
[
i
];

150 i‡(!
√w_∑ge
){

151 i‡((
√w_∑ge
 = 
	`evi˘_∑ge
()Ë=
NULL
){

152 
	`PANIC
("NotÉnough buffer\n");

154 i‡(
√w_∑ge
->
is_dúty
){

155 
	`Êush_∑ge
(
√w_∑ge
);

158 
	`fûe_ªad_∑ge
(
èbÀ
, 
∑gíum
, 
√w_∑ge
);

159 
√w_∑ge
->
èbÀ_id
 = 
èbÀ
->table_id;

160 
√w_∑ge
->
∑gíum
 =Öagenum;

161 
√w_∑ge
->
pö˙t
 = 1;

162 
poﬁ
.
tŸ_pö˙t
++;

163 
	`push_to_Ãu
(
√w_∑ge
);

164  
√w_∑ge
;

165 
	}
}

171 
Page
* 
	$gë_∑ge
(
TabÀ
* 
èbÀ
, 
∑gíum_t
 
∑gíum
, * 
buf_∑ge_i
) {

172 
Page
* 
√w_∑ge
 = 
NULL
;

173 
i
;

174 
√w_∑ge_i
;

175 
i
 = 0; i < 
poﬁ
.
num_buf
; i++){

176 i‡(!
√w_∑ge
 && 
poﬁ
.
∑ges
[
i
].
èbÀ_id
 == 0){

177 
√w_∑ge
 = &
poﬁ
.
∑ges
[
i
];

178 
√w_∑ge_i
 = 
i
;

180 i‡(
poﬁ
.
∑ges
[
i
].
èbÀ_id
 =
èbÀ
->table_id &&

181 
poﬁ
.
∑ges
[
i
].
∑gíum
 ==Öagenum){

183 
√w_∑ge
 = &
poﬁ
.
∑ges
[
i
];

184 i‡(((
LófPage
*)
√w_∑ge
Ë-> 
is_Àaf
) {

185 
	`BUF_PAGE_MUTEX_ENTER
(
i
);

187 i‡(
ªt
) {

188 *
buf_∑ge_i
 = 
i
;

189 
poﬁ
.
∑ges
[
i
].
pö˙t
++;

190 
poﬁ
.
tŸ_pö˙t
++;

191  &
poﬁ
.
∑ges
[
i
];

194  
nuŒ±r
;

197 
poﬁ
.
∑ges
[
i
].
pö˙t
++;

198 
poﬁ
.
tŸ_pö˙t
++;

199  &
poﬁ
.
∑ges
[
i
];

204 i‡(!
√w_∑ge
){

205 i‡((
√w_∑ge
 = 
	`evi˘_∑ge
()Ë=
NULL
){

206 
	`PANIC
("NotÉnough buffer\n");

208 i‡(
√w_∑ge
->
is_dúty
){

209 
	`Êush_∑ge
(
√w_∑ge
);

213 
	`BUF_PAGE_MUTEX_ENTER
(
√w_∑ge_i
);

215 i‡(!
ªt
)

216 
	`PANIC
("EvictedÖage holdÅheÜatch\n");

218 
	`fûe_ªad_∑ge
(
èbÀ
, 
∑gíum
, 
√w_∑ge
);

219 
√w_∑ge
->
èbÀ_id
 = 
èbÀ
->table_id;

220 
√w_∑ge
->
∑gíum
 =Öagenum;

221 
√w_∑ge
->
pö˙t
 = 1;

222 
poﬁ
.
tŸ_pö˙t
++;

223 *
buf_∑ge_i
 = 
√w_∑ge_i
;

224 
	`push_to_Ãu
(
√w_∑ge
);

225  
√w_∑ge
;

226 
	}
}

231 
	$ªÀa£_hódî_∑ge
(
TabÀ
* 
èbÀ
) {

232 i‡(
èbÀ
->
dbhódî
.
is_dúty
){

233 
	`fûe_wrôe_∑ge
(
èbÀ
, 0, &èbÀ->
dbhódî
);

234 
èbÀ
->
dbhódî
.
is_dúty
 = 
Ál£
;

236 
	`mem£t
(&
èbÀ
->
dbhódî
, 0, (
HódîPage
));

237 
poﬁ
.
tŸ_pö˙t
--;

238 
	}
}

242 
	$ªÀa£_∑ge
(
Page
* 
∑ge
) {

243 
poﬁ
.
tŸ_pö˙t
--;

244 
∑ge
->
pö˙t
--;

245 
	}
}

250 
	$ªÀa£_∑ge
(
Page
* 
∑ge
, * 
buf_∑ge_i
) {

251 
poﬁ
.
tŸ_pö˙t
--;

252 
∑ge
->
pö˙t
--;

253 
poﬁ
.
buf_∑ge_muãx
[*
buf_∑ge_i
].
	`u∆ock
();

254 
	}
}

258 
	$£t_dúty_∑ge
(
Page
* 
∑ge
) {

259 
∑ge
->
is_dúty
 = 
åue
;

260 
	}
}

264 
	$‰ì_∑ge
(
TabÀ
* 
èbÀ
, 
Page
* 
∑ge
) {

265 
FªePage
* 
‰ì∑ge
 = (FªePage*)
∑ge
;

266 
	`mem£t
(
‰ì∑ge
, 0, 
PAGE_SIZE
);

267 
‰ì∑ge
->
√xt
 = 
èbÀ
->
dbhódî
.
‰ìli°
;

268 
	`£t_dúty_∑ge
(
∑ge
);

269 
èbÀ
->
dbhódî
.
‰ìli°
 = 
	`PAGENUM_TO_FILEOFF
(
‰ì∑ge
->
∑gíum
);

270 
	`£t_dúty_∑ge
((
Page
*)&
èbÀ
->
dbhódî
);

271 
	}
}

275 
	$Êush_èbÀ
(
TabÀ
* 
èbÀ
) {

276 
i
;

277 
i
 = 0; i < 
poﬁ
.
num_buf
; i++){

278 i‡(
poﬁ
.
∑ges
[
i
].
èbÀ_id
 =
èbÀ
->table_id &&

279 
poﬁ
.
∑ges
[
i
].
is_dúty
){

280 
	`Êush_∑ge
(&
poﬁ
.
∑ges
[
i
]);

283 
	}
}

287 
	$öô_buf_poﬁ
(
num_buf
) {

288 
poﬁ
.
∑ges
 = (
Page
*Ë
	`ˇŒoc
(
num_buf
, (Page));

289 
poﬁ
.
buf_∑ge_muãx
 = 
√w
 
°d
::
muãx
[
num_buf
];

291 
poﬁ
.
Ãu_hód
 = 
NULL
;

292 
poﬁ
.
Ãu_èû
 = 
NULL
;

293 
poﬁ
.
num_buf
 =Çum_buf;

294 
poﬁ
.
tŸ_pö˙t
 = 0;

296 
	}
}

300 
	$de°roy_buf_poﬁ
() {

301 
	`‰ì
(
poﬁ
.
∑ges
);

302 
dñëe
[] 
poﬁ
.
buf_∑ge_muãx
;

304 
poﬁ
.
∑ges
 = 
NULL
;

305 
poﬁ
.
Ãu_hód
 = 
NULL
;

306 
poﬁ
.
Ãu_èû
 = 
NULL
;

307 
poﬁ
.
num_buf
 = 0;

308 
poﬁ
.
tŸ_pö˙t
 = 0;

310 
	}
}

314 
	$¥öt_buf_poﬁ
() {

315 
	`¥ötf
("tŸÖö˙à%d\n", 
poﬁ
.
tŸ_pö˙t
);

316 
	}
}

	@src/deadlock.cpp

1 
	~"dódlock.h
"

7 
	gDLCheckî
::
	$öôülize_èrj™_acy˛ic
() {

8 !
s_èrj™
.
	`em±y
())

9 
s_èrj™
.
	`p›
();

11 
dfs_‹dî
 = -1;

12 
cy˛e_Êag
 = 
Ál£
;

14 autÿ
ô
 = 
dl_gøph
.
	`begö
(); ià!dl_gøph.
	`íd
(); ++it) {

15 (
ô
 -> 
£c⁄d
).
föished
 = 
Ál£
;

16 (
ô
 -> 
£c⁄d
).
dfs_‹dî
 = -1;

18 
	}
}

25 
	gDLCheckî
::
	$öôülize_èrj™_cy˛ic
() {

26 !
s_èrj™
.
	`em±y
())

27 
s_èrj™
.
	`p›
();

29 
dfs_‹dî
 = -1;

30 
cy˛e_Êag
 = 
Ál£
;

32 
dl_gøph
.
	`îa£
(
œã°_åx_id
);

34 
°d
::
ve˘‹
<> 
îa£_li°
;

35 autÿ
ô
 = 
dl_gøph
.
	`begö
(); ià!dl_gøph.
	`íd
(); ++it) {

36 i‡((
ô
 -> 
£c⁄d
).
waôög_åx_id
 =
œã°_åx_id
)

37 
îa£_li°
.
	`push_back
(
ô
->
fú°
);

40 (
ô
 -> 
£c⁄d
).
föished
 = 
Ál£
;

41 (
ô
 -> 
£c⁄d
).
dfs_‹dî
 = -1;

45 autÿ
i
 : 
îa£_li°
)

46 
dl_gøph
.
	`îa£
(
i
);

48 
	}
}

55 
	gDLCheckî
::
	$dfs_èrj™
(
èrj™_t
* 
cur
) {

56 
cur
->
dfs_‹dî
 = ++
this
->dfs_order;

57 
s_èrj™
.
	`push
(
cur
);

59 
mö_‹dî
 = 
cur
->
dfs_‹dî
;

61 i‡(
dl_gøph
.
	`cou¡
(
cur
->
waôög_åx_id
) != 0){

63 
èrj™_t
* 
√xt
 = &(
dl_gøph
[
cur
->
waôög_åx_id
]);

64 i‡(
√xt
->
dfs_‹dî
 == -1)

65 
mö_‹dî
 = 
°d
::
	`mö
(mö_‹dî, 
	`dfs_èrj™
(
√xt
));

66 i‡(!
√xt
->
föished
)

67 
mö_‹dî
 = 
°d
::
	`mö
(mö_‹dî, 
√xt
->
dfs_‹dî
);

70 i‡(
cy˛e_Êag
)

71  
INT_MAX
;

73 i‡(
mö_‹dî
 =
cur
->
dfs_‹dî
) {

74 
èrj™_t
* 
tmp
 = 
nuŒ±r
;

75 
˙t_size
 = 0;

77 i‡(
˙t_size
 == 1)

78 
cy˛e_Êag
 = 
åue
;

79 
˙t_size
++;

80 
tmp
 = 
s_èrj™
.
	`t›
();

81 
s_èrj™
.
	`p›
();

83 i‡(
cur
 =
tmp
)

87 
cur
 -> 
föished
 = 
åue
;

88  
mö_‹dî
;

89 
	}
}

96 
boﬁ
 
	gDLCheckî
::
	$is_cy˛ic
() {

97 autÿ
ô
 = 
dl_gøph
.
	`begö
(); ià!dl_gøph.
	`íd
(); ++it) {

99 i‡(
ô
->
£c⁄d
.
dfs_‹dî
 == -1)

100 
	`dfs_èrj™
(&(
ô
->
£c⁄d
));

102 i‡(
cy˛e_Êag
) {

103 
	`öôülize_èrj™_cy˛ic
();

104  
åue
;

108 
	`öôülize_èrj™_acy˛ic
();

109  
Ál£
;

110 
	}
}

120 
boﬁ
 
	gDLCheckî
::
	$dódlock_checkög
(
åx_id
, 
waô_f‹
) {

122 i‡(
dl_gøph
.
	`cou¡
(
åx_id
) != 0)

123 
	`PANIC
("In deadlock checking. TheÅransaction cannot wait for moreÅhan oneÅransaction.\n");

125 
èrj™_t
 
	`cur
(
waô_f‹
);

126 
œã°_åx_id
 = 
åx_id
;

128 
dl_gøph
[
åx_id
] = 
cur
;

130  
	`is_cy˛ic
();

131 
	}
}

141 
boﬁ
 
	gDLCheckî
::
	$ch™ge_waôög_f‹
(
åx_id
, 
waô_f‹
) {

143 i‡(
dl_gøph
.
	`cou¡
(
åx_id
) == 0)

144 
	`PANIC
("In change_waiting_for. There isÇo waitingÅransaction by current one.\n");

146 
èrj™_t
 
	`cur
(
waô_f‹
);

147 
œã°_åx_id
 = 
åx_id
;

149 
dl_gøph
[
åx_id
] = 
cur
;

151  
	`is_cy˛ic
();

152 
	}
}

161 
	gDLCheckî
::
	$dñëe_waôög_f‹_åx
(
åx_id
) {

162 
°d
::
ve˘‹
<> 
îa£_li°
;

164 i‡(
dl_gøph
.
	`cou¡
(
åx_id
) == 0)

167 
dl_gøph
.
	`îa£
(
åx_id
);

169 autÿ
ô
 = 
dl_gøph
.
	`begö
(); ià!dl_gøph.
	`íd
(); ++it) {

170 i‡((
ô
 -> 
£c⁄d
).
waôög_åx_id
 =
åx_id
)

171 
îa£_li°
.
	`push_back
(
ô
 -> 
fú°
);

174 autÿ
i
 : 
îa£_li°
)

175 
dl_gøph
.
	`îa£
(
i
);

176 
	}
}

	@src/delete.cpp

1 
	~"b±_öã∫Æ.h
"

9 
	$gë_√ighb‹_ödex
(
TabÀ
* 
èbÀ
, 
NodePage
* 
node_∑ge
) {

10 
i
;

15 
I¡î«lPage
* 
∑ª¡_node
;

16 
∑ª¡_node
 = (
I¡î«lPage
*)

17 
	`gë_∑ge
(
èbÀ
, 
	`FILEOFF_TO_PAGENUM
(
node_∑ge
->
∑ª¡
));

18 
i
 = 0; i <
∑ª¡_node
->
num_keys
; i++)

19 i‡(
	`INTERNAL_OFFSET
(
∑ª¡_node
, 
i
)

20 =
	`PAGENUM_TO_FILEOFF
(
node_∑ge
->
∑gíum
)){

21 
	`ªÀa£_∑ge
((
Page
*)
∑ª¡_node
);

22  
i
 - 1;

26 
	`PANIC
("Search forÇonexistentÖointerÅoÇode inÖarent.");

28 
	}
}

30 
	$ªmove_íåy_‰om_node
(
TabÀ
* 
èbÀ
, 
NodePage
* 
node_∑ge
, 
öt64_t
 
key
) {

31 
i
;

32 
key_idx
 = 0;

34 i‡(
node_∑ge
->
is_Àaf
) {

35 
LófPage
* 
Àaf_node
 = (LófPage*)
node_∑ge
;

38 
i
 = 0; i < 
Àaf_node
->
num_keys
; i++) {

39 i‡(
	`LEAF_KEY
(
Àaf_node
, 
i
Ë=
key
) {

40 
key_idx
 = 
i
;

44 i‡(
i
 =
Àaf_node
->
num_keys
) {

45 
	`PANIC
("remove_entry_from_node:Ço key inÅhisÖage");

49 
i
 = 
key_idx
; i < 
Àaf_node
->
num_keys
 - 1; i++) {

50 
	`LEAF_KEY
(
Àaf_node
, 
i
) = LEAF_KEY(leaf_node, i+1);

51 
	`mem˝y
(
	`LEAF_VALUE
(
Àaf_node
, 
i
), LEAF_VALUE(leaf_node, i+1),

52 
SIZE_VALUE
);

55 
	`LEAF_KEY
(
Àaf_node
,Üóf_node->
num_keys
 - 1) = 0;

56 
	`mem£t
(
	`LEAF_VALUE
(
Àaf_node
,Üóf_node->
num_keys
 - 1), 0, 
SIZE_VALUE
);

58 
Àaf_node
->
num_keys
--;

60 
I¡î«lPage
* 
öã∫Æ_node
 = (I¡î«lPage*)
node_∑ge
;

63 
i
 = 0; i < 
öã∫Æ_node
->
num_keys
; i++) {

64 i‡(
	`INTERNAL_KEY
(
öã∫Æ_node
, 
i
Ë=
key
) {

65 
key_idx
 = 
i
;

69 i‡(
i
 =
öã∫Æ_node
->
num_keys
) {

70 
	`PANIC
("remove_entry_from_node:Ço key inÅhisÖage");

74 
i
 = 
key_idx
; i < 
öã∫Æ_node
->
num_keys
 - 1; i++) {

75 
	`INTERNAL_KEY
(
öã∫Æ_node
, 
i
) = INTERNAL_KEY(internal_node, i+1);

76 
	`INTERNAL_OFFSET
(
öã∫Æ_node
, 
i
+1) =

77 
	`INTERNAL_OFFSET
(
öã∫Æ_node
, 
i
+2);

80 
	`INTERNAL_KEY
(
öã∫Æ_node
, i¡î«l_node->
num_keys
 - 1) = 0;

81 
	`INTERNAL_OFFSET
(
öã∫Æ_node
, i¡î«l_node->
num_keys
) = 0;

83 
öã∫Æ_node
->
num_keys
--;

85 
	}
}

87 
	$adju°_roŸ
(
TabÀ
* 
èbÀ
, 
NodePage
* 
roŸ_∑ge
) {

92 i‡(
roŸ_∑ge
->
num_keys
 > 0){

102 i‡(!
roŸ_∑ge
->
is_Àaf
) {

103 
I¡î«lPage
* 
roŸ_node
 = (I¡î«lPage*)
roŸ_∑ge
;

104 
èbÀ
->
dbhódî
.
roŸ_off£t
 = 
	`INTERNAL_OFFSET
(
roŸ_node
, 0);

106 
NodePage
* 
node_∑ge
;

107 
node_∑ge
 = (
NodePage
*Ë
	`gë_∑ge
(
èbÀ
,

108 
	`FILEOFF_TO_PAGENUM
(
èbÀ
->
dbhódî
.
roŸ_off£t
));

109 
	`£t_dúty_∑ge
((
Page
*)
node_∑ge
);

111 
node_∑ge
->
∑ª¡
 = 0;

113 
	`ªÀa£_∑ge
((
Page
*)
node_∑ge
);

120 
èbÀ
->
dbhódî
.
roŸ_off£t
 = 0;

122 
	`£t_dúty_∑ge
((
Page
*)&
èbÀ
->
dbhódî
);

124 
	`‰ì_∑ge
(
èbÀ
, (
Page
*)
roŸ_∑ge
);

125 
	}
}

130 
	$cﬂÀs˚_nodes
(
TabÀ
* 
èbÀ
, 
NodePage
* 
node_∑ge
, NodePage* 
√ighb‹_∑ge
,

131 
√ighb‹_ödex
, 
k_¥ime
) {

133 
i
, 
j
, 
√ighb‹_ö£πi⁄_ödex
, 
n_íd
;

134 
NodePage
* 
tmp
;

140 i‡(
√ighb‹_ödex
 == -1) {

141 
tmp
 = 
node_∑ge
;

142 
node_∑ge
 = 
√ighb‹_∑ge
;

143 
√ighb‹_∑ge
 = 
tmp
;

151 
√ighb‹_ö£πi⁄_ödex
 = 
√ighb‹_∑ge
->
num_keys
;

158 i‡(!
node_∑ge
->
is_Àaf
) {

159 
I¡î«lPage
* 
node
 = (I¡î«lPage*)
node_∑ge
;

160 
I¡î«lPage
* 
√ighb‹_node
 = (I¡î«lPage*)
√ighb‹_∑ge
;

165 
	`INTERNAL_KEY
(
√ighb‹_node
, 
√ighb‹_ö£πi⁄_ödex
Ë
k_¥ime
;

166 
√ighb‹_node
->
num_keys
++;

168 
n_íd
 = 
node
->
num_keys
;

170 
i
 = 
√ighb‹_ö£πi⁄_ödex
 + 1, 
j
 = 0; j < 
n_íd
; i++, j++) {

171 
	`INTERNAL_KEY
(
√ighb‹_node
, 
i
ËINTERNAL_KEY(
node
, 
j
);

172 
	`INTERNAL_OFFSET
(
√ighb‹_node
, 
i
ËINTERNAL_OFFSET(
node
, 
j
);

173 
√ighb‹_node
->
num_keys
++;

174 
node
->
num_keys
--;

180 
	`INTERNAL_OFFSET
(
√ighb‹_node
, 
i
ËINTERNAL_OFFSET(
node
, 
j
);

185 
i
 = 0; i < 
√ighb‹_node
->
num_keys
 + 1; i++) {

186 
NodePage
* 
chûd_∑ge
;

187 
chûd_∑ge
 = (
NodePage
*)
	`gë_∑ge
(
èbÀ
,

188 
	`FILEOFF_TO_PAGENUM
(
	`INTERNAL_OFFSET
(
√ighb‹_node
, 
i
)));

189 
chûd_∑ge
->
∑ª¡
 = 
	`PAGENUM_TO_FILEOFF
(
√ighb‹_node
->
∑gíum
);

190 
	`£t_dúty_∑ge
((
Page
*)
chûd_∑ge
);

191 
	`ªÀa£_∑ge
((
Page
*)
chûd_∑ge
);

194 
	`‰ì_∑ge
(
èbÀ
, (
Page
*)
node
);

203 
LófPage
* 
node
 = (LófPage*)
node_∑ge
;

204 
LófPage
* 
√ighb‹_node
 = (LófPage*)
√ighb‹_∑ge
;

206 
i
 = 
√ighb‹_ö£πi⁄_ödex
, 
j
 = 0; j < 
node
->
num_keys
; i++, j++) {

207 
	`LEAF_KEY
(
√ighb‹_node
, 
i
ËLEAF_KEY(
node
, 
j
);

208 
	`mem˝y
(
	`LEAF_VALUE
(
√ighb‹_node
, 
i
), LEAF_VALUE(
node
, 
j
),

209 
SIZE_VALUE
);

210 
√ighb‹_node
->
num_keys
++;

212 
√ighb‹_node
->
siblög
 = 
node
->sibling;

214 
	`‰ì_∑ge
(
èbÀ
, (
Page
*)
node
);

217 
NodePage
* 
∑ª¡_node
;

218 
∑ª¡_node
 = (
NodePage
*Ë
	`gë_∑ge
(
èbÀ
,

219 
	`FILEOFF_TO_PAGENUM
(
√ighb‹_∑ge
->
∑ª¡
));

220 
	`£t_dúty_∑ge
((
Page
*)
∑ª¡_node
);

221 
	`dñëe_íåy
(
èbÀ
, 
∑ª¡_node
, 
k_¥ime
);

222 
	`ªÀa£_∑ge
((
Page
*)
∑ª¡_node
);

223 
	}
}

229 
	$ªdi°ribuã_nodes
(
TabÀ
* 
èbÀ
, 
NodePage
* 
node_∑ge
, NodePage* 
√ighb‹_∑ge
,

230 
√ighb‹_ödex
,

231 
k_¥ime_ödex
, 
k_¥ime
) {

233 
i
;

240 i‡(
√ighb‹_ödex
 != -1) {

241 i‡(!
node_∑ge
->
is_Àaf
) {

242 
I¡î«lPage
* 
node
 = (I¡î«lPage*)
node_∑ge
;

243 
I¡î«lPage
* 
√ighb‹_node
 = (I¡î«lPage*)
√ighb‹_∑ge
;

244 
	`INTERNAL_OFFSET
(
node
,Çode->
num_keys
 + 1) =

245 
	`INTERNAL_OFFSET
(
node
,Çode->
num_keys
);

247 
i
 = 
node
->
num_keys
; i > 0; i--) {

248 
	`INTERNAL_KEY
(
node
, 
i
) = INTERNAL_KEY(node, i - 1);

249 
	`INTERNAL_OFFSET
(
node
, 
i
) = INTERNAL_OFFSET(node, i - 1);

251 
	`INTERNAL_OFFSET
(
node
, 0) =

252 
	`INTERNAL_OFFSET
(
√ighb‹_node
,Çeighb‹_node->
num_keys
);

253 
NodePage
* 
chûd_∑ge
 = (NodePage*)
	`gë_∑ge
(
èbÀ
,

254 
	`FILEOFF_TO_PAGENUM
(
	`INTERNAL_OFFSET
(
node
, 0)));

255 
	`£t_dúty_∑ge
((
Page
*)
chûd_∑ge
);

256 
chûd_∑ge
->
∑ª¡
 = 
	`PAGENUM_TO_FILEOFF
(
node
->
∑gíum
);

257 
	`ªÀa£_∑ge
((
Page
*)
chûd_∑ge
);

259 
	`INTERNAL_OFFSET
(
√ighb‹_node
,Çeighb‹_node->
num_keys
) = 0;

260 
	`INTERNAL_KEY
(
node
, 0Ë
k_¥ime
;

262 
I¡î«lPage
* 
∑ª¡_node
 = (I¡î«lPage*)
	`gë_∑ge
(
èbÀ
,

263 
	`FILEOFF_TO_PAGENUM
(
node
->
∑ª¡
));

264 
	`INTERNAL_KEY
(
∑ª¡_node
, 
k_¥ime_ödex
) =

265 
	`INTERNAL_KEY
(
√ighb‹_node
,Çeighb‹_node->
num_keys
 - 1);

267 
	`£t_dúty_∑ge
((
Page
*)
∑ª¡_node
);

268 
	`ªÀa£_∑ge
((
Page
*)
∑ª¡_node
);

273 
node
->
num_keys
++;

274 
√ighb‹_node
->
num_keys
--;

276 
LófPage
* 
node
 = (LófPage*)
node_∑ge
;

277 
LófPage
* 
√ighb‹_node
 = (LófPage*)
√ighb‹_∑ge
;

279 
i
 = 
node
->
num_keys
; i > 0; i--) {

280 
	`LEAF_KEY
(
node
, 
i
) = LEAF_KEY(node, i - 1);

281 
	`mem˝y
(
	`LEAF_VALUE
(
node
, 
i
), LEAF_VALUE“ode, i - 1), 
SIZE_VALUE
);

283 
	`mem˝y
(
	`LEAF_VALUE
(
node
, 0),

284 
	`LEAF_VALUE
(
√ighb‹_node
,Çeighb‹_node->
num_keys
 - 1),

285 
SIZE_VALUE
);

286 
	`mem£t
(
	`LEAF_VALUE
(
√ighb‹_node
,Çeighb‹_node->
num_keys
 - 1), 0,

287 
SIZE_VALUE
);

288 
	`LEAF_KEY
(
node
, 0ËLEAF_KEY(
√ighb‹_node
,Çeighb‹_node->
num_keys
 - 1);

290 
I¡î«lPage
* 
∑ª¡_node
;

291 
∑ª¡_node
 = (
I¡î«lPage
*)
	`gë_∑ge
(
èbÀ
,

292 
	`FILEOFF_TO_PAGENUM
(
node
->
∑ª¡
));

293 
	`INTERNAL_KEY
(
∑ª¡_node
, 
k_¥ime_ödex
Ë
	`LEAF_KEY
(
node
, 0);

294 
	`£t_dúty_∑ge
((
Page
*)
∑ª¡_node
);

295 
	`ªÀa£_∑ge
((
Page
*)
∑ª¡_node
);

300 
node
->
num_keys
++;

301 
√ighb‹_node
->
num_keys
--;

311 i‡(
node_∑ge
->
is_Àaf
) {

312 
LófPage
* 
node
 = (LófPage*)
node_∑ge
;

313 
LófPage
* 
√ighb‹_node
 = (LófPage*)
√ighb‹_∑ge
;;

315 
	`LEAF_KEY
(
node
,Çode->
num_keys
ËLEAF_KEY(
√ighb‹_node
, 0);

316 
	`mem˝y
(
	`LEAF_VALUE
(
node
,Çode->
num_keys
), LEAF_VALUE(
√ighb‹_node
, 0),

317 
SIZE_VALUE
);

319 
I¡î«lPage
* 
∑ª¡_node
;

320 
∑ª¡_node
 = (
I¡î«lPage
*)
	`gë_∑ge
(
èbÀ
,

321 
	`FILEOFF_TO_PAGENUM
(
node
->
∑ª¡
));

322 
	`INTERNAL_KEY
(
∑ª¡_node
, 
k_¥ime_ödex
Ë
	`LEAF_KEY
(
√ighb‹_node
, 1);

323 
	`£t_dúty_∑ge
((
Page
*)
∑ª¡_node
);

324 
	`ªÀa£_∑ge
((
Page
*)
∑ª¡_node
);

326 
i
 = 0; i < 
√ighb‹_node
->
num_keys
 - 1; i++) {

327 
	`LEAF_KEY
(
√ighb‹_node
, 
i
) = LEAF_KEY(neighbor_node, i + 1);

328 
	`mem˝y
(
	`LEAF_VALUE
(
√ighb‹_node
, 
i
), LEAF_VALUE(neighbor_node, i + 1),

329 
SIZE_VALUE
);

335 
node
->
num_keys
++;

336 
√ighb‹_node
->
num_keys
--;

339 
I¡î«lPage
* 
node
 = (I¡î«lPage*)
node_∑ge
;

340 
I¡î«lPage
* 
√ighb‹_node
 = (I¡î«lPage*)
√ighb‹_∑ge
;

342 
	`INTERNAL_KEY
(
node
,Çode->
num_keys
Ë
k_¥ime
;

343 
	`INTERNAL_OFFSET
(
node
,Çode->
num_keys
 + 1) =

344 
	`INTERNAL_OFFSET
(
√ighb‹_node
, 0);

346 
NodePage
* 
chûd_∑ge
;

347 
chûd_∑ge
 = (
NodePage
*)
	`gë_∑ge
(
èbÀ
, 
	`FILEOFF_TO_PAGENUM
(

348 
	`INTERNAL_OFFSET
(
node
,Çode->
num_keys
 + 1)));

349 
chûd_∑ge
->
∑ª¡
 = 
	`PAGENUM_TO_FILEOFF
(
node
->
∑gíum
);

350 
	`£t_dúty_∑ge
((
Page
*)
chûd_∑ge
);

351 
	`ªÀa£_∑ge
((
Page
*)
chûd_∑ge
);

353 
I¡î«lPage
* 
∑ª¡_node
;

354 
∑ª¡_node
 = (
I¡î«lPage
*)
	`gë_∑ge
(
èbÀ
,

355 
	`FILEOFF_TO_PAGENUM
(
node
->
∑ª¡
));

356 
	`INTERNAL_KEY
(
∑ª¡_node
, 
k_¥ime_ödex
) =

357 
	`INTERNAL_KEY
(
√ighb‹_node
, 0);

358 
	`£t_dúty_∑ge
((
Page
*)
∑ª¡_node
);

359 
	`ªÀa£_∑ge
((
Page
*)
∑ª¡_node
);

361 
i
 = 0; i < 
√ighb‹_node
->
num_keys
 - 1; i++) {

362 
	`INTERNAL_KEY
(
√ighb‹_node
, 
i
) = INTERNAL_KEY(neighbor_node, i + 1);

363 
	`INTERNAL_OFFSET
(
√ighb‹_node
, 
i
) =

364 
	`INTERNAL_OFFSET
(
√ighb‹_node
, 
i
 + 1);

367 
	`INTERNAL_OFFSET
(
√ighb‹_node
, 
i
) = INTERNAL_OFFSET(neighbor_node, i + 1);

374 
node
->
num_keys
++;

375 
√ighb‹_node
->
num_keys
--;

378 
	}
}

385 
	$dñëe_íåy
(
TabÀ
* 
èbÀ
, 
NodePage
* 
node_∑ge
, 
öt64_t
 
key
) {

387 
mö_keys
;

388 
off_t
 
√ighb‹_off£t
;

389 
√ighb‹_ödex
;

390 
k_¥ime_ödex
, 
k_¥ime
;

391 
ˇ∑côy
;

395 
	`ªmove_íåy_‰om_node
(
èbÀ
, 
node_∑ge
, 
key
);

399 i‡(
èbÀ
->
dbhódî
.
roŸ_off£t
 =
	`PAGENUM_TO_FILEOFF
(
node_∑ge
->
∑gíum
)) {

400 
	`adju°_roŸ
(
èbÀ
, 
node_∑ge
);

411 #ifde‡
IS_DELAYED_MERGE


412 
mö_keys
 = 1;

414 
mö_keys
 = 
node_∑ge
->
is_Àaf
 ? 
	`cut
(
‹dî_Àaf
 - 1Ë: cut(
‹dî_öã∫Æ
) - 1;

421 i‡(
node_∑ge
->
num_keys
 >
mö_keys
)

433 
√ighb‹_ödex
 = 
	`gë_√ighb‹_ödex
(
èbÀ
, 
node_∑ge
);

434 
k_¥ime_ödex
 = 
√ighb‹_ödex
 == -1 ? 0 :Çeighbor_index;

436 
I¡î«lPage
* 
∑ª¡_node
;

437 
∑ª¡_node
 = (
I¡î«lPage
*)

438 
	`gë_∑ge
(
èbÀ
, 
	`FILEOFF_TO_PAGENUM
(
node_∑ge
->
∑ª¡
));

440 
k_¥ime
 = 
	`INTERNAL_KEY
(
∑ª¡_node
, 
k_¥ime_ödex
);

441 
√ighb‹_off£t
 = 
√ighb‹_ödex
 =-1 ? 
	`INTERNAL_OFFSET
(
∑ª¡_node
, 1) :

442 
	`INTERNAL_OFFSET
(
∑ª¡_node
, 
√ighb‹_ödex
);

443 
	`ªÀa£_∑ge
((
Page
*)
∑ª¡_node
);

445 
ˇ∑côy
 = 
node_∑ge
->
is_Àaf
 ? 
‹dî_Àaf
 : 
‹dî_öã∫Æ
 - 1;

447 
NodePage
* 
√ighb‹_∑ge
;

448 
√ighb‹_∑ge
 = (
NodePage
*Ë
	`gë_∑ge
(
èbÀ
,

449 
	`FILEOFF_TO_PAGENUM
(
√ighb‹_off£t
));

450 
	`£t_dúty_∑ge
((
Page
*)
√ighb‹_∑ge
);

453 i‡(
√ighb‹_∑ge
->
num_keys
 + 
node_∑ge
->num_key†< 
ˇ∑côy
){

454 
	`cﬂÀs˚_nodes
(
èbÀ
, 
node_∑ge
, 
√ighb‹_∑ge
, 
√ighb‹_ödex
, 
k_¥ime
);

458 
	`ªdi°ribuã_nodes
(
èbÀ
, 
node_∑ge
, 
√ighb‹_∑ge
, 
√ighb‹_ödex
,

459 
k_¥ime_ödex
, 
k_¥ime
);

461 
	`ªÀa£_∑ge
((
Page
*)
√ighb‹_∑ge
);

462 
	}
}

466 
	$dñëe_ªc‹d
(
TabÀ
* 
èbÀ
, 
öt64_t
 
key
) {

467 
öt64_t
* 
vÆue_found
 = 
NULL
;

468 i‡((
vÆue_found
 = 
	`föd_ªc‹d
(
èbÀ
, 
key
)) == 0) {

470 
	`‰ì
(
vÆue_found
);

474 
LófPage
* 
Àaf_node
;

475 
	`föd_Àaf
(
èbÀ
, 
key
, &
Àaf_node
);

476 
	`£t_dúty_∑ge
((
Page
*)
Àaf_node
);

478 
	`dñëe_íåy
(
èbÀ
, (
NodePage
*)
Àaf_node
, 
key
);

479 
	`ªÀa£_∑ge
((
Page
*)
Àaf_node
);

482 
	}
}

	@src/file.cpp

1 
	~<sys/ty≥s.h
>

2 
	~<f˙é.h
>

3 
	~<°dlib.h
>

4 
	~<as£π.h
>

5 
	~<°dio.h
>

6 
	~<uni°d.h
>

7 
	~<°rög.h
>

8 
	~"fûe.h
"

9 
	~"∑nic.h
"

11 
	gdbfûe
;

14 
	$fûe_‰ì_∑ge
(
TabÀ
* 
èbÀ
, 
∑gíum_t
 
∑gíum
) {

15 
FªePage
 
‰ì∑ge
;

16 
	`mem£t
(&
‰ì∑ge
, 0, 
PAGE_SIZE
);

18 
‰ì∑ge
.
√xt
 = 
èbÀ
->
dbhódî
.
‰ìli°
;

19 
	`fûe_wrôe_∑ge
(
èbÀ
, 
∑gíum
, &
‰ì∑ge
);

21 
èbÀ
->
dbhódî
.
‰ìli°
 = 
	`PAGENUM_TO_FILEOFF
(
∑gíum
);

22 
	}
}

25 
	$ex∑nd_fûe
(
TabÀ
* 
èbÀ
, 
size_t
 
˙t_∑ge_to_ex∑nd
) {

26 
off_t
 
off£t
 = 
èbÀ
->
dbhódî
.
num_∑ges
 * 
PAGE_SIZE
;

28 i‡(
èbÀ
->
dbhódî
.
num_∑ges
 > 1024 * 1024) {

30 
	`PANIC
("Test: youáreálready havingá DB file overÅhan 4GB");

33 
i
;

34 
i
 = 0; i < 
˙t_∑ge_to_ex∑nd
; i++) {

35 
	`fûe_‰ì_∑ge
(
èbÀ
, 
	`FILEOFF_TO_PAGENUM
(
off£t
));

36 
èbÀ
->
dbhódî
.
num_∑ges
++;

37 
off£t
 +
PAGE_SIZE
;

39 
	}
}

41 
	$fûe_ªad_∑ge
(
TabÀ
* 
èbÀ
, 
∑gíum_t
 
∑gíum
, * 
∑ge
) {

42 
	`l£ek
(
èbÀ
->
dbfûe
, 
	`PAGENUM_TO_FILEOFF
(
∑gíum
), 
SEEK_SET
);

43 
	`ªad
(
èbÀ
->
dbfûe
, 
∑ge
, 
PAGE_SIZE
);

44 
	}
}

46 
	$fûe_wrôe_∑ge
(
TabÀ
* 
èbÀ
, 
∑gíum_t
 
∑gíum
, * 
∑ge
) {

47 
	`l£ek
(
èbÀ
->
dbfûe
, 
	`PAGENUM_TO_FILEOFF
(
∑gíum
), 
SEEK_SET
);

48 
	`wrôe
(
èbÀ
->
dbfûe
, 
∑ge
, 
PAGE_SIZE
);

49 
	}
}

	@src/global_vars.cpp

1 
	~"b±_öã∫Æ.h
"

10 
	g‹dî_öã∫Æ
 = 
BPTREE_INTERNAL_ORDER
;

11 
	g‹dî_Àaf
 = 
BPTREE_LEAF_ORDER
;

	@src/insert.cpp

1 
	~"b±_öã∫Æ.h
"

6 
	$gë_À·_ödex
(
TabÀ
* 
èbÀ
, 
I¡î«lPage
* 
∑ª¡
, 
off_t
 
À·_off£t
) {

7 
À·_ödex
 = 0;

8 
À·_ödex
 <
∑ª¡
->
num_keys
 &&

9 
	`INTERNAL_OFFSET
(
∑ª¡
, 
À·_ödex
Ë!
À·_off£t
)

10 
À·_ödex
++;

11  
À·_ödex
;

12 
	}
}

16 
	$ö£π_öto_Àaf
(
TabÀ
* 
èbÀ
, 
LófPage
* 
Àaf_node
, 
öt64_t
 
key
, i¡64_t* 
vÆue
) {

17 
ö£πi⁄_poöt
;

18 
i
;

20 
ö£πi⁄_poöt
 = 0;

21 
ö£πi⁄_poöt
 < 
Àaf_node
->
num_keys
 &&

22 
	`LEAF_KEY
(
Àaf_node
, 
ö£πi⁄_poöt
Ë< 
key
)

23 
ö£πi⁄_poöt
++;

26 
i
 = 
Àaf_node
->
num_keys
 - 1; i >
ö£πi⁄_poöt
; i--) {

27 
	`LEAF_KEY
(
Àaf_node
, 
i
+1) = LEAF_KEY(leaf_node, i);

28 
	`mem˝y
(
	`LEAF_VALUE
(
Àaf_node
, 
i
+1), LEAF_VALUE(leaf_node, i),

29 
SIZE_VALUE
);

32 
	`LEAF_KEY
(
Àaf_node
, 
ö£πi⁄_poöt
Ë
key
;

33 
	`mem˝y
(
	`LEAF_VALUE
(
Àaf_node
, 
ö£πi⁄_poöt
), 
vÆue
, 
SIZE_VALUE
);

34 
Àaf_node
->
num_keys
++;

38 
	}
}

43 
	$ö£π_öto_Àaf_a·î_•lôtög
(
TabÀ
* 
èbÀ
, 
LófPage
* 
Àaf
, 
öt64_t
 
key
,

44 
öt64_t
* 
vÆue
) {

45 
ö£πi⁄_ödex
, 
•lô
, 
i
, 
j
;

46 
öt64_t
 
√w_key
;

49 
LófPage
* 
√w_Àaf
 = (LófPage*)
	`Æloc_∑ge
(
èbÀ
);

50 
√w_Àaf
->
is_Àaf
 = 
åue
;

51 
√w_Àaf
->
num_keys
 = 0;

53 
ö£πi⁄_ödex
 = 0;

54 
ö£πi⁄_ödex
 < 
‹dî_Àaf
 - 1 &&

55 
	`LEAF_KEY
(
Àaf
, 
ö£πi⁄_ödex
Ë< 
key
){

56 
ö£πi⁄_ödex
++;

59 
•lô
 = 
	`cut
(
‹dî_Àaf
 - 1);

61 i‡(
ö£πi⁄_ödex
 < 
•lô
) {

63 
i
 = 
•lô
 - 1, 
j
 = 0; i < 
‹dî_Àaf
 - 1; i++, j++) {

64 
	`LEAF_KEY
(
√w_Àaf
, 
j
ËLEAF_KEY(
Àaf
, 
i
);

65 
	`mem˝y
(
	`LEAF_VALUE
(
√w_Àaf
, 
j
), LEAF_VALUE(
Àaf
, 
i
), 
SIZE_VALUE
);

67 
√w_Àaf
->
num_keys
++;

68 
Àaf
->
num_keys
--;

71 
i
 = 
•lô
 - 2; i >
ö£πi⁄_ödex
; i--) {

72 
	`LEAF_KEY
(
Àaf
, 
i
+1) = LEAF_KEY(leaf, i);

73 
	`mem˝y
(
	`LEAF_VALUE
(
Àaf
, 
i
+1), LEAF_VALUE÷óf, i), 
SIZE_VALUE
);

75 
	`LEAF_KEY
(
Àaf
, 
ö£πi⁄_ödex
Ë
key
;

76 
	`mem˝y
(
	`LEAF_VALUE
(
Àaf
, 
ö£πi⁄_ödex
), 
vÆue
, 
SIZE_VALUE
);

77 
Àaf
->
num_keys
++;

80 
i
 = 
•lô
, 
j
 = 0; i < 
‹dî_Àaf
 - 1; i++, j++) {

81 i‡(
i
 =
ö£πi⁄_ödex
) {

83 
j
++;

85 
	`LEAF_KEY
(
√w_Àaf
, 
j
ËLEAF_KEY(
Àaf
, 
i
);

86 
	`mem˝y
(
	`LEAF_VALUE
(
√w_Àaf
, 
j
), LEAF_VALUE(
Àaf
, 
i
), 
SIZE_VALUE
);

88 
√w_Àaf
->
num_keys
++;

89 
Àaf
->
num_keys
--;

91 
	`LEAF_KEY
(
√w_Àaf
, 
ö£πi⁄_ödex
 - 
•lô
Ë
key
;

92 
	`mem˝y
(
	`LEAF_VALUE
(
√w_Àaf
, 
ö£πi⁄_ödex
 - 
•lô
), 
vÆue
,

93 
SIZE_VALUE
);

94 
√w_Àaf
->
num_keys
++;

98 
√w_Àaf
->
siblög
 = 
Àaf
->sibling;

99 
Àaf
->
siblög
 = 
	`PAGENUM_TO_FILEOFF
(
√w_Àaf
->
∑gíum
);

102 
i
 = 
Àaf
->
num_keys
; i < 
‹dî_Àaf
 - 1; i++) {

103 
	`LEAF_KEY
(
Àaf
, 
i
) = 0;

104 
	`mem£t
(
	`LEAF_VALUE
(
Àaf
, 
i
), 0, 
SIZE_VALUE
);

106 
i
 = 
√w_Àaf
->
num_keys
; i < 
‹dî_Àaf
 - 1; i++) {

107 
	`LEAF_KEY
(
√w_Àaf
, 
i
) = 0;

108 
	`mem£t
(
	`LEAF_VALUE
(
√w_Àaf
, 
i
), 0, 
SIZE_VALUE
);

111 
√w_Àaf
->
∑ª¡
 = 
Àaf
->parent;

113 
√w_key
 = 
	`LEAF_KEY
(
√w_Àaf
, 0);

116 
	`ö£π_öto_∑ª¡
(
èbÀ
, (
NodePage
*)
Àaf
, 
√w_key
, (NodePage*)
√w_Àaf
);

118 
	`ªÀa£_∑ge
((
Page
*)
√w_Àaf
);

119 
	}
}

124 
	$ö£π_öto_node
(
TabÀ
* 
èbÀ
, 
I¡î«lPage
* 
n
, 
À·_ödex
, 
öt64_t
 
key
,

125 
off_t
 
right_off£t
) {

126 
i
;

128 
i
 = 
n
->
num_keys
; i > 
À·_ödex
; i--) {

129 
	`INTERNAL_OFFSET
(
n
, 
i
 + 1) = INTERNAL_OFFSET(n, i);

130 
	`INTERNAL_KEY
(
n
, 
i
) = INTERNAL_KEY(n, i - 1);

132 
	`INTERNAL_OFFSET
(
n
, 
À·_ödex
 + 1Ë
right_off£t
;

133 
	`INTERNAL_KEY
(
n
, 
À·_ödex
Ë
key
;

134 
n
->
num_keys
++;

135 
	}
}

140 
	$ö£π_öto_node_a·î_•lôtög
(
TabÀ
* 
èbÀ
, 
I¡î«lPage
* 
ﬁd_node
, 
À·_ödex
,

141 
öt64_t
 
key
, 
off_t
 
right_off£t
) {

142 
i
, 
j
, 
•lô
, 
k_¥ime
;

143 
öt64_t
* 
ãmp_keys
;

144 
off_t
* 
ãmp_poöãrs
;

153 
ãmp_poöãrs
 = (
off_t
*)
	`mÆloc
–(
‹dî_öã∫Æ
 + 1) * (off_t) );

154 i‡(
ãmp_poöãrs
 =
NULL
) {

155 
	`PANIC
("TemporaryÖointersárray for splittingÇodes.");

157 
ãmp_keys
 = (
öt64_t
*)
	`mÆloc
–
‹dî_öã∫Æ
 * (int64_t) );

158 i‡(
ãmp_keys
 =
NULL
) {

159 
	`PANIC
("Temporary keysárray for splittingÇodes.");

162 
i
 = 0, 
j
 = 0; i < 
ﬁd_node
->
num_keys
 + 1; i++, j++) {

163 i‡(
j
 =
À·_ödex
 + 1) j++;

164 
ãmp_poöãrs
[
j
] = 
	`INTERNAL_OFFSET
(
ﬁd_node
, 
i
);

167 
i
 = 0, 
j
 = 0; i < 
ﬁd_node
->
num_keys
; i++, j++) {

168 i‡(
j
 =
À·_ödex
) j++;

169 
ãmp_keys
[
j
] = 
	`INTERNAL_KEY
(
ﬁd_node
, 
i
);

172 
ãmp_poöãrs
[
À·_ödex
 + 1] = 
right_off£t
;

173 
ãmp_keys
[
À·_ödex
] = 
key
;

178 
•lô
 = 
	`cut
(
‹dî_öã∫Æ
);

180 
I¡î«lPage
* 
√w_node
 = (I¡î«lPage*)
	`Æloc_∑ge
(
èbÀ
);

181 
√w_node
->
num_keys
 = 0;

182 
√w_node
->
is_Àaf
 = 0;

184 
ﬁd_node
->
num_keys
 = 0;

185 
i
 = 0; i < 
•lô
 - 1; i++) {

186 
	`INTERNAL_OFFSET
(
ﬁd_node
, 
i
Ë
ãmp_poöãrs
[i];

187 
	`INTERNAL_KEY
(
ﬁd_node
, 
i
Ë
ãmp_keys
[i];

188 
ﬁd_node
->
num_keys
++;

190 
	`INTERNAL_OFFSET
(
ﬁd_node
, 
i
Ë
ãmp_poöãrs
[i];

191 
k_¥ime
 = 
ãmp_keys
[
•lô
 - 1];

192 ++
i
, 
j
 = 0; i < 
‹dî_öã∫Æ
; i++, j++) {

193 
	`INTERNAL_OFFSET
(
√w_node
, 
j
Ë
ãmp_poöãrs
[
i
];

194 
	`INTERNAL_KEY
(
√w_node
, 
j
Ë
ãmp_keys
[
i
];

195 
√w_node
->
num_keys
++;

197 
	`INTERNAL_OFFSET
(
√w_node
, 
j
Ë
ãmp_poöãrs
[
i
];

198 
	`‰ì
(
ãmp_poöãrs
);

199 
	`‰ì
(
ãmp_keys
);

200 
√w_node
->
∑ª¡
 = 
ﬁd_node
->parent;

201 
i
 = 0; i <
√w_node
->
num_keys
; i++) {

202 
NodePage
* 
chûd_∑ge
 =

203 (
NodePage
*Ë
	`gë_∑ge
(
èbÀ
,

204 
	`FILEOFF_TO_PAGENUM
(
	`INTERNAL_OFFSET
(
√w_node
, 
i
)));

206 
chûd_∑ge
->
∑ª¡
 = 
	`PAGENUM_TO_FILEOFF
(
√w_node
->
∑gíum
);

207 
	`£t_dúty_∑ge
((
Page
*)
chûd_∑ge
);

208 
	`ªÀa£_∑ge
((
Page
*)
chûd_∑ge
);

212 
i
 = 
ﬁd_node
->
num_keys
; i < 
‹dî_öã∫Æ
 - 1; i++) {

213 
	`INTERNAL_OFFSET
(
ﬁd_node
, 
i
+1) = 0;

214 
	`INTERNAL_KEY
(
ﬁd_node
, 
i
) = 0;

217 
i
 = 
√w_node
->
num_keys
; i < 
‹dî_öã∫Æ
 - 1; i++) {

218 
	`INTERNAL_OFFSET
(
√w_node
, 
i
+1) = 0;

219 
	`INTERNAL_KEY
(
√w_node
, 
i
) = 0;

225 
	`ö£π_öto_∑ª¡
(
èbÀ
, (
NodePage
*)
ﬁd_node
, 
k_¥ime
, (NodePage*)
√w_node
);

227 
	`ªÀa£_∑ge
((
Page
*)
√w_node
);

228 
	}
}

233 
	$ö£π_öto_∑ª¡
(
TabÀ
* 
èbÀ
, 
NodePage
* 
À·
, 
öt64_t
 
key
, NodePage* 
right
) {

234 
À·_ödex
;

235 
I¡î«lPage
* 
∑ª¡_node
;

238 i‡(
À·
->
∑ª¡
 == 0) {

239 
	`ö£π_öto_√w_roŸ
(
èbÀ
, 
À·
, 
key
, 
right
);

243 
∑ª¡_node
 = (
I¡î«lPage
*Ë
	`gë_∑ge
(
èbÀ
, 
	`FILEOFF_TO_PAGENUM
(
À·
->
∑ª¡
));

244 
	`£t_dúty_∑ge
((
Page
*)
∑ª¡_node
);

251 
À·_ödex
 = 
	`gë_À·_ödex
(
èbÀ
, 
∑ª¡_node
,

252 
	`PAGENUM_TO_FILEOFF
(
À·
->
∑gíum
));

256 i‡(
∑ª¡_node
->
num_keys
 < 
‹dî_öã∫Æ
 - 1) {

257 
	`ö£π_öto_node
(
èbÀ
, 
∑ª¡_node
, 
À·_ödex
, 
key
,

258 
	`PAGENUM_TO_FILEOFF
(
right
->
∑gíum
));

259 
	`ªÀa£_∑ge
((
Page
*)
∑ª¡_node
);

266 
	`ö£π_öto_node_a·î_•lôtög
(
èbÀ
, 
∑ª¡_node
, 
À·_ödex
, 
key
,

267 
	`PAGENUM_TO_FILEOFF
(
right
->
∑gíum
));

268 
	`ªÀa£_∑ge
((
Page
*)
∑ª¡_node
);

269 
	}
}

274 
	$ö£π_öto_√w_roŸ
(
TabÀ
* 
èbÀ
, 
NodePage
* 
À·
, 
öt64_t
 
key
, NodePage* 
right
) {

276 
I¡î«lPage
* 
roŸ_node
 = (I¡î«lPage*)
	`Æloc_∑ge
(
èbÀ
);

277 
	`INTERNAL_KEY
(
roŸ_node
, 0Ë
key
;

278 
	`INTERNAL_OFFSET
(
roŸ_node
, 0Ë
	`PAGENUM_TO_FILEOFF
(
À·
->
∑gíum
);

279 
	`INTERNAL_OFFSET
(
roŸ_node
, 1Ë
	`PAGENUM_TO_FILEOFF
(
right
->
∑gíum
);

280 
roŸ_node
->
num_keys
++;

281 
roŸ_node
->
∑ª¡
 = 0;

282 
roŸ_node
->
is_Àaf
 = 0;

283 
À·
->
∑ª¡
 = 
	`PAGENUM_TO_FILEOFF
(
roŸ_node
->
∑gíum
);

284 
right
->
∑ª¡
 = 
	`PAGENUM_TO_FILEOFF
(
roŸ_node
->
∑gíum
);

286 
èbÀ
->
dbhódî
.
roŸ_off£t
 = 
	`PAGENUM_TO_FILEOFF
(
roŸ_node
->
∑gíum
);

288 
	`ªÀa£_∑ge
((
Page
*)
roŸ_node
);

289 
	}
}

292 
	$°¨t_√w_åì
(
TabÀ
* 
èbÀ
, 
öt64_t
 
key
, i¡64_t* 
vÆue
) {

293 
LófPage
* 
roŸ_node
 = (LófPage*)
	`Æloc_∑ge
(
èbÀ
);

294 
roŸ_node
->
∑ª¡
 = 0;

295 
roŸ_node
->
is_Àaf
 = 1;

296 
roŸ_node
->
num_keys
 = 1;

297 
	`LEAF_KEY
(
roŸ_node
, 0Ë
key
;

298 
roŸ_node
->
siblög
 = 0;

299 
	`mem˝y
(
	`LEAF_VALUE
(
roŸ_node
, 0), 
vÆue
, 
SIZE_VALUE
);

301 
èbÀ
->
dbhódî
.
roŸ_off£t
 = 
	`PAGENUM_TO_FILEOFF
(
roŸ_node
->
∑gíum
);

302 
	`£t_dúty_∑ge
((
Page
*)&
èbÀ
->
dbhódî
);

304 
	`ªÀa£_∑ge
((
Page
*)
roŸ_node
);

305 
	}
}

311 
	$ö£π_ªc‹d
(
TabÀ
* 
èbÀ
, 
öt64_t
 
key
, i¡64_t* 
vÆue
) {

312 
öt64_t
* 
vÆue_found
 = 
NULL
;

316 i‡((
vÆue_found
 = 
	`föd_ªc‹d
(
èbÀ
, 
key
)) != 0) {

317 
	`‰ì
(
vÆue_found
);

323 i‡(
èbÀ
->
dbhódî
.
roŸ_off£t
 == 0) {

324 
	`°¨t_√w_åì
(
èbÀ
, 
key
, 
vÆue
);

330 
LófPage
* 
Àaf_node
;

331 
	`föd_Àaf
(
èbÀ
, 
key
, &
Àaf_node
);

335 i‡(
Àaf_node
->
num_keys
 < 
‹dî_Àaf
 - 1) {

336 
	`ö£π_öto_Àaf
(
èbÀ
, 
Àaf_node
, 
key
, 
vÆue
);

340 
	`ö£π_öto_Àaf_a·î_•lôtög
(
èbÀ
, 
Àaf_node
, 
key
, 
vÆue
);

342 
	`£t_dúty_∑ge
((
Page
*)
Àaf_node
);

343 
	`ªÀa£_∑ge
((
Page
*)
Àaf_node
);

345 
	}
}

	@src/lock.cpp

1 
	~"lock.h
"

3 
LockM™agî
 
	glock_sys
;

15 
boﬁ
 
	gLockM™agî
::
	$acquúe_lock
(
åx_t
* 
åx
, 
èbÀ_id
, 
∑gíum_t
 
∑ge_id
, 
öt64_t
 
key
, 
LockMode
 
mode
, 
buf_∑ge_i
) {

17 
LOCK_SYS_MUTEX_ENTER
;

18 i‡(!
lock_sys_muãx_acquúed
)

19  
Ál£
;

21 
TabÀ
* 
èbÀ
 = 
	`gë_èbÀ
(
èbÀ_id
);

22 
Tønß˘i⁄M™agî
* 
tm
 = &
åx_sys
;

25 i‡(
åx
->
	`gëSèã
(Ë!
RUNNING
)

26 
	`PANIC
("CannotácquireÜock in other mode.\n");

28 
waôög_f‹_åx_id
 = -1;

29 
lock_t
* 
¥ev_lock_±r
 = 
nuŒ±r
;

30 
lock_t
* 
waô_lock
 = 
nuŒ±r
;

32 
LOCK_REQ_STATE
 
lock_°©e
 = 
LOCK_GRANTED_PUSH
;

33 
lock_t
* 
lock_±r
 = 
nuŒ±r
;

53 i‡(
mode
 =
LOCK_X
) {

55 autÿ
rô
 = 
lock_èbÀ
[
∑ge_id
].
lock_li°
.
	`rbegö
();Ñô !lock_èbÀ[∑ge_id].lock_li°.
	`ªnd
(); ++rit) {

57 
lock_°©e
 = 
LOCK_GRANTED_PUSH
;

59 i‡(
rô
 -> 
key
 =key &&Ñô -> 
èbÀ_id
 ==Åable_id) {

61 
¥ev_lock_±r
 = &(*
rô
);

63 
lock_t
* 
lock_t_±r
 = 
¥ev_lock_±r
;Üock_t_±∏!
nuŒ±r
;) {

66 i‡(
lock_t_±r
 -> 
åx_id
 !
åx
->
	`gëTønß˘i⁄Id
()) {

67 
lock_°©e
 = 
LOCK_WAITING
;

68 
waôög_f‹_åx_id
 = 
lock_t_±r
 -> 
åx_id
;

69 
waô_lock
 = 
lock_t_±r
;

72 } i‡(
lock_t_±r
 -> 
lock_mode
 =
LOCK_X
){

73 
lock_°©e
 = 
LOCK_GRANTED_NO_PUSH
;

75 
lock_t_±r
 =Üock_t_±∏-> 
¥ev
;

83 autÿ
rô
 = 
lock_èbÀ
[
∑ge_id
].
lock_li°
.
	`rbegö
();Ñô !lock_èbÀ[∑ge_id].lock_li°.
	`ªnd
(); ++rit) {

85 
lock_°©e
 = 
LOCK_GRANTED_PUSH
;

87 i‡(
rô
 -> 
key
 =key &&Ñô -> 
èbÀ_id
 ==Åable_id) {

89 
¥ev_lock_±r
 = &(*
rô
);

91 
lock_t
* 
lock_t_±r
 = 
¥ev_lock_±r
;Üock_t_±∏!
nuŒ±r
;) {

94 i‡(
lock_t_±r
 -> 
åx_id
 !
åx
->
	`gëTønß˘i⁄Id
()) {

95 i‡(
lock_t_±r
 -> 
lock_mode
 =
LOCK_X
) {

96 
lock_°©e
 = 
LOCK_WAITING
;

97 
waôög_f‹_åx_id
 = 
lock_t_±r
 -> 
åx_id
;

98 
waô_lock
 = 
lock_t_±r
;

103 
lock_°©e
 = 
LOCK_GRANTED_NO_PUSH
;

105 
lock_t_±r
 =Üock_t_±∏-> 
¥ev
;

113 i‡(
lock_°©e
 =
LOCK_GRANTED_NO_PUSH
) {

114  
åue
;

117 i‡(
lock_°©e
 =
LOCK_GRANTED_PUSH
) {

118 
MAKE_LOCK_REQUEST_GRANTED
;

119 
lock_±r
 -> 
acquúed
 = 
åue
;

120 
åx
 -> 
	`push_acquúed_lock
(
lock_±r
);

121  
åue
;

129 i‡(
dl_checkî
.
	`dódlock_checkög
(
åx
->
	`gëTønß˘i⁄Id
(), 
waôög_f‹_åx_id
)) {

130 
	`ªÀa£_lock_ab‹ãd
(
åx
);

131 
	`ªÀa£_∑ge_œtch
(
buf_∑ge_i
);

132 
åx
->
	`£tSèã
(
ABORTED
);

133  
Ál£
;

136 
MAKE_LOCK_REQUEST_WAIT
;

138 
åx_t
* 
¥ev_åx
 = 
nuŒ±r
;

153 
	`ªÀa£_∑ge_œtch
(
buf_∑ge_i
);

155 i‡(
mode
 =
LOCK_S
) {

156 
¥ev_åx
 = 
tm
 -> 
	`gëTønß˘i⁄
(
waôög_f‹_åx_id
);

157 
¥ev_åx
 -> 
	`gëCV
(Ë-> 
	`waô
(
l_muãx
);

160 
	`PANIC
("");

162 
¥ev_åx
 = 
tm
 -> 
	`gëTønß˘i⁄
(
waôög_f‹_åx_id
);

163 
¥ev_åx
 -> 
	`gëCV
(Ë-> 
	`waô
(
l_muãx
);

165 
åue
) {

166 
boﬁ
 
°ûl_c⁄Êi˘
 = 
Ál£
;

167 i‡(!
lock_±r
 -> 
¥ev
)

170 autÿ
lock_t_±r
 = 
lock_±r
 -> 
¥ev
;Üock_t_±∏!
nuŒ±r
;) {

172 i‡(
lock_t_±r
 -> 
åx_id
 !
åx
 -> 
	`gëTønß˘i⁄Id
()) {

173 
°ûl_c⁄Êi˘
 = 
åue
;

174 
waôög_f‹_åx_id
 = 
lock_t_±r
 -> 
åx_id
;

175 
lock_±r
 -> 
waô_lock
 = 
lock_t_±r
;

177 i‡(
dl_checkî
.
	`ch™ge_waôög_f‹
(
åx
->
	`gëTønß˘i⁄Id
(), 
waôög_f‹_åx_id
)) {

178 
	`ªÀa£_lock_ab‹ãd
(
åx
);

179 
åx
->
	`£tSèã
(
ABORTED
);

180  
Ál£
;

183 
¥ev_åx
 = 
tm
 -> 
	`gëTønß˘i⁄
(
waôög_f‹_åx_id
);

184 
¥ev_åx
 -> 
	`gëCV
(Ë-> 
	`waô
(
l_muãx
);

188 
lock_t_±r
 =Üock_t_±∏-> 
¥ev
;

192 i‡(!
°ûl_c⁄Êi˘
)

197 
	`acquúe_∑ge_œtch
(
buf_∑ge_i
);

198 
lock_±r
 -> 
acquúed
 = 
åue
;

199 
åx
 -> 
	`push_acquúed_lock
(
lock_±r
);

201  
åue
;

202 
	}
}

210 
	gLockM™agî
::
	$ªÀa£_lock_low
(
åx_t
* 
åx
, 
lock_t
* 
lock_±r
) {

211 
∑ge_id
 = 
lock_±r
 ->Öage_id;

215 autÿ
ô
 = 
lock_±r
 -> 
√xt
; ià!
nuŒ±r
;) {

216 i‡(
ô
 -> 
waô_lock
 =
lock_±r
)

217 
ô
 -> 
waô_lock
 = 
nuŒ±r
;

218 
ô
 = ià-> 
√xt
;

221 i‡(
lock_±r
 -> 
¥ev
)

222 
lock_±r
 -> 
¥ev
 -> 
√xt
 =Üock_ptr ->Çext;

223 i‡(
lock_±r
 -> 
√xt
)

224 
lock_±r
 -> 
√xt
 -> 
¥ev
 =Üock_ptr ->Örev;

226 
boﬁ
 
Êag
 = 
åue
;

230 autÿ
ô
 = 
lock_èbÀ
[
∑ge_id
].
lock_li°
.
	`begö
(); ià!lock_èbÀ[∑ge_id].lock_li°.
	`íd
(); ++it) {

231 i‡(
ô
 -> 
åx_id
 =
åx
->
	`gëTønß˘i⁄Id
(Ë&& ià-> 
key
 =
lock_±r
 -> key && ià-> 
acquúed
 &&

232 
ô
 -> 
lock_mode
 =
lock_±r
 ->Üock_modê&& ià-> 
èbÀ_id
 ==Üock_ptr ->Åable_id){

233 
lock_èbÀ
[
∑ge_id
].
lock_li°
.
	`îa£
(
ô
);

234 
Êag
 = 
Ál£
;

239 i‡(
Êag
)

240 
	`PANIC
("InÑelease_lock_low. CannotÉraseÜock_t inÜist).\n");

242 
	}
}

244 
	gLockM™agî
::
	$rﬁlback_d©a
(
èbÀ_id
, 
uöt64_t
 
∑ge_id
, 
åx_t
* 
åx
, 
undo_log
& 
log
) {

246 
BUF_POOL_MUTEX_ENTER
;

248 
TabÀ
* 
èbÀ
 = 
	`gë_èbÀ
(
èbÀ_id
);

250 
buf_∑ge_i
 = 0;

251 
LófPage
* 
Àaf_node
 = 
nuŒ±r
;

253 
åue
) {

254 
Àaf_node
 = (
LófPage
*)
	`gë_∑ge
(
èbÀ
, 
∑ge_id
, &
buf_∑ge_i
);

255 i‡(
Àaf_node
)

259 
i
 = 0; i < 
Àaf_node
->
num_keys
; i++) {

260 i‡(
	`LEAF_KEY
(
Àaf_node
, 
i
Ë=
log
.
key
) {

261 
	`mem˝y
(
	`LEAF_VALUE
(
Àaf_node
, 
i
), 
log
.
undo_vÆue
, 
SIZE_VALUE
);

262 
	`ªÀa£_∑ge
((
Page
*)
Àaf_node
, &
buf_∑ge_i
);

267 
	`PANIC
("InÑollback_data. Cannot findÅhe given key.\n");

268 
	}
}

270 
	gLockM™agî
::
	$ªÀa£_lock_ab‹ãd_low
(
åx_t
* 
åx
, 
lock_t
* 
lock_±r
) {

271 
∑ge_id
 = 
lock_±r
 ->Öage_id;

275 autÿ
ô
 = 
lock_±r
 -> 
√xt
; ià!
nuŒ±r
;) {

276 i‡(
ô
 -> 
waô_lock
 =
lock_±r
)

277 
ô
 -> 
waô_lock
 = 
nuŒ±r
;

278 
ô
 = ià-> 
√xt
;

281 i‡(
lock_±r
 -> 
¥ev
)

282 
lock_±r
 -> 
¥ev
 -> 
√xt
 =Üock_ptr ->Çext;

283 i‡(
lock_±r
 -> 
√xt
)

284 
lock_±r
 -> 
√xt
 -> 
¥ev
 =Üock_ptr ->Örev;

286 
boﬁ
 
Êag
 = 
åue
;

291 autÿ
ô
 = 
lock_èbÀ
[
∑ge_id
].
lock_li°
.
	`begö
(); ià!lock_èbÀ[∑ge_id].lock_li°.
	`íd
(); ++it) {

292 i‡(
ô
 -> 
åx_id
 =
åx
->
	`gëTønß˘i⁄Id
(Ë&& ià-> 
key
 =
lock_±r
 -> key && ià-> 
acquúed
 &&

293 
ô
 -> 
lock_mode
 =
lock_±r
 ->Üock_modê&& ià-> 
èbÀ_id
 ==Üock_ptr ->Åable_id){

295 i‡(
lock_±r
 -> 
lock_mode
 =
LOCK_X
) {

296 
undo_log
 
log
 = 
åx
->
	`p›_undo_log
();

297 
	`rﬁlback_d©a
(
ô
->
èbÀ_id
, 
∑ge_id
, 
åx
, 
log
);

301 
lock_èbÀ
[
∑ge_id
].
lock_li°
.
	`îa£
(
ô
);

302 
Êag
 = 
Ál£
;

307 i‡(
Êag
)

308 
	`PANIC
("InÑelease_lock_low. CannotÉraseÜock_t inÜist).\n");

310 
	}
}

319 
boﬁ
 
	gLockM™agî
::
	$ªÀa£_lock_ab‹ãd
(
åx_t
* 
åx
) {

321 c⁄° 
°d
::
li°
<
lock_t
*> 
acquúed_lock
 = 
åx
->
	`gëAcquúedLock
();

322 autÿ
ô
 = 
acquúed_lock
.
	`begö
(); ià!acquúed_lock.
	`íd
(); ++it) {

323 
	`ªÀa£_lock_ab‹ãd_low
(
åx
, *
ô
);

326 
åx
->
	`gëCV
()->
	`nŸify_Æl
();

327  
åue
;

328 
	}
}

336 
boﬁ
 
	gLockM™agî
::
	$ªÀa£_lock
(
åx_t
* 
åx
) {

337 
LOCK_SYS_MUTEX_ENTER
;

338 i‡(!
lock_sys_muãx_acquúed
)

339  
Ál£
;

343 
dl_checkî
.
	`dñëe_waôög_f‹_åx
(
åx
->
	`gëTønß˘i⁄Id
());

345 c⁄° 
°d
::
li°
<
lock_t
*> 
acquúed_lock
 = 
åx
->
	`gëAcquúedLock
();

346 autÿ
ô
 = 
acquúed_lock
.
	`begö
(); ià!acquúed_lock.
	`íd
(); ++it) {

347 
	`ªÀa£_lock_low
(
åx
, *
ô
);

350 
åx
->
	`gëCV
()->
	`nŸify_Æl
();

351  
åue
;

352 
	}
}

357 
ölöe
 
	gLockM™agî
::
	$ªÀa£_∑ge_œtch
(
buf_∑ge_i
) {

358 
poﬁ
.
buf_∑ge_muãx
[
buf_∑ge_i
].
	`u∆ock
();

359 
poﬁ
.
tŸ_pö˙t
--;

360 
poﬁ
.
∑ges
[
buf_∑ge_i
].
pö˙t
--;

361 
	}
}

363 
ölöe
 
	gLockM™agî
::
	$acquúe_∑ge_œtch
(
buf_∑ge_i
) {

365 
BUF_POOL_MUTEX_ENTER
;

366 
	`BUF_PAGE_MUTEX_ENTER
(
buf_∑ge_i
);

367 i‡(
ªt
)

370 
	}
}

	@src/main.cpp

1 
	~<°dio.h
>

2 
	~<°dlib.h
>

3 
	~<f˙é.h
>

4 
	~<uni°d.h
>

5 
	~<sys/ty≥s.h
>

6 
	~<öây≥s.h
>

7 
	~"b±.h
"

8 
	~"fûe.h
"

11 
	$maö
–
¨gc
, ** 
¨gv
 ) {

12 
öt64_t
 
öput_key
;

13 
öt64_t
 
öput_vÆue
[
SIZE_COLUMN
];

14 
ö°ru˘i⁄
;

15 
èbÀ_id
;

18 
	`li˚n£_nŸi˚
();

19 
	`ußge_1
();

20 
	`ußge_2
();

22 
	`öô_db
(1000);

23 
èbÀ_id
 = 
	`›í_èbÀ
("test.db", 15);

24 
	`¥öt_åì
(
èbÀ_id
);

25 
	`¥ötf
("> ");

26 
	`sˇnf
("%c", &
ö°ru˘i⁄
Ë!
EOF
) {

27 
ö°ru˘i⁄
) {

30 
	`ö£π
(
èbÀ_id
, 
öput_key
, 
öput_vÆue
);

31 
	`¥öt_åì
(
èbÀ_id
);

34 
	`sˇnf
("%" 
PRIu64
 "", &
öput_key
);

35 
	`ªmove
(
èbÀ_id
, 
öput_key
);

36 
	`¥öt_åì
(
èbÀ_id
);

40 
	`sˇnf
("%" 
PRIu64
 "", &
öput_key
);

41 
	`föd_™d_¥öt
(
èbÀ_id
, 
öput_key
);

44 
	`gëch¨
() != ()'\n');

45 
	`˛o£_èbÀ
(
èbÀ_id
);

46 
	`shutdown_db
();

47  
EXIT_SUCCESS
;

50 
	`¥öt_åì
(
èbÀ_id
);

53 
	`ußge_2
();

56 
	`gëch¨
() != ()'\n');

57 
	`¥ötf
("> ");

59 
	`¥ötf
("\n");

61 
	`˛o£_èbÀ
(
èbÀ_id
);

62 
	`shutdown_db
();

64  
EXIT_SUCCESS
;

65 
	}
}

	@src/table.cpp

1 
	~"b±_öã∫Æ.h
"

2 
	~"lock.h
"

3 
	~"åx.h
"

5 
TabÀ
 
	gèbÀs
[
MAX_NUM_TABLE
];

11 
	$Æloc_èbÀ
() {

12 
i
 = 0; i < 
MAX_NUM_TABLE
; i++){

13 i‡(
èbÀs
[
i
].
èbÀ_id
 == 0){

14 
èbÀs
[
i
].
èbÀ_id
 = i+1;

15  
i
+1;

18 
	`PANIC
("AllocÅableÜimit.");

20 
	}
}

22 
TabÀ
* 
	$gë_èbÀ
(
èbÀ_id
) {

23 i‡(
èbÀ_id
 <= 0){

24 
	`PANIC
("get_table");

26  &
èbÀs
[
èbÀ_id
-1];

27 
	}
}

30 
	$›í_‹_¸óã_èbÀ_fûe
(c⁄° * 
fûíame
, 
num_cﬁumn
) {

31 
èbÀ_id
 = 
	`Æloc_èbÀ
();

32 
TabÀ
* 
èbÀ
;

34 i‡(
èbÀ_id
 <= 0){

37 
èbÀ
 = 
	`gë_èbÀ
(
èbÀ_id
);

38 
èbÀ
->
dbfûe
 = 
	`›í
(
fûíame
, 
O_RDWR
);

39 i‡(
èbÀ
->
dbfûe
 < 0) {

41 
èbÀ
->
dbfûe
 = 
	`›í
(
fûíame
, 
O_CREAT
|
O_RDWR
, 
S_IRUSR
|
S_IWUSR
);

42 i‡(
èbÀ
->
dbfûe
 < 0) {

43 
	`PANIC
("failedÅo createÇew db file");

45 
	`öô_√w_hódî_∑ge
(&
èbÀ
->
dbhódî
, 
èbÀ_id
, 
num_cﬁumn
);

48 
	`lﬂd_hódî_∑ge
(
èbÀ
);

50  
èbÀ_id
;

51 
	}
}

54 
	$˛o£_èbÀ_fûe
(
TabÀ
* 
èbÀ
) {

55 
	`ªÀa£_hódî_∑ge
(
èbÀ
);

56 
	`˛o£
(
èbÀ
->
dbfûe
);

57 
èbÀ
->
dbfûe
 = 0;

58 
èbÀ
->
èbÀ_id
 = 0;

60 
	}
}

	@src/test.cpp

1 
	~<°dio.h
>

2 
	~<°dlib.h
>

3 
	~<f˙é.h
>

4 
	~<uni°d.h
>

5 
	~<sys/ty≥s.h
>

6 
	~<öây≥s.h
>

7 
	~<thªad
>

8 
	~<°dlib.h
>

10 
	~<io°ªam
>

11 
	~<ve˘‹
>

12 
	~"b±.h
"

13 
	~"fûe.h
"

15 
usög
 
«me•a˚
 
	g°d
;

16 
	$Resu…
(
ª
){

17 i‡(
ª
 != 1) {

18 
cout
 << "GOD NO" << 
ídl
;

19 
	`exô
(0);

21 
	}
}

23 
	$sh¨ed_lock
(
èbÀ_id
, 
key
, 
åx_id
, * 
ªsu…
) {

24 
öt64_t
* 
ªt
 = 
	`föd
(
èbÀ_id
, 
key
, 
åx_id
, 
ªsu…
);

25 
	}
}

27 
	$ex˛usive_lock
(
èbÀ_id
, 
key
, 
öt64_t
* 
öput_vÆue
, 
åx_id
, * 
ªsu…
) {

28 
ªt
 = 
	`upd©e
(
èbÀ_id
, 
key
, 
öput_vÆue
, 
åx_id
, 
ªsu…
);

29 
cout
 << 
åx_id
 <<"SX DONE" << 
ídl
;

30 
	}
}

32 
	$íd_åx
(
åx_id
){

33 
	`íd_tx
(
åx_id
);

34 
	}
}

36 
	$maö
–
¨gc
, ** 
¨gv
 ) {

37 
öt64_t
 
öput_key
;

38 
ªsu…
 = 0;

39 
öt64_t
 
öput_vÆue
[
SIZE_COLUMN
];

40 
öt64_t
 
f_upd©e_vÆue
[
SIZE_COLUMN
];

41 
öt64_t
 
s_upd©e_vÆue
[
SIZE_COLUMN
];

42 
i
 = 0; i < 
SIZE_COLUMN
; ++i){

43 
f_upd©e_vÆue
[
i
] = i;

44 
s_upd©e_vÆue
[
i
] = 100+i;

47 
èbÀ_id
;

48 
	`öô_db
(1000);

49 
f_åx_id
 = 
	`begö_tx
();

50 
s_åx_id
 = 
	`begö_tx
();

51 
f_ªsu…
 = 0;

52 
s_ªsu…
 = 0;

54 
èbÀ_id
 = 
	`›í_èbÀ
("test1_10.db", 15);

57 
thªad
 
	`fú°_s
(
sh¨ed_lock
, 
èbÀ_id
, 1, 
f_åx_id
, &
f_ªsu…
);

59 
cout
 << "FS" << 
ídl
;

60 
thªad
 
	`£c⁄d_x
(
ex˛usive_lock
, 
èbÀ_id
, 1, 
s_upd©e_vÆue
, 
s_åx_id
, &
s_ªsu…
);

61 
fú°_s
.
	`joö
();

62 
cout
 << "SX" << 
ídl
;

63 
thªad
 
	`fú°_x
(
ex˛usive_lock
, 
èbÀ_id
, 1, 
f_upd©e_vÆue
, 
f_åx_id
, &
f_ªsu…
);

64 
cout
 << "FX" << 
ídl
;

65 
fú°_x
.
	`joö
();

66 
cout
 << "FCSTART " << 
ídl
;

67 
thªad
 
	`fú°_e
(
íd_åx
, 
f_åx_id
);

68 
cout
 << "FCDONE" << 
ídl
;

69 
fú°_e
.
	`joö
();

70 
£c⁄d_x
.
	`joö
();

71 
thªad
 
	`£c⁄d_e
(
íd_åx
, 
s_åx_id
);

72 
cout
 << "SC" << 
ídl
;

73 
£c⁄d_e
.
	`joö
();

76 
	`˛o£_èbÀ
(
èbÀ_id
);

77 
	`shutdown_db
();

79 
	}
}

	@src/trx.cpp

1 
	~"åx.h
"

3 
Tønß˘i⁄M™agî
 
	gåx_sys
;

5 
	gTønß˘i⁄M™agî
::~
	$Tønß˘i⁄M™agî
() {

6 autÿ
ô
 = 
a˘ive_åx
.
	`begö
(); ià!a˘ive_åx.
	`íd
(); ++it) {

7 i‡(
ô
 -> 
£c⁄d
)

8 
dñëe
 
ô
->
£c⁄d
;

10 
a˘ive_åx
.
	`˛ór
();

11 
	}
}

13 
åx_t
* 
	gTønß˘i⁄M™agî
::
	$makeNewTønß˘i⁄
() {

14 
åx_t
* 
√w_åx
 = 
√w
 
	`åx_t
(
åx_id
++);

15 
a˘ive_åx
[
√w_åx
->
	`gëTønß˘i⁄Id
()] =Çew_trx;

16  
√w_åx
;

17 
	}
}

19 
åx_t
* 
	gTønß˘i⁄M™agî
::
	$gëTønß˘i⁄
(
åx_id_t
 
åx_id
) {

20 i‡(
a˘ive_åx
.
	`cou¡
(
åx_id
) != 0)

21  
a˘ive_åx
[
åx_id
];

23  
nuŒ±r
;

24 
	}
}

26 
boﬁ
 
	gTønß˘i⁄M™agî
::
	$dñëeTønß˘i⁄
(
åx_id_t
 
åx_id
) {

27 
åx_t
* 
åx
 = 
	`gëTønß˘i⁄
(
åx_id
);

28 i‡(!
åx
)

29  
Ál£
;

31 
åx_t
* 
åx_±r
 = 
nuŒ±r
;

33 autÿ
ô
 = 
a˘ive_åx
.
	`begö
(); ià!a˘ive_åx.
	`íd
(); ++it) {

34 i‡(
ô
 -> 
fú°
 =
åx_id
){

35 
åx_±r
 = 
ô
 -> 
£c⁄d
;

36 
a˘ive_åx
.
	`îa£
(
åx_id
);

37 
dñëe
 
åx_±r
;

38  
åue
;

42  
Ál£
;

43 
	}
}

	@src/univ.cpp

1 
	~"b±_öã∫Æ.h
"

8 
BufPoﬁ
 
poﬁ
;

9 
LockM™agî
 
lock_sys
;

11 
boﬁ
 
	$föd_Àaf
(
TabÀ
* 
èbÀ
, 
öt64_t
 
key
, 
LófPage
** 
out_Àaf_node
) {

13 
i
 = 0;

14 
off_t
 
roŸ_off£t
 = 
èbÀ
->
dbhódî
.root_offset;

16 i‡(
roŸ_off£t
 == 0) {

17  
Ál£
;

20 
NodePage
* 
∑ge
;

21 
∑ge
 = (
NodePage
*)
	`gë_∑ge
(
èbÀ
, 
	`FILEOFF_TO_PAGENUM
(
roŸ_off£t
));

23 !
∑ge
->
is_Àaf
) {

24 
I¡î«lPage
* 
öã∫Æ_node
 = (I¡î«lPage*)
∑ge
;

26 
i
 = 0;

27 
i
 < 
öã∫Æ_node
->
num_keys
) {

28 i‡(
key
 >
	`INTERNAL_KEY
(
öã∫Æ_node
, 
i
)) i++;

32 
NodePage
* 
√xtPage
 = (NodePage*)
	`gë_∑ge
(
èbÀ
,

33 
	`FILEOFF_TO_PAGENUM
(
	`INTERNAL_OFFSET
(
öã∫Æ_node
, 
i
)));

34 i‡(
√xtPage
->
is_Àaf
 =0 &&ÇextPage->
num_keys
 == 0){

35 
	`PANIC
("find_leaf infiniteÜoop!\n");

37 
	`ªÀa£_∑ge
((
Page
*)
∑ge
);

38 
∑ge
 = 
√xtPage
;

42 *
out_Àaf_node
 = (
LófPage
*)
∑ge
;

44  
åue
;

45 
	}
}

54 
boﬁ
 
	$föd_Àaf
(
TabÀ
* 
èbÀ
, 
öt64_t
 
key
, 
LófPage
** 
out_Àaf_node
, * 
buf_∑ge_i
) {

56 
BUF_POOL_MUTEX_ENTER
;

58 
i
 = 0;

59 
off_t
 
roŸ_off£t
 = 
èbÀ
->
dbhódî
.root_offset;

61 i‡(
roŸ_off£t
 == 0) {

62  
Ál£
;

65 
NodePage
* 
∑ge
;

66 
∑ge
 = (
NodePage
*)
	`gë_∑ge
(
èbÀ
, 
	`FILEOFF_TO_PAGENUM
(
roŸ_off£t
), 
buf_∑ge_i
);

68 !
∑ge
->
is_Àaf
) {

69 
I¡î«lPage
* 
öã∫Æ_node
 = (I¡î«lPage*)
∑ge
;

71 
i
 = 0;

72 
i
 < 
öã∫Æ_node
->
num_keys
) {

73 i‡(
key
 >
	`INTERNAL_KEY
(
öã∫Æ_node
, 
i
)) i++;

77 
NodePage
* 
√xtPage
 = (NodePage*)
	`gë_∑ge
(
èbÀ
,

78 
	`FILEOFF_TO_PAGENUM
(
	`INTERNAL_OFFSET
(
öã∫Æ_node
, 
i
)), 
buf_∑ge_i
);

81 i‡(!
√xtPage
) {

82 
	`ªÀa£_∑ge
((
Page
*)
∑ge
);

83 *
buf_∑ge_i
 = 
BUF_PAGE_MUTEX_FAIL
;

84  
Ál£
;

86 i‡(
√xtPage
->
is_Àaf
 =0 &&ÇextPage->
num_keys
 == 0){

87 
	`PANIC
("find_leaf infiniteÜoop!\n");

89 
	`ªÀa£_∑ge
((
Page
*)
∑ge
);

90 
∑ge
 = 
√xtPage
;

94 *
out_Àaf_node
 = (
LófPage
*)
∑ge
;

96  
åue
;

97 
	}
}

102 
öt64_t
* 
	$föd_ªc‹d
(
TabÀ
* 
èbÀ
, 
öt64_t
 
key
) {

103 
i
 = 0;

104 
öt64_t
* 
out_vÆue
;

106 
LófPage
* 
Àaf_node
;

107 i‡(!
	`föd_Àaf
(
èbÀ
, 
key
, &
Àaf_node
)) {

108  
NULL
;

111 
i
 = 0; i < 
Àaf_node
->
num_keys
; i++) {

112 i‡(
	`LEAF_KEY
(
Àaf_node
, 
i
Ë=
key
) {

113 
out_vÆue
 = (
öt64_t
*)
	`mÆloc
(
SIZE_COLUMN
 * (int64_t));

114 
	`mem˝y
(
out_vÆue
, 
	`LEAF_VALUE
(
Àaf_node
, 
i
), 
SIZE_VALUE
);

115 
	`ªÀa£_∑ge
((
Page
*)
Àaf_node
);

116  
out_vÆue
;

120 
	`ªÀa£_∑ge
((
Page
*)
Àaf_node
);

121  
NULL
;

122 
	}
}

129 
öt64_t
* 
	$föd_ªc‹d
(
TabÀ
* 
èbÀ
, 
öt64_t
 
key
, 
åx_t
* 
åx
) {

131 
i
 = 0;

132 
buf_∑ge_i
 = 0;

133 
öt64_t
* 
out_vÆue
;

135 
LófPage
* 
Àaf_node
;

144 
boﬁ
 
gë_∑ge_œtch
;

145 
boﬁ
 
lock_ªq_ªt
;

146 
åue
) {

148 
gë_∑ge_œtch
 = 
	`föd_Àaf
(
èbÀ
, 
key
, &
Àaf_node
, &
buf_∑ge_i
);

150 i‡(!
gë_∑ge_œtch
) {

151 i‡(
buf_∑ge_i
 !
BUF_PAGE_MUTEX_FAIL
)

152  
nuŒ±r
;

154 
lock_ªq_ªt
 = 
lock_sys
.
	`acquúe_lock
(
åx
, 
èbÀ
->
èbÀ_id
, 
poﬁ
.
∑ges
[
buf_∑ge_i
].
∑gíum
, 
key
, 
LOCK_S
, buf_page_i);

155 i‡(!
lock_ªq_ªt
) {

156 i‡(
åx
 -> 
	`gëSèã
(Ë=
ABORTED
) {

157 
	`ªÀa£_∑ge
((
Page
*)
Àaf_node
, &
buf_∑ge_i
);

158  
nuŒ±r
;

160 
	`ªÀa£_∑ge
((
Page
*)
Àaf_node
, &
buf_∑ge_i
);

176 
i
 = 0; i < 
Àaf_node
->
num_keys
; i++) {

177 i‡(
	`LEAF_KEY
(
Àaf_node
, 
i
Ë=
key
) {

178 
out_vÆue
 = (
öt64_t
*)
	`mÆloc
(
SIZE_COLUMN
 * (int64_t));

179 
	`mem˝y
(
out_vÆue
, 
	`LEAF_VALUE
(
Àaf_node
, 
i
), 
SIZE_VALUE
);

180 
	`ªÀa£_∑ge
((
Page
*)
Àaf_node
, &
buf_∑ge_i
);

181  
out_vÆue
;

185 
	`ªÀa£_∑ge
((
Page
*)
Àaf_node
, &
buf_∑ge_i
);

186  
nuŒ±r
;

187 
	}
}

192 
	$cut
–
Àngth
 ) {

193 i‡(
Àngth
 % 2 == 0)

194  
Àngth
/2;

196  
Àngth
/2 + 1;

197 
	}
}

	@src/update.cpp

1 
	~"b±_öã∫Æ.h
"

4 
	$upd©e_ªc‹d
(
TabÀ
* 
èbÀ
, 
öt64_t
 
key
, i¡64_t* 
vÆue
, 
åx_t
* 
åx
) {

5 
i
 = 0;

6 
buf_∑ge_i
 = 0;

7 
LófPage
* 
Àaf_node
;

26 
boﬁ
 
gë_∑ge_œtch
;

27 
boﬁ
 
lock_ªq_ªt
;

29 
åue
) {

31 
gë_∑ge_œtch
 = 
	`föd_Àaf
(
èbÀ
, 
key
, &
Àaf_node
, &
buf_∑ge_i
);

33 i‡(!
gë_∑ge_œtch
) {

34 i‡(
buf_∑ge_i
 !
BUF_PAGE_MUTEX_FAIL
)

37 
lock_ªq_ªt
 = 
lock_sys
.
	`acquúe_lock
(
åx
, 
èbÀ
->
èbÀ_id
, 
poﬁ
.
∑ges
[
buf_∑ge_i
].
∑gíum
, 
key
, 
LOCK_S
, buf_page_i);

38 i‡(!
lock_ªq_ªt
) {

39 i‡(
åx
 -> 
	`gëSèã
(Ë=
ABORTED
) {

40 
	`ªÀa£_∑ge
((
Page
*)
Àaf_node
, &
buf_∑ge_i
);

43 
	`ªÀa£_∑ge
((
Page
*)
Àaf_node
, &
buf_∑ge_i
);

51 
i
 = 0; i < 
Àaf_node
->
num_keys
; i++) {

52 i‡(
	`LEAF_KEY
(
Àaf_node
, 
i
Ë=
key
) {

53 
åx
 -> 
	`push_undo_log
(
key
, 
	`LEAF_VALUE
(
Àaf_node
, 
i
));

55 
	`mem˝y
(
	`LEAF_VALUE
(
Àaf_node
, 
i
), 
vÆue
, 
SIZE_VALUE
);

56 
	`ªÀa£_∑ge
((
Page
*)
Àaf_node
, &
buf_∑ge_i
);

61 
	`ªÀa£_∑ge
((
Page
*)
Àaf_node
, &
buf_∑ge_i
);

63 
	}
}

	@
1
.
0
25
378
include/bpt.h
include/bpt_internal.h
include/buf.h
include/deadlock.h
include/file.h
include/lock.h
include/page.h
include/panic.h
include/table.h
include/trx.h
include/types.h
src/bpt_ext.cpp
src/buf.cpp
src/deadlock.cpp
src/delete.cpp
src/file.cpp
src/global_vars.cpp
src/insert.cpp
src/lock.cpp
src/main.cpp
src/table.cpp
src/test.cpp
src/trx.cpp
src/univ.cpp
src/update.cpp
